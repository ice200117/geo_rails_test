<%= stylesheet_link_tag 'buttons','css/normalize-css/normalize','css/ion.rangeSlider/css/ion.rangeSlider','css/ion.rangeSlider/css/ion.rangeSlider.skinHTML5','css/iCheck/skins/flat/green' %>
<div class="right_col" style="margin-top:0px; margin-bottom:1px; height:0px" role="main">
  <!-- top tiles -->
  <div class="row tile_count" style="margin:1px; padding:0px; height:0px">
    <div class="col-md-2 col-sm-4 col-xs-6 tile_stats_count" style="margin:0px; padding:0px; height:0px">
      <!-- <span class="count_top"><i class="fa fa-user"></i> Total Users</span> -->
      <!-- <span class="count_bottom"><i class="green">4% </i> From last Week</span> -->
    </div>
  </div>
  <!-- /top tiles -->
  <div class="">
    <!--
    <div class="page-title">
      <div class="title_left">
        <h3>方案模拟</h3>
      </div>
    </div>

    <div class="clearfix"></div>
    -->

    <div class="row">
      <div class="col-md-6 col-sm-6 col-xs-12">
        <div class="x_panel">
          <div class="x_title">
            <h2>源追踪和企业统计</h2>
            <!--    <ul class="nav navbar-right panel_toolbox">
              <li><a class="collapse-link"><i class="fa fa-chevron-up"></i></a>
              </li>
              <li class="dropdown">
                <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false"><i class="fa fa-wrench"></i></a>
                <ul class="dropdown-menu" role="menu">
                  <li><a href="#">Settings 1</a>
                  </li>
                  <li><a href="#">Settings 2</a>
                  </li>
                </ul>
              </li>
              <li><a class="close-link"><i class="fa fa-close"></i></a>
              </li>
            </ul> -->
            <div class="clearfix"></div>
          </div>
          <div class="x_content">
            <div class="" role="tabpanel" data-example-id="togglable-tabs">
              <ul id="myTab" class="nav nav-tabs bar_tabs" role="tablist">
                <li role="presentation" class="active"><a href="#tab_content1" id="home-tab" role="tab" data-toggle="tab" aria-expanded="true">网格追踪</a>
                </li>
                <li role="presentation" class="" onclick="setTimeout('myChart.resize();myChart1.resize()', 300)"><a href="#tab_content2" role="tab" id="profile-tab" data-toggle="tab" aria-expanded="false">企业统计</a>
                </li>

              </ul>
              <div id="myTabContent" class="tab-content">
                <div role="tabpanel" class="tab-pane fade active in" id="tab_content1" aria-labelledby="home-tab">
                  <div id="map_title" style="position:absolute;top:50px;left:30%;padding:4px;background:rgba(255,255,255,0.9);z-index:2000;">周边地区排放对我市的污染贡献分布</div>
                  <div id="gridTracking" style="width:100%;height:692px;"></div>
                  <div style="position: absolute; top: 200px; right: 20px;"><%= image_tag("adj_so2_legend.png") %></div>
                </div>
                <div role="tabpanel" class="tab-pane fade" id="tab_content2" aria-labelledby="profile-tab">
                  <div id="proportionOfIndustry" style="width:100%;height:392px;"></div>
                  <div id="enterpriseDistributionStatistics" style="width:100%;height:392px;"></div>
                </div>

              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-md-6 col-sm-6 col-xs-12">
        <div class="x_panel">
          <div class="x_title">
            <div id='aqimn' class="count"> 预计减排后AQI </div>
            <!--    <ul class="nav navbar-right panel_toolbox">
              <li><a class="collapse-link"><i class="fa fa-chevron-up"></i></a>
              </li>
              <li class="dropdown">
                <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false"><i class="fa fa-wrench"></i></a>
                <ul class="dropdown-menu" role="menu">
                  <li><a href="#">Settings 1</a>
                  </li>
                  <li><a href="#">Settings 2</a>
                  </li>
                </ul>
              </li>
              <li><a class="close-link"><i class="fa fa-close"></i></a>
              </li>
            </ul> -->
            <div class="clearfix"></div>
          </div>
          <div class="x_content">
            <div class="" role="tabpanel" data-example-id="togglable-tabs">
              <ul id="myTab1" class="nav nav-tabs bar_tabs" role="tablist">
                <li role="presentation" class="active"><a href="#tab_content11" id="home-tab1" role="tab" data-toggle="tab" aria-expanded="true">模拟拖条</a>
                </li>
                <li role="presentation" class=""><a href="#tab_content21" role="tab" id="profile-tab1" data-toggle="tab" aria-expanded="false">企业勾选</a>
                </li>

              </ul>
              <div id="myTab1Content" class="tab-content">
                <div role="tabpanel" class="tab-pane fade active in" id="tab_content11" aria-labelledby="home-tab1">
             <table id="enterpriseList" class="table table-striped table-bordered" style="white-space: nowrap">
              <thead>
                <tr>
                  <th>序号</th>
                  <th>企业名称</th>
                  <th>NOX排放量占比</th>
                </tr>
              </thead>
              <tbody>

              </tbody>
            </table>
            <button onclick="tableToExcel(&#39;enterpriseList&#39;, &#39;export table&#39;)" class="button-buttons button-glow button-rounded button-primary">
              <img src="<%= image_url 'img/ico.png'%>">
              导出
            </button>
            <div class="ln_solid"></div>
            <div class="row">
              <div class="col-md-6 col-xs-12">
                <label>预警级别:</label>
                <div class="btn-group">
                  <button class="btn btn-info" type="button">I</button>
                  <button class="btn btn-info active" type="button">II</button>
                  <button class="btn btn-info" type="button">III</button>
                  <button class="btn btn-info" type="button">IV</button>
                </div>
              </div>
              <div class="col-md-6 col-xs-12">
                <label>行业选择:</label>
                <div class="btn-group">
                  <button class="btn btn-round btn-success" type="button">电力</button>
                  <button class="btn btn-round btn-success active" type="button">冶金</button>
                  <button class="btn btn-round btn-success" type="button">化工</button>
                  <button class="btn btn-round btn-success" type="button">石油</button>
                </div>
              </div>
            </div>
            <br>
            <div class="row">
              <label>减排百分比:</label>
              <input type="text" value="" id="range" name="range" />
            </div>
                </div>
                <div role="tabpanel" class="tab-pane fade" id="tab_content21" aria-labelledby="profile-tab1">
                  <table id="datatable-checkbox" class="table table-striped table-bordered bulk_action">
                      <thead>
                        <tr>
                          <th><input type="checkbox" id="check-all" class="flat"></th>
                          <th>序号</th>
                          <th>企业名称</th>
                          <th>NOX排放量占比</th>
                        </tr>
                      </thead>


                      <tbody>
                        <tr>
                          <td><input type="checkbox" class="flat" name="table_records"></td>
                          <td>Tiger Nixon</td>
                          <td>System Architect</td>
                          <td>Edinburgh</td>
                        </tr>
                        
                      </tbody>
                    </table>
                    <button onclick="" class="button-buttons button-glow button-rounded button-primary">查询</button>
                </div>

              </div>
            </div>

          </div>
        </div>
      </div>
    </div>
  </div>
  </div>
  <%= javascript_include_tag 'js/ion.rangeSlider/js/ion.rangeSlider.min','js/iCheck/icheck.min' %>       
  <!-- 网格追踪 -->
  <script type="text/javascript">
    var center = new BMap.Point(<%= @longitude %>,<%= @latitude %>);
// var marker = new BMap.Marker(center);// 创建标注
// 创建Map实例
var map = new BMap.Map("gridTracking",{minZoom:8});
map.centerAndZoom(center,8);
map.disableDoubleClickZoom(true);
map.enableScrollWheelZoom();
var mapStyle = [{
  "featureType":"road","elementType":"all","stylers":{
    "lightness":20
  }
},{
  "featureType":"highway","elementType":"all","stylers":{
    "visibility":"on"
  }
},{
  "featureType":"railway","elementType":"all","stylers":{
    "visibility":"on"
  }
},{
  "featureType":"local","elementType":"labels","stylers":{
    "visibility":"on"
  }
},{
  "featureType":"water","elementType":"all","stylers":{
    "color":"#d1e5ff"
  }
},{
  "featureType":"poi","elementType":"labels","stylers":{
    "visibility":"on"
  }
}];
map.setMapStyle({styleJson:mapStyle});
//网格线
function gridLines(xmin,ymin,xmax,ymax)
{
  var lineOption = {strokeColor:"black",strokeWeight:0.3,strokeOpacity:0.7,enableMassClear:false,enableClicking:false};
  for(var i = 0; i < 70; i++){
    map.addOverlay(new BMap.Polyline([new BMap.Point(xmin,(ymin + 0.1 * i)),new BMap.Point(xmax,(ymin + 0.1 * i))],lineOption));
  }
  for(var i = 0; i < 120; i++){
    map.addOverlay(new BMap.Polyline([new BMap.Point((xmin + 0.1 * i),ymin),new BMap.Point((xmin + 0.1 * i),ymax)],lineOption));
  } 
}
//网格数据
function gridData(xmin,ymin,data)
{
  var rectangleOption = {strokeColor:"black",strokeWeight:0.3,strokeOpacity:0,fillColor:"red",fillOpacity:0.7};
  for(var i=0;i<70;i++){
    for(var j=0;j<120;j++){
      if(data[i][j]>0.05){
        var rectangle = new BMap.Polygon([new BMap.Point(xmin+(0.1*j),ymin+(0.1*i)),new BMap.Point(xmin+0.1+(0.1*j),ymin+(0.1*i)),new BMap.Point(xmin+0.1+(0.1*j),ymin+0.1+(0.1*i)),new BMap.Point(xmin+(0.1*j),ymin+0.1+(0.1*i))
        ],$.extend({},rectangleOption,{fillColor:getColor(data[i][j])}));
        rectangle.addEventListener("click",click);
        map.addOverlay(rectangle);
      }
    }
  }
}
function initGridLinesAndGridData(type,citypy){
  $.get('/querys/adj',{var:type,citypy:citypy},function(rdata){
    var data = rdata[type];
    var xmin = rdata['xmin'];
    var ymin = rdata['ymin'];
    var xmax = rdata['xmax'];
    var ymax = rdata['ymax'];
    gridLines(xmin,ymin,xmax,ymax);
    gridData(xmin,ymin,data);
  },'json');
}
function changeGridData(xmin,ymin,data){
  map.clearOverlays();
  gridData(xmin,ymin,data);
}
initGridLinesAndGridData('<%= @factor %>','<%= @citynamepy %>');
function click(e){
  var p = e.target;
  var xmin = p.getBounds().getSouthWest().lng;//西南
  var ymin = p.getBounds().getSouthWest().lat;//西南
  var xmax = xmin+0.1;
  var ymax = ymin+0.1;
  var gridPoint=[];
  gridPoint.push({
    xmin: xmin,
    ymin: ymin,
    xmax: xmax,
    ymax: ymax
  });
  gridPoint=JSON.stringify(gridPoint)
  loadEnterpriseData(gridPoint);
}

function getColor(val){
  if(val <= 0.1)
    return "#79E6F0";
  else if(val <= 0.2)
    return "#C8DC33";
  else if(val <= 0.4)
    return "#F0DC16";
  else if(val <= 0.6)
    return "#FFBE16";
  else if(val <= 0.8)
    return "#FF790C";
  else if(val <= 1.0)
    return "#FF5B0C";
  else if(val <= 2.0)
    return "#F02A02";
  else if(val <= 4.0)
    return "#B40C02";
  else if(val <= 8.0)
    return "#790C02";
  else
    return "#330C02";
}
</script>    
<!-- 清单统计 -->
<script type="text/javascript">
  var dom = document.getElementById("proportionOfIndustry");
var myChart = echarts.init(dom);
var app = {};
option = null;
option = {
  title : {
    text: '企业统计',
    subtext: '行业分布',
    x:'center'
  },
  tooltip : {
    trigger: 'item',
    formatter: "{a} <br/>{b} : {c} ({d}%)"
  },
  legend: {
    orient: 'vertical',
    left: 'left',
    data: ['防水建筑材料制造','隔热和隔音材料制造','其他建筑材料制造','平板玻璃制造','其他玻璃制造']
  },
  series: [
    {
      name: '行业类别',
      type: 'pie',
      radius : '55%',
      center: ['50%', '60%'],
      data:[
        {value:335, name:'防水建筑材料制造'},
        {value:310, name:'隔热和隔音材料制造'},
        {value:234, name:'其他建筑材料制造'},
        {value:135, name:'平板玻璃制造'},
        {value:1548, name:'其他玻璃制造'}
      ],
      itemStyle: {
        emphasis: {
          shadowBlur: 10,
          shadowOffsetX: 0,
          shadowColor: 'rgba(0, 0, 0, 0.5)'
        }
      }
    }
  ]
};
if (option && typeof option === "object") {
  myChart.setOption(option, true);
  <%# window.onresize = myChart.resize; %>
}
</script>
<!-- 区域内企业分布统计 -->
<script>
  var dom1 = document.getElementById("enterpriseDistributionStatistics");
var myChart1 = echarts.init(dom1);
var app1 = {};
option1 = null;
app1.title = '区域内企业分布统计 - 条形图';

option1 = {
  title: {
    text: '区域内企业分布统计'
  },
  tooltip: {
    trigger: 'axis',
    axisPointer: {
      type: 'shadow'
    }
  },
  legend: {
    data: ['企业数量']
  },
  grid: {
    left: '3%',
    right: '4%',
    bottom: '3%',
    containLabel: true
  },
  xAxis: {
    type: 'value',
    boundaryGap: [0, 0.01]
  },
  yAxis: {
    type: 'category',
    data: ['郑东新区','金水区','管城区','惠济区','中原区','高新区','二七区','经开区']
  },
  series: [
    {
      name: '企业数量',
      type: 'bar',
      data: [18203, 23489, 29034, 104970, 131744, 630230,19325, 23438]
    }
  ]
};
;
if (option1 && typeof option1 === "object") {
  myChart1.setOption(option1, true);
  window.onresize = function(){
    myChart.resize();
    myChart1.resize();
  };
}
</script>

<!-- tableToExcel -->
<script>
  var tableToExcel = function() {
    var uri = 'data:application/vnd.ms-excel;base64,'
      , template = '<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head><meta http-equiv="X-UA-Compatible" content="IE=11"/><meta charset="UTF-8"><!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet><x:Name>{worksheet}</x:Name><x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions></x:ExcelWorksheet></x:ExcelWorksheets></x:ExcelWorkbook></xml><![endif]--></head><body><table>{table}</table></body></html>'
      , base64 = function(s) { return window.btoa(unescape(encodeURIComponent(s))) }
      , format = function(s, c) { return s.replace(/{(\w+)}/g, function(m, p) { return c[p]; }) }
    return function(table, name) {
      if (!table.nodeType) table = document.getElementById(table)
      var ctx = {worksheet: name || 'Worksheet', table: table.innerHTML}
      window.location.href = uri + base64(format(template, ctx))
    }
  }();
</script>
<!-- 初始化表格 -->
<script type="text/javascript">

  var handleDataTableButtons = function() {
    enterpriseList=$("#enterpriseList").DataTable({
      language: {
        "sProcessing": "处理中...",
        "sLengthMenu": "显示 _MENU_ 行",
        "sZeroRecords": "没有匹配结果",
        "sInfo": "显示第 _START_ 至 _END_ 项，共 _TOTAL_ 项",
        "sInfoEmpty": "显示第 0 至 0 项结果，共 0 项",
        "sInfoFiltered": "(由 _MAX_ 项结果过滤)",
        "sInfoPostFix": "",
        "sSearch": "搜索:",
        "sUrl": "",
        "sEmptyTable": "表中数据为空",
        "sLoadingRecords": "载入中...",
        "sInfoThousands": ",",
        "oPaginate": {
          "sFirst": "首页",
          "sPrevious": "上页",
          "sNext": "下页",
          "sLast": "末页"
        },
        "oAria": {
          "sSortAscending": ": 以升序排列此列",
          "sSortDescending": ": 以降序排列此列"
        },
      },
      "dom": '<lf<t>ip>',
      lengthMenu: [
        [ 10, 25, 50, -1 ],
        [ '10', '25', '50', '所有']
      ],   
      buttons: ['pageLength','excel'],
      // "aoColumnDefs": [ { "bSortable": false, "aTargets": [ 0 ] }],            
      //"aaSorting": [[ 0, "asc" ]],
      "paging": true
      //responsive: true,
      //"scrollX": true,
      //  ajax: {
      //     url:'/export/replace_coals_export.json?year='+$('#year').val()+'&month='+$('#month').val()+'&countyid='+$('#countyMonth').val(),
      // type:'GET',
      // dataType:"json"
      //  } 
    });
  }
var TableManageButtons = function() {
  "use strict";
  return {
    init: function() {
      handleDataTableButtons();
    }
  };
}();
var loadEnterpriseData=function(gridPoint) {
  var dataurl='/palm_two/scheme_simulation.json?gridPoint='+gridPoint;
  enterpriseList.ajax.url(dataurl).load(function ( r_data ) {
  });
}
$(document).ready(function() {
  TableManageButtons.init();
  loadEnterpriseData("");

});
</script>
<!-- Slider -->
<script type="text/javascript">
  $(document).ready(function() {
    $("#range").ionRangeSlider({
      min: 0,
      max: 100,
      from: 0,
      onStart: function (data) {
      },
      onChange: function (data) {
      },
      onFinish: function (data_in) {
        $.ajax({            
          url: '/palm_two/get_all_data',
          data:{
            'factor':'<%= @factor %>',
            'citynamepy':'<%= @citynamepy %>',
            'percent':data_in.from/100},
          type: "get",
          dataType : "json",            
          success: function (data) { 
            changeGridData(data.xmin,data.ymin,data.map);
            loadEnterpriseData(JSON.stringify(data.grid));
            $("#aqimn").empty();
            $('#aqimn').append("预计减排后AQI为: <strong>"+Math.round(data.aqi) +"</strong>");
            if(data_in.from==0){
              $("#map_title").empty();
              $('#map_title').append("周边地区排放对我市的污染贡献分布");
            }else{
              $("#map_title").empty();
              $('#map_title').append("需管控的网格分布");
            }
          }
        });       
      },
      onUpdate: function (data) {
      }
    });
  });

</script>
