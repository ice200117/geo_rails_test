<!DOCTYPE html>

<html>
<head>
<meta charset="UTF-8">

<title>module Common - RDoc Documentation</title>

<script type="text/javascript">
  var rdoc_rel_prefix = "./";
</script>

<script src="./js/jquery.js"></script>
<script src="./js/darkfish.js"></script>

<link href="./css/fonts.css" rel="stylesheet">
<link href="./css/rdoc.css" rel="stylesheet">



<body id="top" role="document" class="module">
<nav role="navigation">
  <div id="project-navigation">
    <div id="home-section" role="region" title="Quick navigation" class="nav-section">
  <h2>
    <a href="./index.html" rel="home">Home</a>
  </h2>

  <div id="table-of-contents-navigation">
    <a href="./table_of_contents.html#pages">Pages</a>
    <a href="./table_of_contents.html#classes">Classes</a>
    <a href="./table_of_contents.html#methods">Methods</a>
  </div>
</div>

    <div id="search-section" role="search" class="project-section initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <div id="search-field-wrapper">
      <input id="search-field" role="combobox" aria-label="Search"
             aria-autocomplete="list" aria-controls="search-results"
             type="text" name="search" placeholder="Search" spellcheck="false"
             title="Type to search, Up and Down to navigate, Enter to load">
    </div>

    <ul id="search-results" aria-label="Search Results"
        aria-busy="false" aria-expanded="false"
        aria-atomic="false" class="initially-hidden"></ul>
  </form>
</div>

  </div>

  

  <div id="class-metadata">
    
    
    
    
    <!-- Method Quickref -->
<div id="method-list-section" class="nav-section">
  <h3>Methods</h3>

  <ul class="link-list" role="directory">
    
    <li ><a href="#method-i-avg">#avg</a>
    
    <li ><a href="#method-i-column_name_modify">#column_name_modify</a>
    
    <li ><a href="#method-i-common_get_month_year">#common_get_month_year</a>
    
    <li ><a href="#method-i-end">#end</a>
    
    <li ><a href="#method-i-get">#get</a>
    
    <li ><a href="#method-i-get_avg">#get_avg</a>
    
    <li ><a href="#method-i-get_change_rate">#get_change_rate</a>
    
    <li ><a href="#method-i-get_rank_json">#get_rank_json</a>
    
    <li ><a href="#method-i-get_zonghezhishu">#get_zonghezhishu</a>
    
    <li ><a href="#method-i-json">#json</a>
    
    <li ><a href="#method-i-out_log">#out_log</a>
    
    <li ><a href="#method-i-percentile">#percentile</a>
    
    <li ><a href="#method-i-post">#post</a>
    
    <li ><a href="#method-i-save_db">#save_db</a>
    
    <li ><a href="#method-i-save_db_common">#save_db_common</a>
    
    <li ><a href="#method-i-set_change_rate_to_db">#set_change_rate_to_db</a>
    
    <li ><a href="#method-i-ten_times_test">#ten_times_test</a>
    
  </ul>
</div>

  </div>
</nav>

<main role="main" aria-labelledby="module-Common">
  <h1 id="module-Common" class="module">
    module Common
  </h1>

  <section class="description">
    
  </section>

  
  
  
  <section id="5Buntitled-5D" class="documentation-section">
    

    

    
    <section class="constants-list">
      <header>
        <h3>Constants</h3>
      </header>
      <dl>
      
        <dt id="AQI">AQI
        
        <dd>
        
      
        <dt id="CO">CO
        
        <dd>
        
      
        <dt id="CO_change_rate">CO_change_rate
        
        <dd>
        
      
        <dt id="NO2">NO2
        
        <dd>
        
      
        <dt id="NO2_change_rate">NO2_change_rate
        
        <dd>
        
      
        <dt id="O3">O3
        
        <dd>
        
      
        <dt id="O3_change_rate">O3_change_rate
        
        <dd>
        
      
        <dt id="SO2">SO2
        
        <dd>
        
      
        <dt id="SO2_change_rate">SO2_change_rate
        
        <dd>
        
      
      </dl>
    </section>
    

    

    
     <section id="public-instance-5Buntitled-5D-method-details" class="method-section">
       <header>
         <h3>Public Instance Methods</h3>
       </header>

    
      <div id="method-i-avg" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">avg</span><span
            class="method-args">(array)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>计算平均值</p>
          
          

          
          <div class="method-source-code" id="avg-source">
            <pre><span class="ruby-comment"># File vendor/getdata/common.rb, line 149</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">avg</span>(<span class="ruby-identifier">array</span>)
        <span class="ruby-identifier">sum</span> = <span class="ruby-value">0</span>
        <span class="ruby-identifier">array</span>.<span class="ruby-identifier">each</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">x</span><span class="ruby-operator">|</span> <span class="ruby-identifier">sum</span><span class="ruby-operator">+=</span><span class="ruby-identifier">x</span>}
        <span class="ruby-identifier">sum</span><span class="ruby-operator">/</span><span class="ruby-identifier">array</span>.<span class="ruby-identifier">length</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">array</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">!=</span> <span class="ruby-value">0</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-column_name_modify" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">column_name_modify</span><span
            class="method-args">(hs)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>接口中不符合统一字段名，进行处理后再使用</p>
          
          

          
          <div class="method-source-code" id="column_name_modify-source">
            <pre><span class="ruby-comment"># File vendor/getdata/common.rb, line 36</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">column_name_modify</span>(<span class="ruby-identifier">hs</span>)
        <span class="ruby-keyword">for</span> <span class="ruby-identifier">i</span> <span class="ruby-keyword">in</span> (<span class="ruby-value">0</span><span class="ruby-operator">...</span><span class="ruby-identifier">hs</span>.<span class="ruby-identifier">length</span>)
                <span class="ruby-identifier">hs</span>[<span class="ruby-identifier">i</span>][<span class="ruby-string">&#39;city&#39;</span>]=<span class="ruby-identifier">hs</span>[<span class="ruby-identifier">i</span>][<span class="ruby-string">&#39;city_name&#39;</span>] <span class="ruby-keyword">if</span> <span class="ruby-identifier">hs</span>[<span class="ruby-identifier">i</span>][<span class="ruby-string">&#39;city_name&#39;</span>]<span class="ruby-operator">!=</span><span class="ruby-keyword">nil</span>
                <span class="ruby-identifier">hs</span>[<span class="ruby-identifier">i</span>][<span class="ruby-string">&#39;so2&#39;</span>]=<span class="ruby-identifier">hs</span>[<span class="ruby-identifier">i</span>][<span class="ruby-string">&#39;so2nd&#39;</span>] <span class="ruby-keyword">if</span> <span class="ruby-identifier">hs</span>[<span class="ruby-identifier">i</span>][<span class="ruby-string">&#39;so2nd&#39;</span>]<span class="ruby-operator">!=</span><span class="ruby-keyword">nil</span>
                <span class="ruby-identifier">hs</span>[<span class="ruby-identifier">i</span>][<span class="ruby-string">&#39;no2&#39;</span>]=<span class="ruby-identifier">hs</span>[<span class="ruby-identifier">i</span>][<span class="ruby-string">&#39;no2nd&#39;</span>] <span class="ruby-keyword">if</span> <span class="ruby-identifier">hs</span>[<span class="ruby-identifier">i</span>][<span class="ruby-string">&#39;no2nd&#39;</span>]<span class="ruby-operator">!=</span><span class="ruby-keyword">nil</span>
                <span class="ruby-identifier">hs</span>[<span class="ruby-identifier">i</span>][<span class="ruby-string">&#39;co&#39;</span>]=<span class="ruby-identifier">hs</span>[<span class="ruby-identifier">i</span>][<span class="ruby-string">&#39;cond&#39;</span>] <span class="ruby-keyword">if</span> <span class="ruby-identifier">hs</span>[<span class="ruby-identifier">i</span>][<span class="ruby-string">&#39;cond&#39;</span>]<span class="ruby-operator">!=</span><span class="ruby-keyword">nil</span>
                <span class="ruby-identifier">hs</span>[<span class="ruby-identifier">i</span>][<span class="ruby-string">&#39;o3&#39;</span>]=<span class="ruby-identifier">hs</span>[<span class="ruby-identifier">i</span>][<span class="ruby-string">&#39;o3_8hnd&#39;</span>] <span class="ruby-keyword">if</span> <span class="ruby-identifier">hs</span>[<span class="ruby-identifier">i</span>][<span class="ruby-string">&#39;o3_8hnd&#39;</span>]<span class="ruby-operator">!=</span><span class="ruby-keyword">nil</span>
                <span class="ruby-identifier">hs</span>[<span class="ruby-identifier">i</span>][<span class="ruby-string">&#39;o3&#39;</span>]=<span class="ruby-identifier">hs</span>[<span class="ruby-identifier">i</span>][<span class="ruby-string">&#39;o3_8h&#39;</span>] <span class="ruby-keyword">if</span> <span class="ruby-identifier">hs</span>[<span class="ruby-identifier">i</span>][<span class="ruby-string">&#39;o3_8h&#39;</span>] <span class="ruby-operator">!=</span> <span class="ruby-keyword">nil</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">hs</span>[<span class="ruby-identifier">i</span>][<span class="ruby-string">&#39;o3&#39;</span>] <span class="ruby-operator">==</span> <span class="ruby-value">0</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">hs</span>[<span class="ruby-identifier">i</span>][<span class="ruby-string">&#39;o3_8h&#39;</span>] <span class="ruby-operator">!=</span> <span class="ruby-value">0</span>
                <span class="ruby-identifier">hs</span>[<span class="ruby-identifier">i</span>][<span class="ruby-string">&#39;pm2_5&#39;</span>]=<span class="ruby-identifier">hs</span>[<span class="ruby-identifier">i</span>][<span class="ruby-string">&#39;pm25nd&#39;</span>] <span class="ruby-keyword">if</span> <span class="ruby-identifier">hs</span>[<span class="ruby-identifier">i</span>][<span class="ruby-string">&#39;pm25nd&#39;</span>] <span class="ruby-operator">!=</span> <span class="ruby-keyword">nil</span>
                <span class="ruby-identifier">hs</span>[<span class="ruby-identifier">i</span>][<span class="ruby-string">&#39;pm10&#39;</span>] = <span class="ruby-identifier">hs</span>[<span class="ruby-identifier">i</span>][<span class="ruby-string">&#39;pm10nd&#39;</span>] <span class="ruby-keyword">if</span> <span class="ruby-identifier">hs</span>[<span class="ruby-identifier">i</span>][<span class="ruby-string">&#39;pm10nd&#39;</span>] <span class="ruby-operator">!=</span> <span class="ruby-keyword">nil</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-identifier">hs</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-common_get_month_year" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">common_get_month_year</span><span
            class="method-args">(city_list,model,time)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>通用方法</p>
          
          

          
          <div class="method-source-code" id="common_get_month_year-source">
            <pre><span class="ruby-comment"># File vendor/getdata/common.rb, line 292</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">common_get_month_year</span>(<span class="ruby-identifier">city_list</span>,<span class="ruby-identifier">model</span>,<span class="ruby-identifier">time</span>)
        <span class="ruby-constant">CityEnum</span>.<span class="ruby-identifier">send</span>(<span class="ruby-identifier">city_list</span>).<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">name</span><span class="ruby-operator">|</span>
                <span class="ruby-identifier">city</span> = <span class="ruby-constant">City</span>.<span class="ruby-identifier">find_by_city_name</span>(<span class="ruby-identifier">name</span>)
                <span class="ruby-identifier">city</span> = <span class="ruby-constant">City</span>.<span class="ruby-identifier">find_by_city_name</span>(<span class="ruby-identifier">name</span>.<span class="ruby-identifier">to_s</span><span class="ruby-operator">+</span><span class="ruby-string">&#39;市&#39;</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">city</span>.<span class="ruby-identifier">nil?</span>
                <span class="ruby-identifier">tmp</span> = <span class="ruby-identifier">get_avg</span>(<span class="ruby-identifier">model</span>,<span class="ruby-identifier">city</span>.<span class="ruby-identifier">id</span>,<span class="ruby-identifier">time</span>)
                <span class="ruby-identifier">tmp</span>[<span class="ruby-string">&#39;city&#39;</span>] = <span class="ruby-identifier">name</span>
                <span class="ruby-identifier">save_db_common</span>(<span class="ruby-identifier">model</span>,<span class="ruby-identifier">tmp</span>,<span class="ruby-identifier">time</span>)
        <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-end" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">end</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="end-source">
            <pre><span class="ruby-comment"># File vendor/getdata/common.rb, line 24</span>
        <span class="ruby-keyword">def</span> 
<span class="ruby-keyword">end</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">get_rank_json</span>(<span class="ruby-identifier">web_flag</span>,<span class="ruby-identifier">secretstr</span>,<span class="ruby-identifier">typestr</span>,<span class="ruby-identifier">datestr</span>)
        <span class="ruby-identifier">json_data</span>[<span class="ruby-string">&#39;date&#39;</span>] <span class="ruby-operator">!=</span> <span class="ruby-keyword">nil</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">hs</span>[<span class="ruby-value">:time</span>] = <span class="ruby-identifier">json_data</span>[<span class="ruby-string">&#39;date&#39;</span>] <span class="ruby-operator">:</span> <span class="ruby-identifier">hs</span>[<span class="ruby-value">:time</span>] = <span class="ruby-identifier">json_data</span>[<span class="ruby-string">&#39;time&#39;</span>]
        <span class="ruby-identifier">hs</span>[<span class="ruby-value">:cities</span>] = <span class="ruby-identifier">column_name_modify</span>(<span class="ruby-identifier">json_data</span>[<span class="ruby-string">&#39;rows&#39;</span>])
        <span class="ruby-identifier">hs</span>[<span class="ruby-value">:total</span>]=<span class="ruby-identifier">json_data</span>[<span class="ruby-string">&#39;total&#39;</span>]
<span class="ruby-keyword">rescue</span>
        <span class="ruby-identifier">hs</span>=<span class="ruby-keyword">false</span>
<span class="ruby-keyword">end</span> 
<span class="ruby-identifier">hs</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-get" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">get</span><span
            class="method-args">(url)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>通过get方式请求数据</p>
          
          

          
          <div class="method-source-code" id="get-source">
            <pre><span class="ruby-comment"># File vendor/getdata/common.rb, line 6</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">get</span>(<span class="ruby-identifier">url</span>)
        <span class="ruby-ivar">@response</span> = <span class="ruby-constant">HTTParty</span>.<span class="ruby-identifier">get</span>(<span class="ruby-identifier">url</span>)
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-get_avg" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">get_avg</span><span
            class="method-args">(model,id,time)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>获取月年平均数</p>
          
          

          
          <div class="method-source-code" id="get_avg-source">
            <pre><span class="ruby-comment"># File vendor/getdata/common.rb, line 63</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">get_avg</span>(<span class="ruby-identifier">model</span>,<span class="ruby-identifier">id</span>,<span class="ruby-identifier">time</span>)
        <span class="ruby-identifier">second_in_day</span>=<span class="ruby-value">60</span><span class="ruby-operator">*</span><span class="ruby-value">60</span><span class="ruby-operator">*</span><span class="ruby-value">24</span>

        <span class="ruby-comment">#判断年还是月，设置日model</span>
        <span class="ruby-identifier">name</span>=<span class="ruby-regexp">/Temp(\w*)(Month|Year)/</span>.<span class="ruby-identifier">match</span>(<span class="ruby-identifier">model</span>.<span class="ruby-identifier">name</span>)
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">name</span>[<span class="ruby-value">2</span>] <span class="ruby-operator">==</span> <span class="ruby-string">&#39;Month&#39;</span>
                <span class="ruby-identifier">first_day</span>=<span class="ruby-identifier">time</span>.<span class="ruby-identifier">to_time</span>.<span class="ruby-identifier">beginning_of_month</span>
        <span class="ruby-keyword">else</span>
                <span class="ruby-identifier">first_day</span> = <span class="ruby-identifier">time</span>.<span class="ruby-identifier">to_time</span>.<span class="ruby-identifier">beginning_of_year</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-identifier">this_day</span> = <span class="ruby-identifier">time</span>.<span class="ruby-identifier">to_time</span>.<span class="ruby-identifier">end_of_day</span>

        <span class="ruby-identifier">days_model_name</span> = <span class="ruby-node">&quot;Temp#{name[1]}Day&quot;</span>.<span class="ruby-identifier">constantize</span>

        <span class="ruby-comment">#指标数组，暂存数据进行处理</span>
        <span class="ruby-identifier">so2_array</span>=<span class="ruby-constant">Array</span>.<span class="ruby-identifier">new</span>
        <span class="ruby-identifier">no2_array</span>=<span class="ruby-constant">Array</span>.<span class="ruby-identifier">new</span>
        <span class="ruby-identifier">pm10_array</span>=<span class="ruby-constant">Array</span>.<span class="ruby-identifier">new</span>
        <span class="ruby-identifier">pm25_array</span>=<span class="ruby-constant">Array</span>.<span class="ruby-identifier">new</span>
        <span class="ruby-identifier">co_array</span>=<span class="ruby-constant">Array</span>.<span class="ruby-identifier">new</span>
        <span class="ruby-identifier">o3_array</span>=<span class="ruby-constant">Array</span>.<span class="ruby-identifier">new</span>

        <span class="ruby-comment">#获取数据begin</span>
        <span class="ruby-identifier">sql_str</span> = <span class="ruby-constant">Array</span>.<span class="ruby-identifier">new</span>
        <span class="ruby-identifier">sql_str</span><span class="ruby-operator">&lt;&lt;</span><span class="ruby-string">&quot;data_real_time &gt;=? AND data_real_time &lt;=? AND city_id=?&quot;</span>
        <span class="ruby-identifier">sql_str</span><span class="ruby-operator">&lt;&lt;</span><span class="ruby-identifier">first_day</span>
        <span class="ruby-identifier">sql_str</span><span class="ruby-operator">&lt;&lt;</span><span class="ruby-identifier">this_day</span>
        <span class="ruby-identifier">sql_str</span><span class="ruby-operator">&lt;&lt;</span><span class="ruby-identifier">id</span>
        <span class="ruby-identifier">data_hs</span> = <span class="ruby-identifier">days_model_name</span>.<span class="ruby-identifier">where</span>(<span class="ruby-identifier">sql_str</span>).<span class="ruby-identifier">group_by</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:data_real_time</span>)
        <span class="ruby-identifier">data_hs</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">k</span>,<span class="ruby-identifier">v</span><span class="ruby-operator">|</span>
                <span class="ruby-identifier">day_city</span> = <span class="ruby-identifier">v</span>[<span class="ruby-value">0</span>]
                <span class="ruby-identifier">so2_array</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">day_city</span>.<span class="ruby-constant">SO2</span> <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">day_city</span>.<span class="ruby-constant">SO2</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">day_city</span>.<span class="ruby-constant">SO2!</span>=<span class="ruby-value">0</span>
                <span class="ruby-identifier">no2_array</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">day_city</span>.<span class="ruby-constant">NO2</span> <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">day_city</span>.<span class="ruby-constant">NO2</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">day_city</span>.<span class="ruby-constant">NO2!</span>=<span class="ruby-value">0</span>
                <span class="ruby-identifier">pm10_array</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">day_city</span>.<span class="ruby-identifier">pm10</span> <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">day_city</span>.<span class="ruby-identifier">pm10</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">day_city</span>.<span class="ruby-identifier">pm10!</span>=<span class="ruby-value">0</span>
                <span class="ruby-identifier">pm25_array</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">day_city</span>.<span class="ruby-identifier">pm25</span> <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">day_city</span>.<span class="ruby-identifier">pm25</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">day_city</span>.<span class="ruby-identifier">pm25!</span>=<span class="ruby-value">0</span>
                <span class="ruby-identifier">co_array</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">day_city</span>.<span class="ruby-constant">CO</span> <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">day_city</span>.<span class="ruby-constant">CO</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">day_city</span>.<span class="ruby-constant">CO</span> <span class="ruby-operator">!=</span> <span class="ruby-value">0</span>
                <span class="ruby-identifier">o3_array</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">day_city</span>.<span class="ruby-constant">O3</span> <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">day_city</span>.<span class="ruby-constant">O3</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">day_city</span>.<span class="ruby-constant">O3</span> <span class="ruby-operator">!=</span> <span class="ruby-value">0</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-comment">#end</span>
<span class="ruby-comment">        while first_day&lt;=this_day do
                temp_day=first_day+second_in_day
                sql_str=Array.new
                sql_str&lt;&lt;&quot;data_real_time &gt;=? AND data_real_time &lt;=? AND city_id=?&quot;
                sql_str&lt;&lt;first_day
                sql_str&lt;&lt;temp_day
                sql_str&lt;&lt;id
                daycity=days_model_name.where(sql_str)        
                if daycity.length&gt;0
                        day_city=daycity[0]
                        if !day_city.SO2.nil? &amp;&amp; day_city.SO2!=0
                                so2_array&lt;&lt;day_city.SO2
                        end
                        if !day_city.NO2.nil? &amp;&amp; day_city.NO2!=0
                                no2_array&lt;&lt;day_city.NO2
                        end
                        if !day_city.pm10.nil? &amp;&amp; day_city.pm10!=0
                                pm10_array&lt;&lt;day_city.pm10
                        end
                        if !day_city.pm25.nil? &amp;&amp; day_city.pm25!=0
                                pm25_array&lt;&lt;day_city.pm25
                        end
                        if !day_city.CO.nil? &amp;&amp; day_city.CO!=0
                                co_array&lt;&lt;day_city.CO
                        end
                        if !day_city.O3.nil? &amp;&amp; day_city!=0
                                o3_array&lt;&lt;day_city.O3
                        end
                end
                first_day=temp_day
        end
</span>        <span class="ruby-identifier">avg_co</span>=<span class="ruby-identifier">percentile</span>(<span class="ruby-identifier">co_array</span>,<span class="ruby-value">0.95</span>).<span class="ruby-identifier">to_f</span>
        <span class="ruby-identifier">avg_o3</span>=<span class="ruby-identifier">percentile</span>(<span class="ruby-identifier">o3_array</span>,<span class="ruby-value">0.9</span>).<span class="ruby-identifier">to_f</span>

        <span class="ruby-identifier">hs</span>=<span class="ruby-constant">Hash</span>.<span class="ruby-identifier">new</span>
        <span class="ruby-identifier">hs</span>[<span class="ruby-string">&#39;so2&#39;</span>]=<span class="ruby-identifier">avg</span>(<span class="ruby-identifier">so2_array</span>)
        <span class="ruby-identifier">hs</span>[<span class="ruby-string">&#39;no2&#39;</span>]=<span class="ruby-identifier">avg</span>(<span class="ruby-identifier">no2_array</span>)
        <span class="ruby-identifier">hs</span>[<span class="ruby-string">&#39;pm10&#39;</span>]=<span class="ruby-identifier">avg</span>(<span class="ruby-identifier">pm10_array</span>)
        <span class="ruby-identifier">hs</span>[<span class="ruby-string">&#39;pm2_5&#39;</span>]=<span class="ruby-identifier">avg</span>(<span class="ruby-identifier">pm25_array</span>)
        <span class="ruby-identifier">hs</span>[<span class="ruby-string">&#39;co&#39;</span>]=<span class="ruby-identifier">avg_co</span>
        <span class="ruby-identifier">hs</span>[<span class="ruby-string">&#39;o3&#39;</span>]=<span class="ruby-identifier">avg_o3</span>
        <span class="ruby-identifier">hs</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-get_change_rate" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">get_change_rate</span><span
            class="method-args">(model,id,time)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>计算同期对比</p>
          
          

          
          <div class="method-source-code" id="get_change_rate-source">
            <pre><span class="ruby-comment"># File vendor/getdata/common.rb, line 163</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">get_change_rate</span>(<span class="ruby-identifier">model</span>,<span class="ruby-identifier">id</span>,<span class="ruby-identifier">time</span>)
        <span class="ruby-identifier">sql_str</span>=<span class="ruby-constant">Array</span>.<span class="ruby-identifier">new</span>
        <span class="ruby-identifier">sql_str</span><span class="ruby-operator">&lt;&lt;</span><span class="ruby-string">&#39;data_real_time &gt;= ? AND data_real_time &lt;= ? AND city_id = ?&#39;</span>
        <span class="ruby-identifier">sql_str</span><span class="ruby-operator">&lt;&lt;</span><span class="ruby-identifier">time</span>.<span class="ruby-identifier">to_time</span>.<span class="ruby-identifier">years_ago</span>(<span class="ruby-value">1</span>).<span class="ruby-identifier">beginning_of_day</span>
        <span class="ruby-identifier">sql_str</span><span class="ruby-operator">&lt;&lt;</span><span class="ruby-identifier">time</span>.<span class="ruby-identifier">to_time</span>.<span class="ruby-identifier">years_ago</span>(<span class="ruby-value">1</span>).<span class="ruby-identifier">end_of_day</span>
        <span class="ruby-identifier">sql_str</span><span class="ruby-operator">&lt;&lt;</span><span class="ruby-identifier">id</span>
        <span class="ruby-identifier">last_years_data</span> = <span class="ruby-identifier">model</span>.<span class="ruby-identifier">where</span>(<span class="ruby-identifier">sql_str</span>) 
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">last_years_data</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
                <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-identifier">last_years</span>=<span class="ruby-identifier">last_years_data</span>[<span class="ruby-value">0</span>]

        <span class="ruby-identifier">now_years</span> = <span class="ruby-identifier">model</span>.<span class="ruby-identifier">last</span>

        <span class="ruby-identifier">hs</span>=<span class="ruby-constant">Hash</span>.<span class="ruby-identifier">new</span>
        <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">now_years</span>.<span class="ruby-constant">SO2</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">last_years</span>.<span class="ruby-constant">SO2</span>.<span class="ruby-identifier">nil?</span>
                <span class="ruby-identifier">hs</span>[<span class="ruby-value">:SO2</span>]=(<span class="ruby-identifier">now_years</span>.<span class="ruby-constant">SO2</span><span class="ruby-operator">-</span><span class="ruby-identifier">last_years</span>.<span class="ruby-constant">SO2</span>)<span class="ruby-operator">/</span><span class="ruby-identifier">last_years</span>.<span class="ruby-constant">SO2</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">now_years</span>.<span class="ruby-constant">NO2</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">last_years</span>.<span class="ruby-constant">NO2</span>.<span class="ruby-identifier">nil?</span>
                <span class="ruby-identifier">hs</span>[<span class="ruby-value">:NO2</span>]=(<span class="ruby-identifier">now_years</span>.<span class="ruby-constant">NO2</span><span class="ruby-operator">-</span><span class="ruby-identifier">last_years</span>.<span class="ruby-constant">NO2</span>)<span class="ruby-operator">/</span><span class="ruby-identifier">last_years</span>.<span class="ruby-constant">NO2</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">now_years</span>.<span class="ruby-identifier">pm10</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">last_years</span>.<span class="ruby-identifier">pm10</span>.<span class="ruby-identifier">nil?</span>
                <span class="ruby-identifier">hs</span>[<span class="ruby-value">:pm10</span>]=(<span class="ruby-identifier">now_years</span>.<span class="ruby-identifier">pm10</span><span class="ruby-operator">-</span><span class="ruby-identifier">last_years</span>.<span class="ruby-identifier">pm10</span>)<span class="ruby-operator">/</span><span class="ruby-identifier">last_years</span>.<span class="ruby-identifier">pm10</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">now_years</span>.<span class="ruby-identifier">pm25</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">last_years</span>.<span class="ruby-identifier">pm25</span>.<span class="ruby-identifier">nil?</span>
                <span class="ruby-identifier">hs</span>[<span class="ruby-value">:pm25</span>]=(<span class="ruby-identifier">now_years</span>.<span class="ruby-identifier">pm25</span><span class="ruby-operator">-</span><span class="ruby-identifier">last_years</span>.<span class="ruby-identifier">pm25</span>)<span class="ruby-operator">/</span><span class="ruby-identifier">last_years</span>.<span class="ruby-identifier">pm25</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">now_years</span>.<span class="ruby-constant">CO</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">last_years</span>.<span class="ruby-constant">CO</span>.<span class="ruby-identifier">nil?</span>
                <span class="ruby-identifier">hs</span>[<span class="ruby-value">:CO</span>]=(<span class="ruby-identifier">now_years</span>.<span class="ruby-constant">CO</span><span class="ruby-operator">-</span><span class="ruby-identifier">last_years</span>.<span class="ruby-constant">CO</span>)<span class="ruby-operator">/</span><span class="ruby-identifier">last_years</span>.<span class="ruby-constant">CO</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">now_years</span>.<span class="ruby-constant">O3</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">last_years</span>.<span class="ruby-constant">O3</span>.<span class="ruby-identifier">nil?</span>
                <span class="ruby-identifier">hs</span>[<span class="ruby-value">:O3</span>]=(<span class="ruby-identifier">now_years</span>.<span class="ruby-constant">O3</span><span class="ruby-operator">-</span><span class="ruby-identifier">last_years</span>.<span class="ruby-constant">O3</span>)<span class="ruby-operator">/</span><span class="ruby-identifier">last_years</span>.<span class="ruby-constant">O3</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">now_years</span>.<span class="ruby-identifier">zonghezhishu</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">last_years</span>.<span class="ruby-identifier">zonghezhishu</span>.<span class="ruby-identifier">nil?</span>
                <span class="ruby-identifier">hs</span>[<span class="ruby-value">:zhzs</span>]=(<span class="ruby-identifier">now_years</span>.<span class="ruby-identifier">zonghezhishu</span><span class="ruby-operator">-</span><span class="ruby-identifier">last_years</span>.<span class="ruby-identifier">zonghezhishu</span>)<span class="ruby-operator">/</span><span class="ruby-identifier">last_years</span>.<span class="ruby-identifier">zonghezhishu</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-identifier">hs</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-get_rank_json" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">get_rank_json</span><span
            class="method-args">(web_flag,secretstr,typestr,datestr)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="get_rank_json-source">
            <pre><span class="ruby-comment"># File vendor/getdata/common.rb, line 26</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">get_rank_json</span>(<span class="ruby-identifier">web_flag</span>,<span class="ruby-identifier">secretstr</span>,<span class="ruby-identifier">typestr</span>,<span class="ruby-identifier">datestr</span>)
        <span class="ruby-identifier">json_data</span>[<span class="ruby-string">&#39;date&#39;</span>] <span class="ruby-operator">!=</span> <span class="ruby-keyword">nil</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">hs</span>[<span class="ruby-value">:time</span>] = <span class="ruby-identifier">json_data</span>[<span class="ruby-string">&#39;date&#39;</span>] <span class="ruby-operator">:</span> <span class="ruby-identifier">hs</span>[<span class="ruby-value">:time</span>] = <span class="ruby-identifier">json_data</span>[<span class="ruby-string">&#39;time&#39;</span>]
        <span class="ruby-identifier">hs</span>[<span class="ruby-value">:cities</span>] = <span class="ruby-identifier">column_name_modify</span>(<span class="ruby-identifier">json_data</span>[<span class="ruby-string">&#39;rows&#39;</span>])
        <span class="ruby-identifier">hs</span>[<span class="ruby-value">:total</span>]=<span class="ruby-identifier">json_data</span>[<span class="ruby-string">&#39;total&#39;</span>]
<span class="ruby-keyword">rescue</span>
        <span class="ruby-identifier">hs</span>=<span class="ruby-keyword">false</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-get_zonghezhishu" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">get_zonghezhishu</span><span
            class="method-args">(model)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>计算综合指数 需要6项指标的数据 先将当天的数据存储到数据库，再调用综合指数计算方法
年平均二级标准SO2:60,NO2:40,PM10:70,PM2.5:35 二级标准:CO 24小时平均4,O3日最大8小时平均160 参数
id=城市id</p>
          
          

          
          <div class="method-source-code" id="get_zonghezhishu-source">
            <pre><span class="ruby-comment"># File vendor/getdata/common.rb, line 56</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">get_zonghezhishu</span>(<span class="ruby-identifier">model</span>)
        <span class="ruby-identifier">dayCity</span>=<span class="ruby-identifier">model</span>.<span class="ruby-identifier">last</span>
        <span class="ruby-identifier">tmp</span> = <span class="ruby-identifier">dayCity</span>.<span class="ruby-constant">SO2</span>.<span class="ruby-identifier">to_f</span><span class="ruby-operator">/</span><span class="ruby-value">60</span><span class="ruby-operator">+</span><span class="ruby-identifier">dayCity</span>.<span class="ruby-constant">NO2</span>.<span class="ruby-identifier">to_f</span><span class="ruby-operator">/</span><span class="ruby-value">40</span><span class="ruby-operator">+</span><span class="ruby-identifier">dayCity</span>.<span class="ruby-identifier">pm10</span>.<span class="ruby-identifier">to_f</span><span class="ruby-operator">/</span><span class="ruby-value">70</span><span class="ruby-operator">+</span><span class="ruby-identifier">dayCity</span>.<span class="ruby-identifier">pm25</span>.<span class="ruby-identifier">to_f</span><span class="ruby-operator">/</span><span class="ruby-value">35</span><span class="ruby-operator">+</span><span class="ruby-identifier">dayCity</span>.<span class="ruby-constant">CO</span>.<span class="ruby-identifier">to_f</span><span class="ruby-operator">/</span><span class="ruby-value">4</span><span class="ruby-operator">+</span><span class="ruby-identifier">dayCity</span>.<span class="ruby-constant">O3</span>.<span class="ruby-identifier">to_f</span><span class="ruby-operator">/</span><span class="ruby-value">160</span>
        <span class="ruby-identifier">tmp</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-json" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">json</span><span
            class="method-args">(option)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>html to json,option是布尔变量，true时使用base64解码</p>
          
          

          
          <div class="method-source-code" id="json-source">
            <pre><span class="ruby-comment"># File vendor/getdata/common.rb, line 16</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">json</span>(<span class="ruby-identifier">option</span>)
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">option</span>
                <span class="ruby-constant">JSON</span>.<span class="ruby-identifier">parse</span>(<span class="ruby-constant">Base64</span>.<span class="ruby-identifier">decode64</span>(<span class="ruby-ivar">@response</span>.<span class="ruby-identifier">body</span>))
        <span class="ruby-keyword">else</span>
                <span class="ruby-constant">JSON</span>.<span class="ruby-identifier">parse</span>(<span class="ruby-ivar">@response</span>.<span class="ruby-identifier">body</span>)
        <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-out_log" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">out_log</span><span
            class="method-args">(log_string)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>脚本异常返回日志</p>
          
          

          
          <div class="method-source-code" id="out_log-source">
            <pre><span class="ruby-comment"># File vendor/getdata/common.rb, line 236</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">out_log</span>(<span class="ruby-identifier">log_string</span>)
        <span class="ruby-identifier">this_log</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">open</span>(<span class="ruby-string">&quot;/vagrant/geo_rails_test/log/getdata.log&quot;</span>,<span class="ruby-string">&quot;a&quot;</span>)
        <span class="ruby-identifier">this_log</span>.<span class="ruby-identifier">puts</span>(<span class="ruby-identifier">log_string</span>)
        <span class="ruby-identifier">this_log</span>.<span class="ruby-identifier">close</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-percentile" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">percentile</span><span
            class="method-args">(array,num)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>百分位计算</p>
          
          

          
          <div class="method-source-code" id="percentile-source">
            <pre><span class="ruby-comment"># File vendor/getdata/common.rb, line 155</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">percentile</span>(<span class="ruby-identifier">array</span>,<span class="ruby-identifier">num</span>)
        <span class="ruby-comment">#co o3百分位数计</span>
        <span class="ruby-identifier">array</span> = <span class="ruby-identifier">array</span>.<span class="ruby-identifier">sort</span>
        <span class="ruby-identifier">ind</span>=<span class="ruby-identifier">array</span>.<span class="ruby-identifier">length</span><span class="ruby-operator">*</span><span class="ruby-identifier">num</span>
        (<span class="ruby-identifier">ind</span>.<span class="ruby-identifier">is_a?</span><span class="ruby-constant">Float</span>) <span class="ruby-operator">?</span> <span class="ruby-identifier">array</span>[<span class="ruby-identifier">ind</span>.<span class="ruby-identifier">floor</span>].<span class="ruby-identifier">to_f</span> <span class="ruby-operator">:</span> (<span class="ruby-identifier">array</span>[<span class="ruby-identifier">ind</span>].<span class="ruby-identifier">to_f</span><span class="ruby-operator">+</span><span class="ruby-identifier">array</span>[<span class="ruby-identifier">ind</span><span class="ruby-operator">+</span><span class="ruby-value">1</span>].<span class="ruby-identifier">to_f</span>)<span class="ruby-operator">/</span><span class="ruby-value">2</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-post" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">post</span><span
            class="method-args">(url,option)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>通过post方式请求数据</p>
          
          

          
          <div class="method-source-code" id="post-source">
            <pre><span class="ruby-comment"># File vendor/getdata/common.rb, line 11</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">post</span>(<span class="ruby-identifier">url</span>,<span class="ruby-identifier">option</span>)
        <span class="ruby-ivar">@response</span> = <span class="ruby-constant">HTTParty</span>.<span class="ruby-identifier">post</span>(<span class="ruby-identifier">url</span>,<span class="ruby-value">:body</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">option</span>)
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-save_db" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">save_db</span><span
            class="method-args">(hs,model)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>保存数据</p>
          
          

          
          <div class="method-source-code" id="save_db-source">
            <pre><span class="ruby-comment"># File vendor/getdata/common.rb, line 243</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">save_db</span>(<span class="ruby-identifier">hs</span>,<span class="ruby-identifier">model</span>)
        <span class="ruby-identifier">hs</span>[<span class="ruby-value">:cities</span>].<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span>
                <span class="ruby-identifier">save_db_common</span>(<span class="ruby-identifier">model</span>,<span class="ruby-identifier">t</span>,<span class="ruby-identifier">hs</span>[<span class="ruby-value">:time</span>])
        <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-save_db_common" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">save_db_common</span><span
            class="method-args">(model,t,time)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>保存数据到数据库</p>
          
          

          
          <div class="method-source-code" id="save_db_common-source">
            <pre><span class="ruby-comment"># File vendor/getdata/common.rb, line 250</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">save_db_common</span>(<span class="ruby-identifier">model</span>,<span class="ruby-identifier">t</span>,<span class="ruby-identifier">time</span>)
        <span class="ruby-identifier">city</span> = <span class="ruby-constant">City</span>.<span class="ruby-identifier">find_by_city_name</span>(<span class="ruby-identifier">t</span>[<span class="ruby-string">&#39;city&#39;</span>].<span class="ruby-identifier">to_s</span><span class="ruby-operator">+</span><span class="ruby-string">&#39;市&#39;</span>)
        <span class="ruby-identifier">city</span> = <span class="ruby-constant">City</span>.<span class="ruby-identifier">find_by_city_name</span>(<span class="ruby-identifier">t</span>[<span class="ruby-string">&#39;city&#39;</span>]) <span class="ruby-keyword">if</span> <span class="ruby-identifier">city</span>.<span class="ruby-identifier">nil?</span>
        <span class="ruby-identifier">city</span> = <span class="ruby-constant">City</span>.<span class="ruby-identifier">find_by_city_name</span>(<span class="ruby-constant">CityEnum</span>.<span class="ruby-identifier">city_short</span>(<span class="ruby-identifier">t</span>[<span class="ruby-string">&#39;city&#39;</span>])) <span class="ruby-keyword">if</span> <span class="ruby-identifier">city</span>.<span class="ruby-identifier">nil?</span>
        <span class="ruby-keyword">return</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">city</span>.<span class="ruby-identifier">nil?</span>    
        <span class="ruby-identifier">day_city</span>=<span class="ruby-identifier">model</span>.<span class="ruby-identifier">new</span>
        <span class="ruby-identifier">day_city</span>.<span class="ruby-identifier">city_id</span>=<span class="ruby-identifier">city</span>.<span class="ruby-identifier">id</span>
        <span class="ruby-identifier">day_city</span>.<span class="ruby-constant">SO2</span>=<span class="ruby-identifier">t</span>[<span class="ruby-string">&#39;so2&#39;</span>] <span class="ruby-keyword">if</span> <span class="ruby-identifier">t</span>[<span class="ruby-string">&#39;so2&#39;</span>] <span class="ruby-operator">!=</span> <span class="ruby-keyword">nil</span>
        <span class="ruby-identifier">day_city</span>.<span class="ruby-constant">NO2</span>=<span class="ruby-identifier">t</span>[<span class="ruby-string">&#39;no2&#39;</span>] <span class="ruby-keyword">if</span> <span class="ruby-identifier">t</span>[<span class="ruby-string">&#39;no2&#39;</span>] <span class="ruby-operator">!=</span> <span class="ruby-keyword">nil</span>
        <span class="ruby-identifier">day_city</span>.<span class="ruby-constant">CO</span>=<span class="ruby-identifier">t</span>[<span class="ruby-string">&#39;co&#39;</span>] <span class="ruby-keyword">if</span> <span class="ruby-identifier">t</span>[<span class="ruby-string">&#39;co&#39;</span>] <span class="ruby-operator">!=</span> <span class="ruby-keyword">nil</span>
        <span class="ruby-identifier">day_city</span>.<span class="ruby-constant">O3</span> = <span class="ruby-identifier">t</span>[<span class="ruby-string">&#39;o3&#39;</span>] <span class="ruby-keyword">if</span> <span class="ruby-identifier">t</span>[<span class="ruby-string">&#39;o3&#39;</span>] <span class="ruby-operator">!=</span> <span class="ruby-keyword">nil</span>
        <span class="ruby-identifier">day_city</span>.<span class="ruby-identifier">pm10</span>=<span class="ruby-identifier">t</span>[<span class="ruby-string">&#39;pm10&#39;</span>] <span class="ruby-keyword">if</span> <span class="ruby-identifier">t</span>[<span class="ruby-string">&#39;pm10&#39;</span>] <span class="ruby-operator">!=</span> <span class="ruby-keyword">nil</span>
        <span class="ruby-identifier">day_city</span>.<span class="ruby-identifier">pm25</span>=<span class="ruby-identifier">t</span>[<span class="ruby-string">&#39;pm2_5&#39;</span>] <span class="ruby-keyword">if</span> <span class="ruby-identifier">t</span>[<span class="ruby-string">&#39;pm2_5&#39;</span>] <span class="ruby-operator">!=</span> <span class="ruby-keyword">nil</span>
        <span class="ruby-identifier">day_city</span>.<span class="ruby-constant">AQI</span> = <span class="ruby-identifier">t</span>[<span class="ruby-string">&#39;aqi&#39;</span>] <span class="ruby-keyword">if</span> <span class="ruby-identifier">t</span>[<span class="ruby-string">&#39;aqi&#39;</span>] <span class="ruby-operator">!=</span> <span class="ruby-keyword">nil</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">day_city</span>.<span class="ruby-identifier">respond_to?</span>(<span class="ruby-string">&#39;AQI&#39;</span>)
        <span class="ruby-identifier">day_city</span>.<span class="ruby-identifier">level</span> = <span class="ruby-identifier">t</span>[<span class="ruby-string">&#39;quality&#39;</span>] <span class="ruby-keyword">if</span> <span class="ruby-identifier">t</span>[<span class="ruby-string">&#39;quality&#39;</span>] <span class="ruby-operator">!=</span> <span class="ruby-keyword">nil</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">day_city</span>.<span class="ruby-identifier">respond_to?</span>(<span class="ruby-string">&#39;level&#39;</span>)
        <span class="ruby-identifier">day_city</span>.<span class="ruby-identifier">maxindex</span>=<span class="ruby-identifier">t</span>[<span class="ruby-string">&#39;maxindex&#39;</span>] <span class="ruby-keyword">if</span> [<span class="ruby-string">&#39;maxindex&#39;</span>] <span class="ruby-operator">!=</span> <span class="ruby-keyword">nil</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">day_city</span>.<span class="ruby-identifier">respond_to?</span>(<span class="ruby-string">&#39;maxindex&#39;</span>)
        <span class="ruby-identifier">day_city</span>.<span class="ruby-identifier">main_pol</span>=<span class="ruby-identifier">t</span>[<span class="ruby-string">&#39;main_pollutant&#39;</span>] <span class="ruby-keyword">if</span> [<span class="ruby-string">&#39;main_pollutant&#39;</span>] <span class="ruby-operator">!=</span> <span class="ruby-keyword">nil</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">day_city</span>.<span class="ruby-identifier">respond_to?</span>(<span class="ruby-string">&#39;main_pol&#39;</span>)
        <span class="ruby-identifier">day_city</span>.<span class="ruby-identifier">weather</span> = <span class="ruby-identifier">t</span>[<span class="ruby-string">&#39;weather&#39;</span>] <span class="ruby-keyword">if</span> <span class="ruby-identifier">t</span>[<span class="ruby-string">&#39;weather&#39;</span>] <span class="ruby-operator">!=</span> <span class="ruby-keyword">nil</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">day_city</span>.<span class="ruby-identifier">respond_to?</span>(<span class="ruby-string">&#39;weather&#39;</span>)
        <span class="ruby-identifier">day_city</span>.<span class="ruby-identifier">temp</span> = <span class="ruby-identifier">t</span>[<span class="ruby-string">&#39;temp&#39;</span>] <span class="ruby-keyword">if</span> <span class="ruby-identifier">t</span>[<span class="ruby-string">&#39;temp&#39;</span>] <span class="ruby-operator">!=</span> <span class="ruby-keyword">nil</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">day_city</span>.<span class="ruby-identifier">respond_to?</span>(<span class="ruby-string">&#39;temp&#39;</span>)
        <span class="ruby-identifier">day_city</span>.<span class="ruby-identifier">humi</span> = <span class="ruby-identifier">t</span>[<span class="ruby-string">&#39;humi&#39;</span>] <span class="ruby-keyword">if</span> <span class="ruby-identifier">t</span>[<span class="ruby-string">&#39;humi&#39;</span>] <span class="ruby-operator">!=</span> <span class="ruby-keyword">nil</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">day_city</span>.<span class="ruby-identifier">respond_to?</span>(<span class="ruby-string">&#39;humi&#39;</span>)
        <span class="ruby-identifier">day_city</span>.<span class="ruby-identifier">winddirection</span>=<span class="ruby-identifier">t</span>[<span class="ruby-string">&#39;winddirection&#39;</span>] <span class="ruby-keyword">if</span> <span class="ruby-identifier">t</span>[<span class="ruby-string">&#39;winddirection&#39;</span>] <span class="ruby-operator">!=</span> <span class="ruby-keyword">nil</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">day_city</span>.<span class="ruby-identifier">respond_to?</span>(<span class="ruby-string">&#39;winddirection&#39;</span>)
        <span class="ruby-identifier">day_city</span>.<span class="ruby-identifier">windspeed</span>=<span class="ruby-identifier">t</span>[<span class="ruby-string">&#39;windspeed&#39;</span>] <span class="ruby-keyword">if</span> <span class="ruby-identifier">t</span>[<span class="ruby-string">&#39;windspeed&#39;</span>] <span class="ruby-operator">!=</span> <span class="ruby-keyword">nil</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">day_city</span>.<span class="ruby-identifier">respond_to?</span>(<span class="ruby-string">&#39;windspeed&#39;</span>)
        <span class="ruby-identifier">time</span> = <span class="ruby-identifier">t</span>[<span class="ruby-string">&#39;time&#39;</span>].<span class="ruby-identifier">to_time</span>.<span class="ruby-identifier">localtime</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">time</span>.<span class="ruby-identifier">nil?</span>
        <span class="ruby-identifier">day_city</span>.<span class="ruby-identifier">data_real_time</span> = <span class="ruby-identifier">time</span>.<span class="ruby-identifier">to_time</span>.<span class="ruby-identifier">localtime</span>
        <span class="ruby-identifier">day_city</span>.<span class="ruby-identifier">save</span>

        <span class="ruby-keyword">if</span> <span class="ruby-identifier">model</span>.<span class="ruby-identifier">new</span>.<span class="ruby-identifier">respond_to?</span>(<span class="ruby-string">&#39;zonghezhishu&#39;</span>)
                <span class="ruby-identifier">day_city</span> = <span class="ruby-identifier">model</span>.<span class="ruby-identifier">last</span>
                <span class="ruby-comment">#判断接口是否提供综合指数</span>
                <span class="ruby-keyword">if</span> <span class="ruby-identifier">t</span>[<span class="ruby-string">&#39;complexindex&#39;</span>] <span class="ruby-operator">!=</span> <span class="ruby-keyword">nil</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">t</span>[<span class="ruby-string">&#39;complexindex&#39;</span>] <span class="ruby-operator">!=</span> <span class="ruby-value">0</span>
                        <span class="ruby-identifier">day_city</span>.<span class="ruby-identifier">zonghezhishu</span> = <span class="ruby-identifier">t</span>[<span class="ruby-string">&#39;complexindex&#39;</span>]
                <span class="ruby-keyword">else</span>
                        <span class="ruby-identifier">day_city</span>.<span class="ruby-identifier">zonghezhishu</span> = <span class="ruby-identifier">get_zonghezhishu</span>(<span class="ruby-identifier">model</span>)
                <span class="ruby-keyword">end</span>
                <span class="ruby-identifier">day_city</span>.<span class="ruby-identifier">save</span>
                <span class="ruby-identifier">set_change_rate_to_db</span>(<span class="ruby-identifier">model</span>,<span class="ruby-identifier">city</span>.<span class="ruby-identifier">id</span>,<span class="ruby-identifier">time</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">model</span>.<span class="ruby-identifier">new</span>.<span class="ruby-identifier">respond_to?</span>(<span class="ruby-string">&quot;zongheindex_change_rate&quot;</span>)
        <span class="ruby-keyword">end</span>
        <span class="ruby-identifier">puts</span> <span class="ruby-string">&#39;==&#39;</span><span class="ruby-operator">+</span><span class="ruby-identifier">model</span>.<span class="ruby-identifier">name</span><span class="ruby-operator">+</span><span class="ruby-string">&#39;==&#39;</span><span class="ruby-operator">+</span><span class="ruby-identifier">time</span>.<span class="ruby-identifier">to_s</span><span class="ruby-operator">+</span><span class="ruby-string">&#39;=Save OK!===&#39;</span>
        <span class="ruby-identifier">out_log</span>(<span class="ruby-identifier">model</span>.<span class="ruby-identifier">name</span><span class="ruby-operator">+</span><span class="ruby-identifier">time</span>.<span class="ruby-identifier">to_s</span><span class="ruby-operator">+</span><span class="ruby-identifier">t</span>[<span class="ruby-string">&#39;city&#39;</span>]) <span class="ruby-keyword">if</span> <span class="ruby-identifier">city</span>.<span class="ruby-identifier">nil?</span>   
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-set_change_rate_to_db" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">set_change_rate_to_db</span><span
            class="method-args">(model,id,time)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>保存同期对比</p>
          
          

          
          <div class="method-source-code" id="set_change_rate_to_db-source">
            <pre><span class="ruby-comment"># File vendor/getdata/common.rb, line 203</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">set_change_rate_to_db</span>(<span class="ruby-identifier">model</span>,<span class="ruby-identifier">id</span>,<span class="ruby-identifier">time</span>)
        <span class="ruby-identifier">day_city</span> = <span class="ruby-identifier">model</span>.<span class="ruby-identifier">last</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">day_city</span>.<span class="ruby-identifier">data_real_time</span>.<span class="ruby-identifier">year</span>.<span class="ruby-identifier">to_i</span><span class="ruby-operator">&gt;</span><span class="ruby-value">2014</span>.<span class="ruby-identifier">to_i</span> 
                <span class="ruby-identifier">change_rate</span> = <span class="ruby-identifier">get_change_rate</span>(<span class="ruby-identifier">model</span>,<span class="ruby-identifier">id</span>,<span class="ruby-identifier">time</span>)
                <span class="ruby-keyword">return</span> <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">change_rate</span>
                <span class="ruby-identifier">day_city</span>.<span class="ruby-constant">SO2_change_rate</span>=<span class="ruby-identifier">change_rate</span>[<span class="ruby-value">:SO2</span>]
                <span class="ruby-identifier">day_city</span>.<span class="ruby-constant">NO2_change_rate</span>=<span class="ruby-identifier">change_rate</span>[<span class="ruby-value">:NO2</span>]
                <span class="ruby-identifier">day_city</span>.<span class="ruby-constant">CO_change_rate</span>=<span class="ruby-identifier">change_rate</span>[<span class="ruby-value">:CO</span>]
                <span class="ruby-identifier">day_city</span>.<span class="ruby-constant">O3_change_rate</span>=<span class="ruby-identifier">change_rate</span>[<span class="ruby-value">:O3</span>]
                <span class="ruby-identifier">day_city</span>.<span class="ruby-identifier">pm10_change_rate</span>=<span class="ruby-identifier">change_rate</span>[<span class="ruby-value">:pm10</span>]
                <span class="ruby-identifier">day_city</span>.<span class="ruby-identifier">pm25_change_rate</span>=<span class="ruby-identifier">change_rate</span>[<span class="ruby-value">:pm25</span>]
                <span class="ruby-identifier">day_city</span>.<span class="ruby-identifier">zongheindex_change_rate</span>=<span class="ruby-identifier">change_rate</span>[<span class="ruby-value">:zhzs</span>]
        <span class="ruby-keyword">end</span>
        <span class="ruby-identifier">day_city</span>.<span class="ruby-identifier">save</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-ten_times_test" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">ten_times_test</span><span
            class="method-args">(model,url,secret,type,date)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>调用接口最多进行10次尝试，如有数据则返回数据，没有数据返回false</p>
          
          

          
          <div class="method-source-code" id="ten_times_test-source">
            <pre><span class="ruby-comment"># File vendor/getdata/common.rb, line 220</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">ten_times_test</span>(<span class="ruby-identifier">model</span>,<span class="ruby-identifier">url</span>,<span class="ruby-identifier">secret</span>,<span class="ruby-identifier">type</span>,<span class="ruby-identifier">date</span>)
        <span class="ruby-identifier">hs</span>=<span class="ruby-constant">Hash</span>.<span class="ruby-identifier">new</span>
        (<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-value">10</span>).<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span>
                <span class="ruby-identifier">hs</span>=<span class="ruby-identifier">get_rank_json</span>(<span class="ruby-identifier">url</span>,<span class="ruby-identifier">secret</span>,<span class="ruby-identifier">type</span>,<span class="ruby-identifier">date</span>)  
                <span class="ruby-keyword">break</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">hs!</span>=<span class="ruby-keyword">false</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">hs</span> <span class="ruby-operator">==</span> <span class="ruby-keyword">false</span>
                <span class="ruby-identifier">out_log</span>(<span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">to_s</span><span class="ruby-operator">+</span><span class="ruby-string">&quot; &quot;</span><span class="ruby-operator">+</span><span class="ruby-identifier">model</span>.<span class="ruby-identifier">name</span><span class="ruby-operator">+</span><span class="ruby-string">&quot;ERROR！&quot;</span>)
        <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">hs</span>[<span class="ruby-value">:total</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
                <span class="ruby-identifier">out_log</span>(<span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">to_s</span><span class="ruby-operator">+</span><span class="ruby-string">&quot; &quot;</span><span class="ruby-operator">+</span><span class="ruby-identifier">model</span>.<span class="ruby-identifier">name</span><span class="ruby-operator">+</span><span class="ruby-string">&quot;total is 0&quot;</span>)
                <span class="ruby-identifier">hs</span>=<span class="ruby-keyword">false</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-identifier">hs</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
    </section>
  
  </section>
</main>


<footer id="validator-badges" role="contentinfo">
  <p><a href="http://validator.w3.org/check/referer">Validate</a>
  <p>Generated by <a href="http://docs.seattlerb.org/rdoc/">RDoc</a> 4.2.0.
  <p>Based on <a href="http://deveiate.org/projects/Darkfish-RDoc/">Darkfish</a> by <a href="http://deveiate.org">Michael Granger</a>.
</footer>

