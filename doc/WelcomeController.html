<!DOCTYPE html>

<html>
<head>
<meta charset="UTF-8">

<title>class WelcomeController - RDoc Documentation</title>

<script type="text/javascript">
  var rdoc_rel_prefix = "./";
</script>

<script src="./js/jquery.js"></script>
<script src="./js/darkfish.js"></script>

<link href="./css/fonts.css" rel="stylesheet">
<link href="./css/rdoc.css" rel="stylesheet">



<body id="top" role="document" class="class">
<nav role="navigation">
  <div id="project-navigation">
    <div id="home-section" role="region" title="Quick navigation" class="nav-section">
  <h2>
    <a href="./index.html" rel="home">Home</a>
  </h2>

  <div id="table-of-contents-navigation">
    <a href="./table_of_contents.html#pages">Pages</a>
    <a href="./table_of_contents.html#classes">Classes</a>
    <a href="./table_of_contents.html#methods">Methods</a>
  </div>
</div>

    <div id="search-section" role="search" class="project-section initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <div id="search-field-wrapper">
      <input id="search-field" role="combobox" aria-label="Search"
             aria-autocomplete="list" aria-controls="search-results"
             type="text" name="search" placeholder="Search" spellcheck="false"
             title="Type to search, Up and Down to navigate, Enter to load">
    </div>

    <ul id="search-results" aria-label="Search Results"
        aria-busy="false" aria-expanded="false"
        aria-atomic="false" class="initially-hidden"></ul>
  </form>
</div>

  </div>

  

  <div id="class-metadata">
    
    <div id="parent-class-section" class="nav-section">
  <h3>Parent</h3>

  
  <p class="link"><a href="ApplicationController.html">ApplicationController</a>
  
</div>

    <div id="includes-section" class="nav-section">
  <h3>Included Modules</h3>

  <ul class="link-list">
  
  
    <li><span class="include">NumRu</span>
  
  
  </ul>
</div>

    
    <!-- Method Quickref -->
<div id="method-list-section" class="nav-section">
  <h3>Methods</h3>

  <ul class="link-list" role="directory">
    
    <li ><a href="#method-i-adj_ajax">#adj_ajax</a>
    
    <li ><a href="#method-i-adj_percent">#adj_percent</a>
    
    <li ><a href="#method-i-adj_pie">#adj_pie</a>
    
    <li ><a href="#method-i-banner">#banner</a>
    
    <li ><a href="#method-i-bar">#bar</a>
    
    <li ><a href="#method-i-bdqx_compare">#bdqx_compare</a>
    
    <li ><a href="#method-i-bdqx_compare_chart">#bdqx_compare_chart</a>
    
    <li ><a href="#method-i-cal_var">#cal_var</a>
    
    <li ><a href="#method-i-change_74_main_pol">#change_74_main_pol</a>
    
    <li ><a href="#method-i-change_data_type">#change_data_type</a>
    
    <li ><a href="#method-i-chartway">#chartway</a>
    
    <li ><a href="#method-i-city_compare_chart">#city_compare_chart</a>
    
    <li ><a href="#method-i-compare">#compare</a>
    
    <li ><a href="#method-i-del_some_points">#del_some_points</a>
    
    <li ><a href="#method-i-forecast">#forecast</a>
    
    <li ><a href="#method-i-get_city_point">#get_city_point</a>
    
    <li ><a href="#method-i-get_db_data">#get_db_data</a>
    
    <li ><a href="#method-i-get_forecast">#get_forecast</a>
    
    <li ><a href="#method-i-get_forecast_baoding">#get_forecast_baoding</a>
    
    <li ><a href="#method-i-get_history_data">#get_history_data</a>
    
    <li ><a href="#method-i-get_lev">#get_lev</a>
    
    <li ><a href="#method-i-get_tq">#get_tq</a>
    
    <li ><a href="#method-i-getlayoutbyaction">#getlayoutbyaction</a>
    
    <li ><a href="#method-i-hb_real">#hb_real</a>
    
    <li ><a href="#method-i-index">#index</a>
    
    <li ><a href="#method-i-map">#map</a>
    
    <li ><a href="#method-i-pinggu">#pinggu</a>
    
    <li ><a href="#method-i-rank1503">#rank1503</a>
    
    <li ><a href="#method-i-read_adj">#read_adj</a>
    
    <li ><a href="#method-i-sfcities_compare">#sfcities_compare</a>
    
    <li ><a href="#method-i-show">#show</a>
    
    <li ><a href="#method-i-subindex">#subindex</a>
    
    <li ><a href="#method-i-visits_by_day">#visits_by_day</a>
    
    <li ><a href="#method-i-wind_power">#wind_power</a>
    
  </ul>
</div>

  </div>
</nav>

<main role="main" aria-labelledby="class-WelcomeController">
  <h1 id="class-WelcomeController" class="class">
    class WelcomeController
  </h1>

  <section class="description">
    
  </section>

  
  
  
  <section id="5Buntitled-5D" class="documentation-section">
    

    

    
    <section class="constants-list">
      <header>
        <h3>Constants</h3>
      </header>
      <dl>
      
        <dt id="CITY_LIST">CITY_LIST
        
        <dd>
        
      
        <dt id="CITY_LIST_ZZ">CITY_LIST_ZZ
        
        <dd>
        
      
        <dt id="CL">CL
        
        <dd>
        
      
        <dt id="CL_ZZ">CL_ZZ
        
        <dd>
        
      
      </dl>
    </section>
    

    

    
     <section id="public-instance-5Buntitled-5D-method-details" class="method-section">
       <header>
         <h3>Public Instance Methods</h3>
       </header>

    
      <div id="method-i-adj_ajax" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">adj_ajax</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="adj_ajax-source">
            <pre><span class="ruby-comment"># File app/controllers/qinhuangdao_controller.rb, line 612</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">adj_ajax</span>
        <span class="ruby-ivar">@type</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:type</span>] <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:type</span>]
        <span class="ruby-identifier">post</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:post</span>] <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:post</span>]
        <span class="ruby-keyword">case</span> <span class="ruby-identifier">post</span>
        <span class="ruby-keyword">when</span> <span class="ruby-string">&#39;130600&#39;</span>
                <span class="ruby-ivar">@city_adj</span> = <span class="ruby-string">&#39;ADJ_baoding/&#39;</span>
        <span class="ruby-keyword">else</span>
                <span class="ruby-ivar">@city_adj</span> = <span class="ruby-string">&#39;ADJ/&#39;</span>
        <span class="ruby-keyword">end</span>

        <span class="ruby-ivar">@adj_per</span> = <span class="ruby-identifier">adj_percent</span>(<span class="ruby-ivar">@type</span>, <span class="ruby-ivar">@city_adj</span>)
        <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
                <span class="ruby-identifier">format</span>.<span class="ruby-identifier">js</span>   {
                        <span class="ruby-identifier">puts</span> <span class="ruby-ivar">@adj_per</span>
                }
        <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-adj_percent" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">adj_percent</span><span
            class="method-args">(type="", city='ADJ_baoding')</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="adj_percent-source">
            <pre><span class="ruby-comment"># File app/controllers/qinhuangdao_controller.rb, line 578</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">adj_percent</span>(<span class="ruby-identifier">type</span>=<span class="ruby-string">&quot;&quot;</span>, <span class="ruby-identifier">city</span>=<span class="ruby-string">&#39;ADJ_baoding&#39;</span>)
        <span class="ruby-identifier">nt</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>
        <span class="ruby-identifier">i</span> = <span class="ruby-value">0</span>
        <span class="ruby-identifier">path</span> = <span class="ruby-string">&#39;public/images/ftproot/Temp/Backup&#39;</span><span class="ruby-operator">+</span><span class="ruby-identifier">city</span><span class="ruby-operator">+</span><span class="ruby-string">&#39;/&#39;</span>
        <span class="ruby-comment">#path = &#39;/mnt/share/Temp/Backup&#39;+city+&#39;/&#39;</span>
        <span class="ruby-keyword">begin</span>
                <span class="ruby-comment">#puts i</span>
                <span class="ruby-identifier">strtime</span> = (<span class="ruby-identifier">nt</span><span class="ruby-operator">-</span><span class="ruby-value">60</span><span class="ruby-operator">*</span><span class="ruby-value">60</span><span class="ruby-operator">*</span><span class="ruby-value">24</span><span class="ruby-operator">*</span><span class="ruby-identifier">i</span>).<span class="ruby-identifier">strftime</span>(<span class="ruby-string">&quot;%Y-%m-%d&quot;</span>)
                <span class="ruby-identifier">ncfile</span> = <span class="ruby-identifier">path</span> <span class="ruby-operator">+</span> <span class="ruby-string">&#39;CUACE_09km_adj_&#39;</span><span class="ruby-operator">+</span><span class="ruby-identifier">strtime</span><span class="ruby-operator">+</span><span class="ruby-string">&#39;.nc&#39;</span>
                <span class="ruby-comment">#ncfile=&#39;public\images\CUACE_09km_adj_2015-06-27.nc&#39;</span>
                <span class="ruby-identifier">i</span> = <span class="ruby-identifier">i</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>
                <span class="ruby-keyword">return</span> {} <span class="ruby-keyword">if</span> <span class="ruby-identifier">i</span><span class="ruby-operator">&gt;</span><span class="ruby-value">60</span>
        <span class="ruby-keyword">end</span> <span class="ruby-keyword">until</span> <span class="ruby-constant">File</span><span class="ruby-operator">::</span><span class="ruby-identifier">exists?</span>(<span class="ruby-identifier">ncfile</span>)

        <span class="ruby-comment">#ncfile = &#39;public/adj/CUACE_09km_adj_2015-06-08.nc&#39;</span>

        <span class="ruby-comment">#puts ncfile</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">type</span><span class="ruby-operator">==</span><span class="ruby-string">&quot;&quot;</span>
                <span class="ruby-identifier">var_list</span> = [<span class="ruby-string">&quot;CO_120&quot;</span>, <span class="ruby-string">&quot;NOX_120&quot;</span>, <span class="ruby-string">&quot;SO2_120&quot;</span>]
        <span class="ruby-keyword">else</span>
                <span class="ruby-identifier">var_list</span> = [<span class="ruby-identifier">type</span>]
        <span class="ruby-keyword">end</span>
        <span class="ruby-identifier">adj_per</span> = {}
        <span class="ruby-identifier">var_list</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">var_name</span><span class="ruby-operator">|</span>
                <span class="ruby-identifier">pl</span> = (<span class="ruby-identifier">cal_var</span> <span class="ruby-identifier">ncfile</span>, <span class="ruby-identifier">var_name</span>)
                <span class="ruby-comment"># puts var_name</span>
                <span class="ruby-identifier">pl</span>.<span class="ruby-identifier">sort</span>.<span class="ruby-identifier">reverse</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span>
                        <span class="ruby-identifier">print</span> <span class="ruby-constant">CL</span>[<span class="ruby-identifier">pl</span>.<span class="ruby-identifier">index</span>(<span class="ruby-identifier">p</span>)], <span class="ruby-string">&quot;   &quot;</span>, <span class="ruby-identifier">p</span>, <span class="ruby-string">&quot;\n&quot;</span>
                        <span class="ruby-identifier">adj_per</span>[<span class="ruby-constant">CL</span>[<span class="ruby-identifier">pl</span>.<span class="ruby-identifier">index</span>(<span class="ruby-identifier">p</span>)]] = <span class="ruby-identifier">p</span>.<span class="ruby-identifier">round</span>(<span class="ruby-value">2</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">p</span>.<span class="ruby-identifier">round</span>(<span class="ruby-value">1</span>) <span class="ruby-operator">&gt;</span> <span class="ruby-value">0.03</span>
                }
        }
        <span class="ruby-identifier">adj_per</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-adj_pie" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">adj_pie</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="adj_pie-source">
            <pre><span class="ruby-comment"># File app/controllers/qinhuangdao_controller.rb, line 561</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">adj_pie</span>
        <span class="ruby-identifier">city_dir</span> = <span class="ruby-string">&#39;ADJ_baoding&#39;</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:city_name</span>]
                <span class="ruby-identifier">city_dir</span> = <span class="ruby-string">&#39;ADJ_baoding&#39;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:city_name</span>] <span class="ruby-operator">==</span> <span class="ruby-string">&#39;baodingshi&#39;</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-identifier">adj_bd</span> = {}
        <span class="ruby-identifier">var_list</span> = [<span class="ruby-string">&quot;CO_120&quot;</span>, <span class="ruby-string">&quot;NOX_120&quot;</span>, <span class="ruby-string">&quot;SO2_120&quot;</span>]
        <span class="ruby-identifier">var_list</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">var_name</span><span class="ruby-operator">|</span>
                <span class="ruby-identifier">adj_per</span> = <span class="ruby-identifier">adj_percent</span>(<span class="ruby-identifier">var_name</span>,<span class="ruby-identifier">city_dir</span>)
                <span class="ruby-identifier">adj_bd</span>[<span class="ruby-identifier">var_name</span>] = <span class="ruby-identifier">adj_per</span>
        }
        <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
                <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span>   {
                        <span class="ruby-identifier">render</span> <span class="ruby-identifier">json</span><span class="ruby-operator">:</span> <span class="ruby-identifier">adj_bd</span>
                }
        <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-banner" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">banner</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="banner-source">
            <pre><span class="ruby-comment"># File app/controllers/qinhuangdao_controller.rb, line 703</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">banner</span>
        <span class="ruby-identifier">hs</span> = <span class="ruby-constant">Hash</span>.<span class="ruby-identifier">new</span>
        <span class="ruby-comment"># monitor data</span>
        <span class="ruby-identifier">md</span> = <span class="ruby-identifier">hb_real</span>
        <span class="ruby-identifier">hs</span>[<span class="ruby-string">&#39;rt&#39;</span>]= <span class="ruby-identifier">md</span>[<span class="ruby-value">:time</span>]
        <span class="ruby-identifier">md</span>[<span class="ruby-value">:cities</span>].<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">c</span><span class="ruby-operator">|</span>
                <span class="ruby-keyword">if</span> <span class="ruby-identifier">c</span>[<span class="ruby-string">&#39;city&#39;</span>] <span class="ruby-operator">==</span> <span class="ruby-string">&#39;保定&#39;</span>
                        <span class="ruby-identifier">hs</span> = <span class="ruby-identifier">hs</span>.<span class="ruby-identifier">merge</span>(<span class="ruby-identifier">c</span>)
                        <span class="ruby-keyword">break</span>
                <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-comment"># forecast data</span>
        <span class="ruby-identifier">aqis</span> = []
        <span class="ruby-identifier">pri_pol</span> = []
        <span class="ruby-identifier">c</span> = <span class="ruby-constant">City</span>.<span class="ruby-identifier">find_by_city_name_pinyin</span>(<span class="ruby-string">&#39;baodingshi&#39;</span>)
        <span class="ruby-identifier">ch</span> = <span class="ruby-identifier">c</span>.<span class="ruby-identifier">hourly_city_forecast_air_qualities</span>.<span class="ruby-identifier">order</span>(<span class="ruby-value">:publish_datetime</span>).<span class="ruby-identifier">last</span>(<span class="ruby-value">120</span>).<span class="ruby-identifier">group_by_day</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:forecast_datetime</span>)
        <span class="ruby-identifier">ch</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">time</span>,<span class="ruby-identifier">fds</span><span class="ruby-operator">|</span>
                <span class="ruby-identifier">t</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>
                <span class="ruby-keyword">if</span> <span class="ruby-identifier">time</span> <span class="ruby-operator">&gt;</span> <span class="ruby-constant">Time</span>.<span class="ruby-identifier">local</span>(<span class="ruby-identifier">t</span>.<span class="ruby-identifier">year</span>,<span class="ruby-identifier">t</span>.<span class="ruby-identifier">month</span>,<span class="ruby-identifier">t</span>.<span class="ruby-identifier">day</span>)
                        <span class="ruby-comment">#if time &gt;= Time.local(2015,4,24)</span>
                        <span class="ruby-identifier">sum</span> = []
                        <span class="ruby-identifier">fds</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">fd</span><span class="ruby-operator">|</span>
                                <span class="ruby-identifier">sum</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">fd</span>.<span class="ruby-constant">AQI</span>
                        <span class="ruby-keyword">end</span>
                        <span class="ruby-identifier">aqis</span> <span class="ruby-operator">&lt;&lt;</span> [<span class="ruby-identifier">sum</span>.<span class="ruby-identifier">min</span>, <span class="ruby-identifier">sum</span>.<span class="ruby-identifier">max</span>]
                        <span class="ruby-identifier">pri_pol</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">fds</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">main_pol</span>
                <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">end</span>

        <span class="ruby-identifier">lev_hs</span> = {<span class="ruby-string">&quot;you&quot;</span>=<span class="ruby-operator">&gt;</span><span class="ruby-string">&quot;优&quot;</span>, <span class="ruby-string">&quot;yellow&quot;</span>=<span class="ruby-operator">&gt;</span><span class="ruby-string">&quot;良&quot;</span>, <span class="ruby-string">&quot;qingdu&quot;</span>=<span class="ruby-operator">&gt;</span><span class="ruby-string">&quot;轻度&quot;</span>, <span class="ruby-string">&quot;zhong&quot;</span>=<span class="ruby-operator">&gt;</span><span class="ruby-string">&quot;中度&quot;</span>,<span class="ruby-string">&quot;zhongdu&quot;</span>=<span class="ruby-operator">&gt;</span><span class="ruby-string">&quot;重度&quot;</span>, <span class="ruby-string">&quot;yanzhong&quot;</span>=<span class="ruby-operator">&gt;</span><span class="ruby-string">&quot;严重&quot;</span>}

        <span class="ruby-identifier">hs</span>[<span class="ruby-string">&quot;lev&quot;</span>] = <span class="ruby-identifier">get_lev</span>(<span class="ruby-identifier">hs</span>[<span class="ruby-string">&quot;aqi&quot;</span>])
        <span class="ruby-identifier">hs</span>[<span class="ruby-string">&quot;lev_han&quot;</span>] = <span class="ruby-identifier">lev_hs</span>[<span class="ruby-identifier">hs</span>[<span class="ruby-string">&quot;lev&quot;</span>]]

        <span class="ruby-identifier">lev_arr</span> = []
        <span class="ruby-identifier">lev_han_arr</span>= []
        <span class="ruby-identifier">aqis</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">aqi</span><span class="ruby-operator">|</span>
                <span class="ruby-identifier">lev_arr</span> <span class="ruby-operator">&lt;&lt;</span> {<span class="ruby-identifier">start</span><span class="ruby-value">:get_lev</span>(<span class="ruby-identifier">aqi</span>[<span class="ruby-value">0</span>]),<span class="ruby-keyword">end</span><span class="ruby-operator">:</span><span class="ruby-identifier">get_lev</span>(<span class="ruby-identifier">aqi</span>[<span class="ruby-value">1</span>])}
                <span class="ruby-identifier">lev_han_arr</span> <span class="ruby-operator">&lt;&lt;</span> {<span class="ruby-identifier">start</span><span class="ruby-value">:lev_hs</span>[<span class="ruby-identifier">get_lev</span>(<span class="ruby-identifier">aqi</span>[<span class="ruby-value">0</span>])],<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-bar" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">bar</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="bar-source">
            <pre><span class="ruby-comment"># File app/controllers/qinhuangdao_controller.rb, line 37</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">bar</span>
        <span class="ruby-ivar">@diff_monitor_forecast</span> = []
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:c</span>] 
                (<span class="ruby-identifier">id</span> =  <span class="ruby-identifier">params</span>[<span class="ruby-value">:c</span>][<span class="ruby-value">:city_id</span>]) 
        <span class="ruby-keyword">else</span>
                <span class="ruby-comment"># Table 1: 全国城市当天监测与预报日均值差值</span>
                (<span class="ruby-identifier">id</span> = <span class="ruby-constant">City</span>.<span class="ruby-identifier">find_by</span> <span class="ruby-identifier">city_name_pinyin</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;langfangshi&#39;</span>)
                <span class="ruby-identifier">monitor_today_avg</span> = <span class="ruby-constant">ChinaCitiesHour</span>.<span class="ruby-identifier">today_avg</span>
                <span class="ruby-identifier">forecast_today_avg</span> = <span class="ruby-constant">HourlyCityForecastAirQuality</span>.<span class="ruby-identifier">today_avg</span>
                <span class="ruby-identifier">monitor_today_avg</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">k</span>,<span class="ruby-identifier">v</span><span class="ruby-operator">|</span>
                        <span class="ruby-keyword">next</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">forecast_today_avg</span>[<span class="ruby-identifier">k</span>]
                        <span class="ruby-identifier">d</span> = <span class="ruby-identifier">monitor_today_avg</span>[<span class="ruby-identifier">k</span>] <span class="ruby-operator">-</span> <span class="ruby-identifier">forecast_today_avg</span>[<span class="ruby-identifier">k</span>].<span class="ruby-identifier">values</span>[<span class="ruby-value">0</span>]
                        <span class="ruby-ivar">@diff_monitor_forecast</span> <span class="ruby-operator">&lt;&lt;</span> [ <span class="ruby-identifier">k</span>, <span class="ruby-identifier">monitor_today_avg</span>[<span class="ruby-identifier">k</span>], <span class="ruby-identifier">forecast_today_avg</span>[<span class="ruby-identifier">k</span>].<span class="ruby-identifier">values</span>[<span class="ruby-value">0</span>], <span class="ruby-identifier">d</span>.<span class="ruby-identifier">abs</span>, <span class="ruby-identifier">forecast_today_avg</span>[<span class="ruby-identifier">k</span>].<span class="ruby-identifier">keys</span>[<span class="ruby-value">0</span>]]
                <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">end</span>

        <span class="ruby-comment"># Table 2: 城市监测与预报值小时值对比</span>
        <span class="ruby-identifier">c</span> = <span class="ruby-constant">City</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">id</span>)
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:start_date</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:end_date</span>]
                <span class="ruby-identifier">sd</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">local</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:start_date</span>][<span class="ruby-value">:year</span>].<span class="ruby-identifier">to_i</span>, <span class="ruby-identifier">params</span>[<span class="ruby-value">:start_date</span>][<span class="ruby-value">:month</span>].<span class="ruby-identifier">to_i</span>, <span class="ruby-identifier">params</span>[<span class="ruby-value">:start_date</span>][<span class="ruby-value">:day</span>].<span class="ruby-identifier">to_i</span>)
                <span class="ruby-identifier">ed</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">local</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:end_date</span>][<span class="ruby-value">:year</span>].<span class="ruby-identifier">to_i</span>, <span class="ruby-identifier">params</span>[<span class="ruby-value">:end_date</span>][<span class="ruby-value">:month</span>].<span class="ruby-identifier">to_i</span>, <span class="ruby-identifier">params</span>[<span class="ruby-value">:end_date</span>][<span class="ruby-value">:day</span>].<span class="ruby-identifier">to_i</span>,<span class="ruby-value">23</span>)
                <span class="ruby-keyword">return</span> <span class="ruby-string">&#39;error: start date can not later than end date!&#39;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">sd</span> <span class="ruby-operator">&gt;</span> <span class="ruby-identifier">ed</span>
                <span class="ruby-identifier">hss</span> = <span class="ruby-identifier">c</span>.<span class="ruby-identifier">hourly_city_forecast_air_qualities</span>.<span class="ruby-identifier">order</span>(<span class="ruby-value">:publish_datetime</span>).<span class="ruby-identifier">last</span>(<span class="ruby-value">120</span>)
                <span class="ruby-identifier">hs</span> = []
                <span class="ruby-identifier">hss</span>.<span class="ruby-identifier">each</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">h</span><span class="ruby-operator">|</span> <span class="ruby-identifier">hs</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">h</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">h</span>.<span class="ruby-identifier">forecast_datetime</span> <span class="ruby-operator">&gt;=</span> <span class="ruby-identifier">sd</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">h</span>.<span class="ruby-identifier">forecast_datetime</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-identifier">ed</span> }
        <span class="ruby-keyword">else</span>
                <span class="ruby-identifier">hs</span> = <span class="ruby-identifier">c</span>.<span class="ruby-identifier">hourly_city_forecast_air_qualities</span>.<span class="ruby-identifier">order</span>(<span class="ruby-value">:publish_datetime</span>).<span class="ruby-identifier">last</span>(<span class="ruby-value">120</span>)
        <span class="ruby-keyword">end</span> 

        <span class="ruby-identifier">md</span> = <span class="ruby-identifier">c</span>.<span class="ruby-identifier">china_cities_hours</span>.<span class="ruby-identifier">where</span>(<span class="ruby-identifier">data_real_time</span><span class="ruby-operator">:</span> <span class="ruby-constant">Time</span>.<span class="ruby-identifier">zone</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">beginning_of_day</span><span class="ruby-operator">..</span><span class="ruby-constant">Time</span>.<span class="ruby-identifier">zone</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">end_of_day</span>)
        <span class="ruby-ivar">@chart</span> = [{<span class="ruby-identifier">name</span><span class="ruby-operator">:</span> <span class="ruby-identifier">c</span>.<span class="ruby-identifier">city_name</span>, <span class="ruby-identifier">data</span><span class="ruby-operator">:</span> <span class="ruby-identifier">hs</span>.<span class="ruby-identifier">map</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">h</span><span class="ruby-operator">|</span> [ <span class="ruby-identifier">h</span>.<span class="ruby-identifier">forecast_datetime</span>,  <span class="ruby-identifier">h</span>.<span class="ruby-constant">AQI</span>]} }]
        <span class="ruby-ivar">@chart</span> <span class="ruby-operator">&lt;&lt;</span> {<span class="ruby-identifier">name</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;监测值&#39;</span>, <span class="ruby-identifier">data</span><span class="ruby-operator">:</span> <span class="ruby-identifier">md</span>.<span class="ruby-identifier">map</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">h</span><span class="ruby-operator">|</span> [ <span class="ruby-identifier">h</span>.<span class="ruby-identifier">data_real_time</span>,  <span class="ruby-identifier">h</span>.<span class="ruby-constant">AQI</span>] } }


        <span class="ruby-comment"># Table 3: 过去一星期城市监测与预报值日均值对比</span>
        <span class="ruby-ivar">@fore_group_day</span> = {}

        <span class="ruby-comment"># 获取过去几天的监测值</span>
        <span class="ruby-ivar">@fore_group_day</span> = <span class="ruby-constant">ChinaCitiesHour</span>.<span class="ruby-identifier">history_data</span>(<span class="ruby-identifier">c</span>, <span class="ruby-value">6</span>.<span class="ruby-identifier">days</span>.<span class="ruby-identifier">ago</span>.<span class="ruby-identifier">beginning_of_day</span>)

        <span class="ruby-comment"># 获取过去几天发布的预报值</span>
        <span class="ruby-identifier">md</span> = {}
        <span class="ruby-identifier">h</span> = <span class="ruby-identifier">c</span>.<span class="ruby-identifier">hourly_city_forecast_air_qualities</span>.<span class="ruby-identifier">group</span>(<span class="ruby-value">:publish_datetime</span>).<span class="ruby-identifier">having</span>(<span class="ruby-string">&quot;publish_datetime &gt;= ?&quot;</span>, <span class="ruby-value">6</span>.<span class="ruby-identifier">days</span>.<span class="ruby-identifier">ago</span>.<span class="ruby-identifier">beginning_of_day</span>).<span class="ruby-identifier">group_by_day</span>(<span class="ruby-value">:forecast_datetime</span>).<span class="ruby-identifier">average</span>(<span class="ruby-value">:AQI</span>)
        <span class="ruby-identifier">h</span>.<span class="ruby-identifier">each</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">k</span>,<span class="ruby-identifier">v</span><span class="ruby-operator">|</span> <span class="ruby-identifier">k</span>.<span class="ruby-identifier">map!</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">x</span><span class="ruby-operator">|</span> <span class="ruby-identifier">x</span>.<span class="ruby-identifier">strftime</span>(<span class="ruby-string">&quot;%d%b&quot;</span>)}; <span class="ruby-identifier">md</span>[<span class="ruby-identifier">k</span>] = <span class="ruby-identifier">v</span>.<span class="ruby-identifier">round</span>}

        <span class="ruby-ivar">@fore_group_day</span>.<span class="ruby-identifier">merge!</span>(<span class="ruby-identifier">md</span>)


        <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
                <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> { }
                <span class="ruby-identifier">format</span>.<span class="ruby-identifier">js</span>   { }
                <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> {
                        <span class="ruby-identifier">render</span> <span class="ruby-identifier">json</span><span class="ruby-operator">:</span> <span class="ruby-ivar">@diff_monitor_forecast</span>
                }
        <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-bdqx_compare" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">bdqx_compare</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="bdqx_compare-source">
            <pre><span class="ruby-comment"># File app/controllers/qinhuangdao_controller.rb, line 691</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">bdqx_compare</span>
        <span class="ruby-identifier">render</span> <span class="ruby-identifier">layout</span><span class="ruby-operator">:</span> <span class="ruby-identifier">getlayoutbyaction</span>(<span class="ruby-string">&#39;bdqx_compare&#39;</span>)
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-bdqx_compare_chart" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">bdqx_compare_chart</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="bdqx_compare_chart-source">
            <pre><span class="ruby-comment"># File app/controllers/qinhuangdao_controller.rb, line 257</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">bdqx_compare_chart</span>

        <span class="ruby-identifier">bdqx_monitorpoint</span>={<span class="ruby-string">&quot;白沟新城&quot;</span>=<span class="ruby-operator">&gt;</span><span class="ruby-string">&quot;白沟新城行政中心楼&quot;</span>,<span class="ruby-string">&quot;满城县&quot;</span>=<span class="ruby-operator">&gt;</span><span class="ruby-string">&quot;满城税务局&quot;</span>,<span class="ruby-string">&quot;清苑县&quot;</span>=<span class="ruby-operator">&gt;</span><span class="ruby-string">&quot;清苑县政府&quot;</span>,<span class="ruby-string">&quot;涞水县&quot;</span>=<span class="ruby-operator">&gt;</span><span class="ruby-string">&quot;涞水县环境监测站&quot;</span>,<span class="ruby-string">&quot;阜平县&quot;</span>=<span class="ruby-operator">&gt;</span><span class="ruby-string">&quot;阜平县环保局&quot;</span>,<span class="ruby-string">&quot;定兴县&quot;</span>=<span class="ruby-operator">&gt;</span><span class="ruby-string">&quot;定兴县政府&quot;</span>,<span class="ruby-string">&quot;高阳县&quot;</span>=<span class="ruby-operator">&gt;</span><span class="ruby-string">&quot;高阳县环保局&quot;</span>,<span class="ruby-string">&quot;容城县&quot;</span>=<span class="ruby-operator">&gt;</span><span class="ruby-string">&quot;容城县环境保护局&quot;</span>,<span class="ruby-string">&quot;涞源县&quot;</span>=<span class="ruby-operator">&gt;</span><span class="ruby-string">&quot;涞源县环保局&quot;</span>,<span class="ruby-string">&quot;望都县&quot;</span>=<span class="ruby-operator">&gt;</span><span class="ruby-string">&quot;望都县环境监测站&quot;</span>,<span class="ruby-string">&quot;安新县&quot;</span>=<span class="ruby-operator">&gt;</span><span class="ruby-string">&quot;安新民政局&quot;</span>,<span class="ruby-string">&quot;易县&quot;</span>=<span class="ruby-operator">&gt;</span><span class="ruby-string">&quot;易县环境保护局&quot;</span>,<span class="ruby-string">&quot;曲阳县&quot;</span>=<span class="ruby-operator">&gt;</span><span class="ruby-string">&quot;曲阳县环保局&quot;</span>,<span class="ruby-string">&quot;蠡县&quot;</span>=<span class="ruby-operator">&gt;</span><span class="ruby-string">&quot;蠡县县政府&quot;</span>,<span class="ruby-string">&quot;顺平县&quot;</span>=<span class="ruby-operator">&gt;</span><span class="ruby-string">&quot;顺平县环保局&quot;</span>,<span class="ruby-string">&quot;博野县&quot;</span>=<span class="ruby-operator">&gt;</span><span class="ruby-string">&quot;博野县招生办&quot;</span>,<span class="ruby-string">&quot;雄县&quot;</span>=<span class="ruby-operator">&gt;</span><span class="ruby-string">&quot;雄县环境保护局&quot;</span>,<span class="ruby-string">&quot;涿州市&quot;</span>=<span class="ruby-operator">&gt;</span><span class="ruby-string">&quot;涿州监测站&quot;</span>,<span class="ruby-string">&quot;安国市&quot;</span>=<span class="ruby-operator">&gt;</span><span class="ruby-string">&quot;安国市政府&quot;</span>,<span class="ruby-string">&quot;高碑店市&quot;</span>=<span class="ruby-operator">&gt;</span><span class="ruby-string">&quot;高碑店环保局&quot;</span>,<span class="ruby-string">&quot;徐水县&quot;</span>=<span class="ruby-operator">&gt;</span><span class="ruby-string">&quot;徐水环保局&quot;</span>,<span class="ruby-string">&quot;定州市&quot;</span>=<span class="ruby-operator">&gt;</span><span class="ruby-string">&quot;定州武装部&quot;</span>,<span class="ruby-string">&quot;唐县&quot;</span>=<span class="ruby-operator">&gt;</span><span class="ruby-string">&quot;唐县政府楼&quot;</span>}
        <span class="ruby-identifier">city1</span>=<span class="ruby-constant">City</span>.<span class="ruby-identifier">find_by</span> <span class="ruby-identifier">city_name</span><span class="ruby-operator">:</span> <span class="ruby-identifier">bdqx_monitorpoint</span>[<span class="ruby-identifier">params</span>[<span class="ruby-value">:city1</span>]]
        <span class="ruby-identifier">city2</span>=<span class="ruby-constant">City</span>.<span class="ruby-identifier">find_by</span> <span class="ruby-identifier">city_name</span><span class="ruby-operator">:</span> <span class="ruby-identifier">bdqx_monitorpoint</span>[<span class="ruby-identifier">params</span>[<span class="ruby-value">:city2</span>]]
        <span class="ruby-identifier">city3</span>=<span class="ruby-constant">City</span>.<span class="ruby-identifier">find_by</span> <span class="ruby-identifier">city_name</span><span class="ruby-operator">:</span> <span class="ruby-identifier">bdqx_monitorpoint</span>[<span class="ruby-identifier">params</span>[<span class="ruby-value">:city3</span>]]
        <span class="ruby-identifier">cityidarray</span>=<span class="ruby-constant">Array</span>[<span class="ruby-identifier">city1</span>.<span class="ruby-identifier">id</span>,<span class="ruby-identifier">city2</span>.<span class="ruby-identifier">id</span>,<span class="ruby-identifier">city3</span>.<span class="ruby-identifier">id</span>]
        <span class="ruby-identifier">startdate</span>=<span class="ruby-constant">Time</span>.<span class="ruby-identifier">local</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:startTime</span>][<span class="ruby-value">0</span>,<span class="ruby-value">4</span>].<span class="ruby-identifier">to_i</span>,<span class="ruby-identifier">params</span>[<span class="ruby-value">:startTime</span>][<span class="ruby-value">5</span>,<span class="ruby-value">2</span>].<span class="ruby-identifier">to_i</span>,<span class="ruby-identifier">params</span>[<span class="ruby-value">:startTime</span>][<span class="ruby-value">8</span>,<span class="ruby-value">2</span>].<span class="ruby-identifier">to_i</span>,<span class="ruby-value">0</span>)
        <span class="ruby-identifier">enddate</span>=<span class="ruby-constant">Time</span>.<span class="ruby-identifier">local</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:endTime</span>][<span class="ruby-value">0</span>,<span class="ruby-value">4</span>].<span class="ruby-identifier">to_i</span>,<span class="ruby-identifier">params</span>[<span class="ruby-value">:endTime</span>][<span class="ruby-value">5</span>,<span class="ruby-value">2</span>].<span class="ruby-identifier">to_i</span>,<span class="ruby-identifier">params</span>[<span class="ruby-value">:endTime</span>][<span class="ruby-value">8</span>,<span class="ruby-value">2</span>].<span class="ruby-identifier">to_i</span>,<span class="ruby-value">23</span>)
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:type</span>]<span class="ruby-operator">==</span><span class="ruby-string">&#39;HOUR&#39;</span>
                <span class="ruby-identifier">querydata</span>=<span class="ruby-constant">TempBdHour</span>.<span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;data_real_time&gt;=? AND data_real_time&lt;=? AND city_id IN (?,?,?)&quot;</span>,<span class="ruby-identifier">startdate</span>,<span class="ruby-identifier">enddate</span>,<span class="ruby-identifier">city1</span>.<span class="ruby-identifier">id</span>,<span class="ruby-identifier">city2</span>.<span class="ruby-identifier">id</span>,<span class="ruby-identifier">city3</span>.<span class="ruby-identifier">id</span>).<span class="ruby-identifier">order</span>(<span class="ruby-string">&#39;data_real_time asc&#39;</span>) 
        <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:type</span>]<span class="ruby-operator">==</span><span class="ruby-string">&#39;DAY&#39;</span>
                <span class="ruby-identifier">querydata</span>=<span class="ruby-constant">TempBdDay</span>.<span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;data_real_time&gt;=? AND data_real_time&lt;=? AND city_id IN (?,?,?)&quot;</span>,<span class="ruby-identifier">startdate</span>,<span class="ruby-identifier">enddate</span>,<span class="ruby-identifier">city1</span>.<span class="ruby-identifier">id</span>,<span class="ruby-identifier">city2</span>.<span class="ruby-identifier">id</span>,<span class="ruby-identifier">city3</span>.<span class="ruby-identifier">id</span>).<span class="ruby-identifier">order</span>(<span class="ruby-string">&#39;data_real_time asc&#39;</span>)
        <span class="ruby-keyword">else</span>
                <span class="ruby-identifier">querydata</span>=<span class="ruby-constant">TempBdMonth</span>.<span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;data_real_time&gt;=? AND data_real_time&lt;=? AND city_id IN (?,?,?)&quot;</span>,<span class="ruby-identifier">startdate</span>,<span class="ruby-identifier">enddate</span>,<span class="ruby-identifier">city1</span>.<span class="ruby-identifier">id</span>,<span class="ruby-identifier">city2</span>.<span class="ruby-identifier">id</span>,<span class="ruby-identifier">city3</span>.<span class="ruby-identifier">id</span>).<span class="ruby-identifier">order</span>(<span class="ruby-string">&#39;data_real_time asc&#39;</span>)      
        <span class="ruby-keyword">end</span>  
        <span class="ruby-ivar">@bdqxcompare</span>={<span class="ruby-identifier">citynum</span><span class="ruby-operator">:</span> <span class="ruby-identifier">cityidarray</span>,<span class="ruby-identifier">rows</span><span class="ruby-operator">:</span> <span class="ruby-identifier">querydata</span>.<span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">data</span><span class="ruby-operator">|</span> { <span class="ruby-identifier">alldata</span><span class="ruby-operator">:</span> <span class="ruby-identifier">data</span>,<span class="ruby-identifier">timeformatted</span><span class="ruby-operator">:</span> <span class="ruby-identifier">data</span>.<span class="ruby-identifier">data_real_time</span>.<span class="ruby-identifier">strftime</span>(<span class="ruby-string">&quot;%Y-%m-%d %H:%M:%S&quot;</span>)}}}
        <span class="ruby-comment">#pp querydata.map{ |data| data.city_id}.uniq.length</span>
        <span class="ruby-comment">#pp @citycompare</span>
        <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
                <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> { }
                <span class="ruby-identifier">format</span>.<span class="ruby-identifier">js</span>   { }
                <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> {
                        <span class="ruby-identifier">render</span> <span class="ruby-identifier">json</span><span class="ruby-operator">:</span> <span class="ruby-ivar">@bdqxcompare</span>
                }
        <span class="ruby-keyword">end</span>    
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-cal_var" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">cal_var</span><span
            class="method-args">( ncfile, var_name )</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="cal_var-source">
            <pre><span class="ruby-comment"># File app/controllers/qinhuangdao_controller.rb, line 630</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">cal_var</span> ( <span class="ruby-identifier">ncfile</span>, <span class="ruby-identifier">var_name</span> )
        <span class="ruby-identifier">pl</span> = <span class="ruby-constant">Array</span>.<span class="ruby-identifier">new</span>
        <span class="ruby-constant">CITY_LIST</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">city_file</span><span class="ruby-operator">|</span>
                <span class="ruby-identifier">pl</span> <span class="ruby-operator">&lt;&lt;</span> (<span class="ruby-identifier">read_adj</span> <span class="ruby-identifier">ncfile</span>, <span class="ruby-identifier">city_file</span>, <span class="ruby-identifier">var_name</span>)
        }
        <span class="ruby-keyword">return</span> <span class="ruby-identifier">pl</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-change_74_main_pol" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">change_74_main_pol</span><span
            class="method-args">(hs)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>修改74城市首要污染物</p>
          
          

          
          <div class="method-source-code" id="change_74_main_pol-source">
            <pre><span class="ruby-comment"># File app/controllers/qinhuangdao_controller.rb, line 330</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">change_74_main_pol</span>(<span class="ruby-identifier">hs</span>)
        <span class="ruby-identifier">main_pol</span>={<span class="ruby-string">&quot;二氧化氮&quot;</span>=<span class="ruby-operator">&gt;</span><span class="ruby-string">&quot;NO2&quot;</span>,<span class="ruby-string">&quot;臭氧8小时&quot;</span>=<span class="ruby-operator">&gt;</span><span class="ruby-string">&quot;O3&quot;</span>,<span class="ruby-string">&quot;二氧化硫&quot;</span>=<span class="ruby-operator">&gt;</span><span class="ruby-string">&quot;SO2&quot;</span>,<span class="ruby-string">&quot;一氧化碳&quot;</span>=<span class="ruby-operator">&gt;</span><span class="ruby-string">&quot;CO&quot;</span>,<span class="ruby-string">&quot;细颗粒物&quot;</span>=<span class="ruby-operator">&gt;</span><span class="ruby-string">&quot;PM2.5&quot;</span>,<span class="ruby-string">&quot;颗粒物&quot;</span>=<span class="ruby-operator">&gt;</span><span class="ruby-string">&quot;PM10&quot;</span>}
        <span class="ruby-keyword">for</span> <span class="ruby-identifier">i</span> <span class="ruby-keyword">in</span> (<span class="ruby-value">0</span><span class="ruby-operator">...</span><span class="ruby-identifier">hs</span>.<span class="ruby-identifier">length</span>)
                <span class="ruby-identifier">tmp</span> = <span class="ruby-string">&#39;&#39;</span>
                <span class="ruby-identifier">n</span> = <span class="ruby-value">0</span> 
                <span class="ruby-identifier">main_pol</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">key</span>,<span class="ruby-identifier">value</span><span class="ruby-operator">|</span>
                        <span class="ruby-keyword">if</span> <span class="ruby-node">/\w*(#{key})\w*/</span>.<span class="ruby-identifier">match</span>(<span class="ruby-identifier">hs</span>[<span class="ruby-identifier">i</span>][<span class="ruby-string">&#39;main_pol&#39;</span>])
                                <span class="ruby-identifier">tmp</span> <span class="ruby-operator">+=</span> <span class="ruby-string">&quot;,&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">n</span> <span class="ruby-operator">!=</span> <span class="ruby-value">0</span>
                                <span class="ruby-identifier">tmp</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">value</span>
                                <span class="ruby-identifier">n</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
                        <span class="ruby-keyword">end</span>
                <span class="ruby-keyword">end</span>
                <span class="ruby-identifier">hs</span>[<span class="ruby-identifier">i</span>][<span class="ruby-string">&#39;main_pol&#39;</span>] = <span class="ruby-identifier">tmp</span>
        <span class="ruby-keyword">end</span>           
        <span class="ruby-identifier">hs</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-change_data_type" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">change_data_type</span><span
            class="method-args">(data)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>修改小数点位数</p>
          
          

          
          <div class="method-source-code" id="change_data_type-source">
            <pre><span class="ruby-comment"># File app/controllers/qinhuangdao_controller.rb, line 367</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">change_data_type</span>(<span class="ruby-identifier">data</span>)                     
        <span class="ruby-identifier">float_round</span>={<span class="ruby-string">&quot;SO2&quot;</span>=<span class="ruby-operator">&gt;</span><span class="ruby-value">0</span>,<span class="ruby-string">&quot;NO2&quot;</span>=<span class="ruby-operator">&gt;</span><span class="ruby-value">0</span>,<span class="ruby-string">&quot;CO&quot;</span>=<span class="ruby-operator">&gt;</span><span class="ruby-value">1</span>,<span class="ruby-string">&quot;O3&quot;</span>=<span class="ruby-operator">&gt;</span><span class="ruby-value">0</span>,<span class="ruby-string">&quot;pm10&quot;</span>=<span class="ruby-operator">&gt;</span><span class="ruby-value">0</span>,<span class="ruby-string">&quot;pm25&quot;</span>=<span class="ruby-operator">&gt;</span><span class="ruby-value">0</span>,<span class="ruby-string">&quot;zonghezhishu&quot;</span>=<span class="ruby-operator">&gt;</span><span class="ruby-value">2</span>,<span class="ruby-string">&quot;AQI&quot;</span>=<span class="ruby-operator">&gt;</span><span class="ruby-value">0</span>,
                   <span class="ruby-string">&quot;SO2_change_rate&quot;</span>=<span class="ruby-operator">&gt;</span><span class="ruby-value">4</span>,<span class="ruby-string">&quot;NO2_change_rate&quot;</span>=<span class="ruby-operator">&gt;</span><span class="ruby-value">4</span>,<span class="ruby-string">&quot;CO_change_rate&quot;</span>=<span class="ruby-operator">&gt;</span><span class="ruby-value">4</span>,<span class="ruby-string">&quot;O3_change_rate&quot;</span>=<span class="ruby-operator">&gt;</span><span class="ruby-value">4</span>,<span class="ruby-string">&quot;pm10_change_rate&quot;</span>=<span class="ruby-operator">&gt;</span><span class="ruby-value">4</span>,
                   <span class="ruby-string">&quot;pm25_change_rate&quot;</span>=<span class="ruby-operator">&gt;</span><span class="ruby-value">4</span>,<span class="ruby-string">&quot;zongheindex_change_rate&quot;</span>=<span class="ruby-operator">&gt;</span><span class="ruby-value">4</span>}
        <span class="ruby-identifier">model_column</span>=<span class="ruby-constant">Array</span>[<span class="ruby-string">&#39;level&#39;</span>,<span class="ruby-string">&#39;main_pol&#39;</span>,<span class="ruby-string">&#39;data_real_time&#39;</span>,<span class="ruby-string">&#39;maxindex&#39;</span>]

        <span class="ruby-identifier">data_ary</span>=<span class="ruby-constant">Array</span>.<span class="ruby-identifier">new</span>
        (<span class="ruby-value">0</span><span class="ruby-operator">...</span><span class="ruby-identifier">data</span>.<span class="ruby-identifier">length</span>).<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span>
                <span class="ruby-identifier">data_hash</span>=<span class="ruby-constant">Hash</span>.<span class="ruby-identifier">new</span>
                <span class="ruby-identifier">data_hash</span>[<span class="ruby-string">&#39;city&#39;</span>]=<span class="ruby-constant">City</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">data</span>[<span class="ruby-identifier">t</span>].<span class="ruby-identifier">city_id</span>).<span class="ruby-identifier">city_name</span>
                <span class="ruby-identifier">float_round</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">k</span>,<span class="ruby-identifier">v</span><span class="ruby-operator">|</span>
                        <span class="ruby-keyword">if</span> <span class="ruby-regexp">/change_rate/</span>.<span class="ruby-identifier">match</span>(<span class="ruby-identifier">k</span>)
                                <span class="ruby-identifier">d</span>=<span class="ruby-node">&quot;%.#{v}f&quot;</span><span class="ruby-operator">%</span><span class="ruby-identifier">data</span>[<span class="ruby-identifier">t</span>][<span class="ruby-identifier">k</span>].<span class="ruby-identifier">to_f</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">data</span>[<span class="ruby-identifier">t</span>].<span class="ruby-identifier">respond_to?</span>(<span class="ruby-identifier">k</span>)
                                <span class="ruby-identifier">d</span>.<span class="ruby-identifier">to_f</span><span class="ruby-operator">&gt;</span><span class="ruby-value">0</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">data_hash</span>[<span class="ruby-string">&#39;img&#39;</span>]=<span class="ruby-string">&#39;arrow_up&#39;</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">data_hash</span>[<span class="ruby-string">&#39;img&#39;</span>]=<span class="ruby-string">&#39;arrow_down&#39;</span>
                                <span class="ruby-identifier">data_hash</span>[<span class="ruby-identifier">k</span>]=(<span class="ruby-identifier">d</span>.<span class="ruby-identifier">to_f</span><span class="ruby-operator">*</span><span class="ruby-value">100</span>).<span class="ruby-identifier">abs</span>.<span class="ruby-identifier">round</span>(<span class="ruby-identifier">v</span>).<span class="ruby-identifier">to_s</span>
                        <span class="ruby-keyword">else</span>
                                <span class="ruby-identifier">data_hash</span>[<span class="ruby-identifier">k</span>]=<span class="ruby-node">&quot;%.#{v}f&quot;</span><span class="ruby-operator">%</span><span class="ruby-identifier">data</span>[<span class="ruby-identifier">t</span>][<span class="ruby-identifier">k</span>].<span class="ruby-identifier">to_f</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">data</span>[<span class="ruby-identifier">t</span>].<span class="ruby-identifier">respond_to?</span>(<span class="ruby-identifier">k</span>)
                        <span class="ruby-keyword">end</span>
                <span class="ruby-keyword">end</span>
                <span class="ruby-identifier">model_column</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
                        <span class="ruby-identifier">data_hash</span>[<span class="ruby-identifier">i</span>]=<span class="ruby-identifier">data</span>[<span class="ruby-identifier">t</span>][<span class="ruby-identifier">i</span>]
                <span class="ruby-keyword">end</span>
                <span class="ruby-identifier">data_ary</span>[<span class="ruby-identifier">t</span>]=<span class="ruby-identifier">data_hash</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-identifier">re_hs</span>=<span class="ruby-constant">Hash</span>.<span class="ruby-identifier">new</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">data</span>[<span class="ruby-value">0</span>]
                <span class="ruby-identifier">re_hs</span>[<span class="ruby-value">:time</span>]=<span class="ruby-identifier">data</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">data_real_time</span>
        <span class="ruby-keyword">else</span>
                <span class="ruby-identifier">re_hs</span>[<span class="ruby-value">:time</span>]=<span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-identifier">re_hs</span>[<span class="ruby-value">:cities</span>]=<span class="ruby-identifier">data_ary</span>
        <span class="ruby-identifier">re_hs</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-chartway" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">chartway</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>1.三组按钮组间关系：根据三组按钮之间的关系确定编程顺序，先通过判断按天还是按小时从而确定查询天表还是小时表
然后，通过第二组按钮最近一天、最近一周等等确定startdate和enddate今儿去卡记录数 最后，通过第一组按钮确定要显示的字段。
2.三组按钮组内关系：第一组：“综合”显示AQI和其他的一堆，“AQI”只显示AQI，“PM2.5”~“湿度”这些显示AQI和本身
第二组和第三组：如果选中“最近一天”则无论是按天还是按小时均按小时显示曲线图，如果选中“最近一周”、“最近一月”、“最近一年”则按天与按小时显示的图不同</p>
          
          

          
          <div class="method-source-code" id="chartway-source">
            <pre><span class="ruby-comment"># File app/controllers/qinhuangdao_controller.rb, line 185</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">chartway</span>
        <span class="ruby-identifier">citybd</span>=<span class="ruby-constant">City</span>.<span class="ruby-identifier">find_by</span> <span class="ruby-identifier">city_name</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;保定市&#39;</span>
        <span class="ruby-identifier">startdate</span>=<span class="ruby-constant">Time</span>.<span class="ruby-identifier">local</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:starttime</span>][<span class="ruby-value">0</span>,<span class="ruby-value">4</span>].<span class="ruby-identifier">to_i</span>,<span class="ruby-identifier">params</span>[<span class="ruby-value">:starttime</span>][<span class="ruby-value">5</span>,<span class="ruby-value">2</span>].<span class="ruby-identifier">to_i</span>,<span class="ruby-identifier">params</span>[<span class="ruby-value">:starttime</span>][<span class="ruby-value">8</span>,<span class="ruby-value">2</span>].<span class="ruby-identifier">to_i</span>)
        <span class="ruby-identifier">enddate</span>=<span class="ruby-constant">Time</span>.<span class="ruby-identifier">local</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:endtime</span>][<span class="ruby-value">0</span>,<span class="ruby-value">4</span>].<span class="ruby-identifier">to_i</span>,<span class="ruby-identifier">params</span>[<span class="ruby-value">:endtime</span>][<span class="ruby-value">5</span>,<span class="ruby-value">2</span>].<span class="ruby-identifier">to_i</span>,<span class="ruby-identifier">params</span>[<span class="ruby-value">:endtime</span>][<span class="ruby-value">8</span>,<span class="ruby-value">2</span>].<span class="ruby-identifier">to_i</span>,<span class="ruby-value">23</span>)
        <span class="ruby-keyword">if</span>  <span class="ruby-identifier">params</span>[<span class="ruby-value">:starttime</span>]<span class="ruby-operator">==</span><span class="ruby-identifier">params</span>[<span class="ruby-value">:endtime</span>] 
                <span class="ruby-identifier">startdate</span>=<span class="ruby-constant">Time</span>.<span class="ruby-identifier">local</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:starttime</span>][<span class="ruby-value">0</span>,<span class="ruby-value">4</span>].<span class="ruby-identifier">to_i</span>,<span class="ruby-identifier">params</span>[<span class="ruby-value">:starttime</span>][<span class="ruby-value">5</span>,<span class="ruby-value">2</span>].<span class="ruby-identifier">to_i</span>,<span class="ruby-identifier">params</span>[<span class="ruby-value">:starttime</span>][<span class="ruby-value">8</span>,<span class="ruby-value">2</span>].<span class="ruby-identifier">to_i</span>)
                <span class="ruby-identifier">enddate</span>=<span class="ruby-constant">Time</span>.<span class="ruby-identifier">local</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:endtime</span>][<span class="ruby-value">0</span>,<span class="ruby-value">4</span>].<span class="ruby-identifier">to_i</span>,<span class="ruby-identifier">params</span>[<span class="ruby-value">:endtime</span>][<span class="ruby-value">5</span>,<span class="ruby-value">2</span>].<span class="ruby-identifier">to_i</span>,<span class="ruby-identifier">params</span>[<span class="ruby-value">:endtime</span>][<span class="ruby-value">8</span>,<span class="ruby-value">2</span>].<span class="ruby-identifier">to_i</span>,<span class="ruby-value">23</span>)
                <span class="ruby-identifier">querydata</span>=<span class="ruby-constant">TempSfcitiesHour</span>.<span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;data_real_time&gt;=? AND data_real_time&lt;=? AND city_id=?&quot;</span>,<span class="ruby-identifier">startdate</span>,<span class="ruby-identifier">enddate</span>,<span class="ruby-identifier">citybd</span>.<span class="ruby-identifier">id</span>)
        <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:exact</span>]<span class="ruby-operator">==</span><span class="ruby-string">&#39;eh&#39;</span>
                <span class="ruby-identifier">querydata</span>=<span class="ruby-constant">TempSfcitiesHour</span>.<span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;data_real_time&gt;=? AND data_real_time&lt;=? AND city_id=?&quot;</span>,<span class="ruby-identifier">startdate</span>,<span class="ruby-identifier">enddate</span>,<span class="ruby-identifier">citybd</span>.<span class="ruby-identifier">id</span>) 
        <span class="ruby-keyword">else</span>
                <span class="ruby-identifier">querydata</span>=<span class="ruby-constant">TempSfcitiesDay</span>.<span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;data_real_time&gt;=? AND data_real_time&lt;=? AND city_id=?&quot;</span>,<span class="ruby-identifier">startdate</span>,<span class="ruby-identifier">enddate</span>,<span class="ruby-identifier">citybd</span>.<span class="ruby-identifier">id</span>)
        <span class="ruby-keyword">end</span>  
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:type</span>]<span class="ruby-operator">==</span><span class="ruby-string">&#39;zonghe&#39;</span>
                <span class="ruby-ivar">@chartdata</span>={<span class="ruby-identifier">categories</span><span class="ruby-operator">:</span> <span class="ruby-identifier">querydata</span>.<span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">data</span><span class="ruby-operator">|</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:exact</span>]<span class="ruby-operator">==</span><span class="ruby-string">&#39;eh&#39;</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">data</span>.<span class="ruby-identifier">data_real_time</span>.<span class="ruby-identifier">strftime</span>(<span class="ruby-string">&quot;%m-%d %H&quot;</span>) <span class="ruby-operator">:</span> <span class="ruby-identifier">data</span>.<span class="ruby-identifier">data_real_time</span>.<span class="ruby-identifier">strftime</span>(<span class="ruby-string">&quot;%Y-%m-%d&quot;</span>)}, <span class="ruby-identifier">series</span><span class="ruby-operator">:</span> [{<span class="ruby-identifier">name</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;AQI&#39;</span>,<span class="ruby-identifier">data</span><span class="ruby-operator">:</span> <span class="ruby-identifier">querydata</span>.<span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">data</span><span class="ruby-operator">|</span> <span class="ruby-identifier">data</span>.<span class="ruby-constant">AQI</span>}},{<span class="ruby-identifier">name</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;PM2.5(μg/m3)&#39;</span>,<span class="ruby-identifier">data</span><span class="ruby-operator">:</span> <span class="ruby-identifier">querydata</span>.<span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">data</span><span class="ruby-operator">|</span> <span class="ruby-identifier">data</span>.<span class="ruby-identifier">pm25</span>}},{<span class="ruby-identifier">name</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;PM10(μg/m3)&#39;</span>,<span class="ruby-identifier">data</span><span class="ruby-operator">:</span> <span class="ruby-identifier">querydata</span>.<span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">data</span><span class="ruby-operator">|</span> <span class="ruby-identifier">data</span>.<span class="ruby-identifier">pm10</span>}},{<span class="ruby-identifier">name</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;SO2(μg/m3)&#39;</span>,<span class="ruby-identifier">data</span><span class="ruby-operator">:</span> <span class="ruby-identifier">querydata</span>.<span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">data</span><span class="ruby-operator">|</span> <span class="ruby-identifier">data</span>.<span class="ruby-constant">SO2</span>}},{<span class="ruby-identifier">name</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;CO(mg/m3)&#39;</span>,<span class="ruby-identifier">data</span><span class="ruby-operator">:</span> <span class="ruby-identifier">querydata</span>.<span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">data</span><span class="ruby-operator">|</span> <span class="ruby-identifier">data</span>.<span class="ruby-constant">CO</span>}},{<span class="ruby-identifier">name</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;NO2(μg/m3)&#39;</span>,<span class="ruby-identifier">data</span><span class="ruby-operator">:</span> <span class="ruby-identifier">querydata</span>.<span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">data</span><span class="ruby-operator">|</span> <span class="ruby-identifier">data</span>.<span class="ruby-constant">NO2</span>}},{<span class="ruby-identifier">name</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;O3(μg/m3)&#39;</span>,<span class="ruby-identifier">data</span><span class="ruby-operator">:</span> <span class="ruby-identifier">querydata</span>.<span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">data</span><span class="ruby-operator">|</span> <span class="ruby-identifier">data</span>.<span class="ruby-constant">O3</span>}}]}
        <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:type</span>]<span class="ruby-operator">==</span><span class="ruby-string">&#39;PM25&#39;</span>
                <span class="ruby-ivar">@chartdata</span>={<span class="ruby-identifier">categories</span><span class="ruby-operator">:</span> <span class="ruby-identifier">querydata</span>.<span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">data</span><span class="ruby-operator">|</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:exact</span>]<span class="ruby-operator">==</span><span class="ruby-string">&#39;eh&#39;</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">data</span>.<span class="ruby-identifier">data_real_time</span>.<span class="ruby-identifier">strftime</span>(<span class="ruby-string">&quot;%m-%d %H&quot;</span>) <span class="ruby-operator">:</span> <span class="ruby-identifier">data</span>.<span class="ruby-identifier">data_real_time</span>.<span class="ruby-identifier">strftime</span>(<span class="ruby-string">&quot;%Y-%m-%d&quot;</span>)}, <span class="ruby-identifier">series</span><span class="ruby-operator">:</span> [{<span class="ruby-identifier">name</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;AQI&#39;</span>,<span class="ruby-identifier">data</span><span class="ruby-operator">:</span> <span class="ruby-identifier">querydata</span>.<span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">data</span><span class="ruby-operator">|</span> <span class="ruby-identifier">data</span>.<span class="ruby-constant">AQI</span>}},{<span class="ruby-identifier">name</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;PM2.5(μg/m3)&#39;</span>,<span class="ruby-identifier">data</span><span class="ruby-operator">:</span> <span class="ruby-identifier">querydata</span>.<span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">data</span><span class="ruby-operator">|</span> <span class="ruby-identifier">data</span>.<span class="ruby-identifier">pm25</span>}}]}
        <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:type</span>]<span class="ruby-operator">==</span><span class="ruby-string">&#39;PM10&#39;</span>
                <span class="ruby-ivar">@chartdata</span>={<span class="ruby-identifier">categories</span><span class="ruby-operator">:</span> <span class="ruby-identifier">querydata</span>.<span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">data</span><span class="ruby-operator">|</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:exact</span>]<span class="ruby-operator">==</span><span class="ruby-string">&#39;eh&#39;</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">data</span>.<span class="ruby-identifier">data_real_time</span>.<span class="ruby-identifier">strftime</span>(<span class="ruby-string">&quot;%m-%d %H&quot;</span>) <span class="ruby-operator">:</span> <span class="ruby-identifier">data</span>.<span class="ruby-identifier">data_real_time</span>.<span class="ruby-identifier">strftime</span>(<span class="ruby-string">&quot;%Y-%m-%d&quot;</span>)}, <span class="ruby-identifier">series</span><span class="ruby-operator">:</span> [{<span class="ruby-identifier">name</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;AQI&#39;</span>,<span class="ruby-identifier">data</span><span class="ruby-operator">:</span> <span class="ruby-identifier">querydata</span>.<span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">data</span><span class="ruby-operator">|</span> <span class="ruby-identifier">data</span>.<span class="ruby-constant">AQI</span>}},{<span class="ruby-identifier">name</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;PM10(μg/m3)&#39;</span>,<span class="ruby-identifier">data</span><span class="ruby-operator">:</span> <span class="ruby-identifier">querydata</span>.<span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">data</span><span class="ruby-operator">|</span> <span class="ruby-identifier">data</span>.<span class="ruby-identifier">pm10</span>}}]}
        <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:type</span>]<span class="ruby-operator">==</span><span class="ruby-string">&#39;SO2&#39;</span>
                <span class="ruby-ivar">@chartdata</span>={<span class="ruby-identifier">categories</span><span class="ruby-operator">:</span> <span class="ruby-identifier">querydata</span>.<span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">data</span><span class="ruby-operator">|</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:exact</span>]<span class="ruby-operator">==</span><span class="ruby-string">&#39;eh&#39;</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">data</span>.<span class="ruby-identifier">data_real_time</span>.<span class="ruby-identifier">strftime</span>(<span class="ruby-string">&quot;%m-%d %H&quot;</span>) <span class="ruby-operator">:</span> <span class="ruby-identifier">data</span>.<span class="ruby-identifier">data_real_time</span>.<span class="ruby-identifier">strftime</span>(<span class="ruby-string">&quot;%Y-%m-%d&quot;</span>)}, <span class="ruby-identifier">series</span><span class="ruby-operator">:</span> [{<span class="ruby-identifier">name</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;AQI&#39;</span>,<span class="ruby-identifier">data</span><span class="ruby-operator">:</span> <span class="ruby-identifier">querydata</span>.<span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">data</span><span class="ruby-operator">|</span> <span class="ruby-identifier">data</span>.<span class="ruby-constant">AQI</span>}},{<span class="ruby-identifier">name</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;SO2(μg/m3)&#39;</span>,<span class="ruby-identifier">data</span><span class="ruby-operator">:</span> <span class="ruby-identifier">querydata</span>.<span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">data</span><span class="ruby-operator">|</span> <span class="ruby-identifier">data</span>.<span class="ruby-constant">SO2</span>}}]}
        <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:type</span>]<span class="ruby-operator">==</span><span class="ruby-string">&#39;NO2&#39;</span>
                <span class="ruby-ivar">@chartdata</span>={<span class="ruby-identifier">categories</span><span class="ruby-operator">:</span> <span class="ruby-identifier">querydata</span>.<span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">data</span><span class="ruby-operator">|</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:exact</span>]<span class="ruby-operator">==</span><span class="ruby-string">&#39;eh&#39;</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">data</span>.<span class="ruby-identifier">data_real_time</span>.<span class="ruby-identifier">strftime</span>(<span class="ruby-string">&quot;%m-%d %H&quot;</span>) <span class="ruby-operator">:</span> <span class="ruby-identifier">data</span>.<span class="ruby-identifier">data_real_time</span>.<span class="ruby-identifier">strftime</span>(<span class="ruby-string">&quot;%Y-%m-%d&quot;</span>)}, <span class="ruby-identifier">series</span><span class="ruby-operator">:</span> [{<span class="ruby-identifier">name</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;AQI&#39;</span>,<span class="ruby-identifier">data</span><span class="ruby-operator">:</span> <span class="ruby-identifier">querydata</span>.<span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">data</span><span class="ruby-operator">|</span> <span class="ruby-identifier">data</span>.<span class="ruby-constant">AQI</span>}},{<span class="ruby-identifier">name</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;NO2(μg/m3)&#39;</span>,<span class="ruby-identifier">data</span><span class="ruby-operator">:</span> <span class="ruby-identifier">querydata</span>.<span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">data</span><span class="ruby-operator">|</span> <span class="ruby-identifier">data</span>.<span class="ruby-constant">NO2</span>}}]}
        <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:type</span>]<span class="ruby-operator">==</span><span class="ruby-string">&#39;CO&#39;</span>
                <span class="ruby-ivar">@chartdata</span>={<span class="ruby-identifier">categories</span><span class="ruby-operator">:</span> <span class="ruby-identifier">querydata</span>.<span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">data</span><span class="ruby-operator">|</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:exact</span>]<span class="ruby-operator">==</span><span class="ruby-string">&#39;eh&#39;</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">data</span>.<span class="ruby-identifier">data_real_time</span>.<span class="ruby-identifier">strftime</span>(<span class="ruby-string">&quot;%m-%d %H&quot;</span>) <span class="ruby-operator">:</span> <span class="ruby-identifier">data</span>.<span class="ruby-identifier">data_real_time</span>.<span class="ruby-identifier">strftime</span>(<span class="ruby-string">&quot;%Y-%m-%d&quot;</span>)}, <span class="ruby-identifier">series</span><span class="ruby-operator">:</span> [{<span class="ruby-identifier">name</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;AQI&#39;</span>,<span class="ruby-identifier">data</span><span class="ruby-operator">:</span> <span class="ruby-identifier">querydata</span>.<span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">data</span><span class="ruby-operator">|</span> <span class="ruby-identifier">data</span>.<span class="ruby-constant">AQI</span>}},{<span class="ruby-identifier">name</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;CO(mg/m3)&#39;</span>,<span class="ruby-identifier">data</span><span class="ruby-operator">:</span> <span class="ruby-identifier">querydata</span>.<span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">data</span><span class="ruby-operator">|</span> <span class="ruby-identifier">data</span>.<span class="ruby-constant">CO</span>}}]}
        <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:type</span>]<span class="ruby-operator">==</span><span class="ruby-string">&#39;O3&#39;</span>
                <span class="ruby-ivar">@chartdata</span>={<span class="ruby-identifier">categories</span><span class="ruby-operator">:</span> <span class="ruby-identifier">querydata</span>.<span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">data</span><span class="ruby-operator">|</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:exact</span>]<span class="ruby-operator">==</span><span class="ruby-string">&#39;eh&#39;</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">data</span>.<span class="ruby-identifier">data_real_time</span>.<span class="ruby-identifier">strftime</span>(<span class="ruby-string">&quot;%m-%d %H&quot;</span>) <span class="ruby-operator">:</span> <span class="ruby-identifier">data</span>.<span class="ruby-identifier">data_real_time</span>.<span class="ruby-identifier">strftime</span>(<span class="ruby-string">&quot;%Y-%m-%d&quot;</span>)}, <span class="ruby-identifier">series</span><span class="ruby-operator">:</span> [{<span class="ruby-identifier">name</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;AQI&#39;</span>,<span class="ruby-identifier">data</span><span class="ruby-operator">:</span> <span class="ruby-identifier">querydata</span>.<span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">data</span><span class="ruby-operator">|</span> <span class="ruby-identifier">data</span>.<span class="ruby-constant">AQI</span>}},{<span class="ruby-identifier">name</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;O3(μg/m3)&#39;</span>,<span class="ruby-identifier">data</span><span class="ruby-operator">:</span> <span class="ruby-identifier">querydata</span>.<span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">data</span><span class="ruby-operator">|</span> <span class="ruby-identifier">data</span>.<span class="ruby-constant">O3</span>}}]}
        <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:type</span>]<span class="ruby-operator">==</span><span class="ruby-string">&#39;tem&#39;</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:exact</span>]<span class="ruby-operator">==</span><span class="ruby-string">&#39;eh&#39;</span>
                <span class="ruby-ivar">@chartdata</span>={<span class="ruby-identifier">categories</span><span class="ruby-operator">:</span> <span class="ruby-identifier">querydata</span>.<span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">data</span><span class="ruby-operator">|</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:exact</span>]<span class="ruby-operator">==</span><span class="ruby-string">&#39;eh&#39;</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">data</span>.<span class="ruby-identifier">data_real_time</span>.<span class="ruby-identifier">strftime</span>(<span class="ruby-string">&quot;%m-%d %H&quot;</span>) <span class="ruby-operator">:</span> <span class="ruby-identifier">data</span>.<span class="ruby-identifier">data_real_time</span>.<span class="ruby-identifier">strftime</span>(<span class="ruby-string">&quot;%Y-%m-%d&quot;</span>)}, <span class="ruby-identifier">series</span><span class="ruby-operator">:</span> [{<span class="ruby-identifier">name</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;AQI&#39;</span>,<span class="ruby-identifier">data</span><span class="ruby-operator">:</span> <span class="ruby-identifier">querydata</span>.<span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">data</span><span class="ruby-operator">|</span> <span class="ruby-identifier">data</span>.<span class="ruby-constant">AQI</span>}},{<span class="ruby-identifier">name</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;温度(℃)&#39;</span>,<span class="ruby-identifier">data</span><span class="ruby-operator">:</span> <span class="ruby-identifier">querydata</span>.<span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">data</span><span class="ruby-operator">|</span> <span class="ruby-identifier">data</span>.<span class="ruby-identifier">temp</span>}}]}
        <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:type</span>]<span class="ruby-operator">==</span><span class="ruby-string">&#39;wind&#39;</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:exact</span>]<span class="ruby-operator">==</span><span class="ruby-string">&#39;eh&#39;</span>
                <span class="ruby-ivar">@chartdata</span>={<span class="ruby-identifier">categories</span><span class="ruby-operator">:</span> <span class="ruby-identifier">querydata</span>.<span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">data</span><span class="ruby-operator">|</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:exact</span>]<span class="ruby-operator">==</span><span class="ruby-string">&#39;eh&#39;</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">data</span>.<span class="ruby-identifier">data_real_time</span>.<span class="ruby-identifier">strftime</span>(<span class="ruby-string">&quot;%m-%d %H&quot;</span>) <span class="ruby-operator">:</span> <span class="ruby-identifier">data</span>.<span class="ruby-identifier">data_real_time</span>.<span class="ruby-identifier">strftime</span>(<span class="ruby-string">&quot;%Y-%m-%d&quot;</span>)}, <span class="ruby-identifier">series</span><span class="ruby-operator">:</span> [{<span class="ruby-identifier">name</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;AQI&#39;</span>,<span class="ruby-identifier">data</span><span class="ruby-operator">:</span> <span class="ruby-identifier">querydata</span>.<span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">data</span><span class="ruby-operator">|</span> <span class="ruby-identifier">data</span>.<span class="ruby-constant">AQI</span>}},{<span class="ruby-identifier">name</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;风速(级)&#39;</span>,<span class="ruby-identifier">data</span><span class="ruby-operator">:</span> <span class="ruby-identifier">querydata</span>.<span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">data</span><span class="ruby-operator">|</span> <span class="ruby-identifier">data</span>.<span class="ruby-identifier">windspeed</span>}}]}
        <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:type</span>]<span class="ruby-operator">==</span><span class="ruby-string">&#39;hum&#39;</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:exact</span>]<span class="ruby-operator">==</span><span class="ruby-string">&#39;eh&#39;</span>
                <span class="ruby-ivar">@chartdata</span>={<span class="ruby-identifier">categories</span><span class="ruby-operator">:</span> <span class="ruby-identifier">querydata</span>.<span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">data</span><span class="ruby-operator">|</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:exact</span>]<span class="ruby-operator">==</span><span class="ruby-string">&#39;eh&#39;</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">data</span>.<span class="ruby-identifier">data_real_time</span>.<span class="ruby-identifier">strftime</span>(<span class="ruby-string">&quot;%m-%d %H&quot;</span>) <span class="ruby-operator">:</span> <span class="ruby-identifier">data</span>.<span class="ruby-identifier">data_real_time</span>.<span class="ruby-identifier">strftime</span>(<span class="ruby-string">&quot;%Y-%m-%d&quot;</span>)}, <span class="ruby-identifier">series</span><span class="ruby-operator">:</span> [{<span class="ruby-identifier">name</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;AQI&#39;</span>,<span class="ruby-identifier">data</span><span class="ruby-operator">:</span> <span class="ruby-identifier">querydata</span>.<span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">data</span><span class="ruby-operator">|</span> <span class="ruby-identifier">data</span>.<span class="ruby-constant">AQI</span>}},{<span class="ruby-identifier">name</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;湿度(%)&#39;</span>,<span class="ruby-identifier">data</span><span class="ruby-operator">:</span> <span class="ruby-identifier">querydata</span>.<span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">data</span><span class="ruby-operator">|</span> <span class="ruby-identifier">data</span>.<span class="ruby-identifier">humi</span>}}]}
        <span class="ruby-keyword">else</span>
                <span class="ruby-ivar">@chartdata</span>={<span class="ruby-identifier">categories</span><span class="ruby-operator">:</span> <span class="ruby-identifier">querydata</span>.<span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">data</span><span class="ruby-operator">|</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:exact</span>]<span class="ruby-operator">==</span><span class="ruby-string">&#39;eh&#39;</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">data</span>.<span class="ruby-identifier">data_real_time</span>.<span class="ruby-identifier">strftime</span>(<span class="ruby-string">&quot;%m-%d %H&quot;</span>) <span class="ruby-operator">:</span> <span class="ruby-identifier">data</span>.<span class="ruby-identifier">data_real_time</span>.<span class="ruby-identifier">strftime</span>(<span class="ruby-string">&quot;%Y-%m-%d&quot;</span>)}, <span class="ruby-identifier">series</span><span class="ruby-operator">:</span> [{<span class="ruby-identifier">name</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;AQI&#39;</span>,<span class="ruby-identifier">data</span><span class="ruby-operator">:</span> <span class="ruby-identifier">querydata</span>.<span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">data</span><span class="ruby-operator">|</span> <span class="ruby-identifier">data</span>.<span class="ruby-constant">AQI</span>}}]}
        <span class="ruby-keyword">end</span>
        <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
                <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> { }
                <span class="ruby-identifier">format</span>.<span class="ruby-identifier">js</span>   { }
                <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> {
                        <span class="ruby-identifier">render</span> <span class="ruby-identifier">json</span><span class="ruby-operator">:</span> <span class="ruby-ivar">@chartdata</span>
                }
        <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-city_compare_chart" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">city_compare_chart</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="city_compare_chart-source">
            <pre><span class="ruby-comment"># File app/controllers/qinhuangdao_controller.rb, line 230</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">city_compare_chart</span>
        <span class="ruby-identifier">city1</span>=<span class="ruby-constant">City</span>.<span class="ruby-identifier">find_by</span> <span class="ruby-identifier">city_name</span><span class="ruby-operator">:</span> (<span class="ruby-identifier">params</span>[<span class="ruby-value">:city1</span>]<span class="ruby-operator">+</span><span class="ruby-string">&#39;市&#39;</span>)
        <span class="ruby-identifier">city2</span>=<span class="ruby-constant">City</span>.<span class="ruby-identifier">find_by</span> <span class="ruby-identifier">city_name</span><span class="ruby-operator">:</span> (<span class="ruby-identifier">params</span>[<span class="ruby-value">:city2</span>]<span class="ruby-operator">+</span><span class="ruby-string">&#39;市&#39;</span>)
        <span class="ruby-identifier">city3</span>=<span class="ruby-constant">City</span>.<span class="ruby-identifier">find_by</span> <span class="ruby-identifier">city_name</span><span class="ruby-operator">:</span> (<span class="ruby-identifier">params</span>[<span class="ruby-value">:city3</span>]<span class="ruby-operator">+</span><span class="ruby-string">&#39;市&#39;</span>)
        <span class="ruby-identifier">cityidarray</span>=<span class="ruby-constant">Array</span>[<span class="ruby-identifier">city1</span>.<span class="ruby-identifier">id</span>,<span class="ruby-identifier">city2</span>.<span class="ruby-identifier">id</span>,<span class="ruby-identifier">city3</span>.<span class="ruby-identifier">id</span>]
        <span class="ruby-identifier">startdate</span>=<span class="ruby-constant">Time</span>.<span class="ruby-identifier">local</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:startTime</span>][<span class="ruby-value">0</span>,<span class="ruby-value">4</span>].<span class="ruby-identifier">to_i</span>,<span class="ruby-identifier">params</span>[<span class="ruby-value">:startTime</span>][<span class="ruby-value">5</span>,<span class="ruby-value">2</span>].<span class="ruby-identifier">to_i</span>,<span class="ruby-identifier">params</span>[<span class="ruby-value">:startTime</span>][<span class="ruby-value">8</span>,<span class="ruby-value">2</span>].<span class="ruby-identifier">to_i</span>,<span class="ruby-value">0</span>)
        <span class="ruby-identifier">enddate</span>=<span class="ruby-constant">Time</span>.<span class="ruby-identifier">local</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:endTime</span>][<span class="ruby-value">0</span>,<span class="ruby-value">4</span>].<span class="ruby-identifier">to_i</span>,<span class="ruby-identifier">params</span>[<span class="ruby-value">:endTime</span>][<span class="ruby-value">5</span>,<span class="ruby-value">2</span>].<span class="ruby-identifier">to_i</span>,<span class="ruby-identifier">params</span>[<span class="ruby-value">:endTime</span>][<span class="ruby-value">8</span>,<span class="ruby-value">2</span>].<span class="ruby-identifier">to_i</span>,<span class="ruby-value">23</span>)
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:type</span>]<span class="ruby-operator">==</span><span class="ruby-string">&#39;HOUR&#39;</span>
                <span class="ruby-identifier">querydata</span>=<span class="ruby-constant">TempSfcitiesHour</span>.<span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;data_real_time&gt;=? AND data_real_time&lt;=? AND city_id IN (?,?,?)&quot;</span>,<span class="ruby-identifier">startdate</span>,<span class="ruby-identifier">enddate</span>,<span class="ruby-identifier">city1</span>.<span class="ruby-identifier">id</span>,<span class="ruby-identifier">city2</span>.<span class="ruby-identifier">id</span>,<span class="ruby-identifier">city3</span>.<span class="ruby-identifier">id</span>).<span class="ruby-identifier">order</span>(<span class="ruby-string">&#39;data_real_time asc&#39;</span>) 
        <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:type</span>]<span class="ruby-operator">==</span><span class="ruby-string">&#39;DAY&#39;</span>
                <span class="ruby-identifier">querydata</span>=<span class="ruby-constant">TempSfcitiesDay</span>.<span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;data_real_time&gt;=? AND data_real_time&lt;=? AND city_id IN (?,?,?)&quot;</span>,<span class="ruby-identifier">startdate</span>,<span class="ruby-identifier">enddate</span>,<span class="ruby-identifier">city1</span>.<span class="ruby-identifier">id</span>,<span class="ruby-identifier">city2</span>.<span class="ruby-identifier">id</span>,<span class="ruby-identifier">city3</span>.<span class="ruby-identifier">id</span>).<span class="ruby-identifier">order</span>(<span class="ruby-string">&#39;data_real_time asc&#39;</span>)
        <span class="ruby-keyword">else</span>
                <span class="ruby-identifier">querydata</span>=<span class="ruby-constant">TempSfcitiesMonth</span>.<span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;data_real_time&gt;=? AND data_real_time&lt;=? AND city_id IN (?,?,?)&quot;</span>,<span class="ruby-identifier">startdate</span>,<span class="ruby-identifier">enddate</span>,<span class="ruby-identifier">city1</span>.<span class="ruby-identifier">id</span>,<span class="ruby-identifier">city2</span>.<span class="ruby-identifier">id</span>,<span class="ruby-identifier">city3</span>.<span class="ruby-identifier">id</span>).<span class="ruby-identifier">order</span>(<span class="ruby-string">&#39;data_real_time asc&#39;</span>)      
        <span class="ruby-keyword">end</span>  
        <span class="ruby-ivar">@citycompare</span>={<span class="ruby-identifier">citynum</span><span class="ruby-operator">:</span> <span class="ruby-identifier">cityidarray</span>,<span class="ruby-identifier">rows</span><span class="ruby-operator">:</span> <span class="ruby-identifier">querydata</span>.<span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">data</span><span class="ruby-operator">|</span> { <span class="ruby-identifier">alldata</span><span class="ruby-operator">:</span> <span class="ruby-identifier">data</span>,<span class="ruby-identifier">timeformatted</span><span class="ruby-operator">:</span> <span class="ruby-identifier">data</span>.<span class="ruby-identifier">data_real_time</span>.<span class="ruby-identifier">strftime</span>(<span class="ruby-string">&quot;%Y-%m-%d %H:%M:%S&quot;</span>)}}}
        <span class="ruby-comment">#pp querydata.map{ |data| data.city_id}.uniq.length</span>
        <span class="ruby-comment">#pp @citycompare</span>
        <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
                <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> { }
                <span class="ruby-identifier">format</span>.<span class="ruby-identifier">js</span>   { }
                <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> {
                        <span class="ruby-identifier">render</span> <span class="ruby-identifier">json</span><span class="ruby-operator">:</span> <span class="ruby-ivar">@citycompare</span>
                }
        <span class="ruby-keyword">end</span>    
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-compare" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">compare</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="compare-source">
            <pre><span class="ruby-comment"># File app/controllers/qinhuangdao_controller.rb, line 683</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">compare</span>
        <span class="ruby-ivar">@banner</span> = <span class="ruby-identifier">banner</span>()
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-del_some_points" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">del_some_points</span><span
            class="method-args">(data)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>去掉保定部分监测点</p>
          
          

          
          <div class="method-source-code" id="del_some_points-source">
            <pre><span class="ruby-comment"># File app/controllers/qinhuangdao_controller.rb, line 287</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">del_some_points</span>(<span class="ruby-identifier">data</span>)
        <span class="ruby-identifier">del_point</span>=[<span class="ruby-string">&#39;地表水厂&#39;</span>,<span class="ruby-string">&#39;游泳馆&#39;</span>,<span class="ruby-string">&#39;接待中心&#39;</span>, <span class="ruby-string">&#39;华电二区&#39;</span>, <span class="ruby-string">&#39;定兴县政府&#39;</span>, <span class="ruby-string">&#39;市监测站&#39;</span>, <span class="ruby-string">&#39;胶片厂&#39;</span>]
        <span class="ruby-identifier">del_point</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span>
                <span class="ruby-identifier">data</span>[<span class="ruby-value">:cities</span>].<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">n</span><span class="ruby-operator">|</span>
                        <span class="ruby-identifier">data</span>[<span class="ruby-value">:cities</span>].<span class="ruby-identifier">delete</span>(<span class="ruby-identifier">n</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">n</span>[<span class="ruby-string">&#39;city&#39;</span>].<span class="ruby-identifier">strip</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">strip</span> 
                <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-identifier">data</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-forecast" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">forecast</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="forecast-source">
            <pre><span class="ruby-comment"># File app/controllers/qinhuangdao_controller.rb, line 676</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">forecast</span>
        <span class="ruby-ivar">@banner</span> = <span class="ruby-identifier">banner</span>()
        <span class="ruby-ivar">@day_fdata</span> = <span class="ruby-ivar">@banner</span>[<span class="ruby-string">&quot;day_fdata&quot;</span>]
        <span class="ruby-ivar">@post</span>=<span class="ruby-string">&#39;130600&#39;</span>
        <span class="ruby-ivar">@city_adj</span> = <span class="ruby-ivar">@banner</span>[<span class="ruby-string">&quot;city_adj&quot;</span>]
        <span class="ruby-ivar">@adj_per1</span> = <span class="ruby-ivar">@banner</span>[<span class="ruby-string">&quot;adj_per1&quot;</span>]
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-get_city_point" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">get_city_point</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>获取城市名称和经纬度</p>
          
          

          
          <div class="method-source-code" id="get_city_point-source">
            <pre><span class="ruby-comment"># File app/controllers/qinhuangdao_controller.rb, line 487</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">get_city_point</span>
        <span class="ruby-identifier">pointdata</span>=<span class="ruby-constant">City</span>.<span class="ruby-identifier">all</span>.<span class="ruby-identifier">map</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">data</span><span class="ruby-operator">|</span> { <span class="ruby-identifier">city_name</span><span class="ruby-operator">:</span> <span class="ruby-identifier">data</span>.<span class="ruby-identifier">city_name</span>,<span class="ruby-identifier">longitude</span><span class="ruby-operator">:</span> <span class="ruby-identifier">data</span>.<span class="ruby-identifier">longitude</span>,<span class="ruby-identifier">latitude</span><span class="ruby-operator">:</span> <span class="ruby-identifier">data</span>.<span class="ruby-identifier">latitude</span>} }
        <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
                <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> { <span class="ruby-identifier">render</span> <span class="ruby-identifier">json</span><span class="ruby-operator">:</span> <span class="ruby-identifier">pointdata</span>}
                <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:callback</span>] <span class="ruby-comment">#jsonp回调函数名</span>
                        <span class="ruby-identifier">format</span>.<span class="ruby-identifier">js</span> { <span class="ruby-identifier">render</span> <span class="ruby-value">:json</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">pointdata</span>, <span class="ruby-value">:callback</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:callback</span>] }
                <span class="ruby-keyword">else</span>
                        <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> { <span class="ruby-identifier">render</span> <span class="ruby-identifier">json</span><span class="ruby-operator">:</span> <span class="ruby-identifier">pointdata</span>}
                <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-get_db_data" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">get_db_data</span><span
            class="method-args">(model,time)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>获取数据库数据pinggu.html.erb显示</p>
          
          

          
          <div class="method-source-code" id="get_db_data-source">
            <pre><span class="ruby-comment"># File app/controllers/qinhuangdao_controller.rb, line 348</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">get_db_data</span>(<span class="ruby-identifier">model</span>,<span class="ruby-identifier">time</span>)
        <span class="ruby-identifier">stime</span> = <span class="ruby-keyword">nil</span>
        <span class="ruby-identifier">etime</span> = <span class="ruby-keyword">nil</span>
        <span class="ruby-keyword">if</span> <span class="ruby-regexp">/\w*Hour/</span>.<span class="ruby-identifier">match</span>(<span class="ruby-identifier">model</span>.<span class="ruby-identifier">name</span>)
                <span class="ruby-identifier">stime</span> = <span class="ruby-identifier">time</span>.<span class="ruby-identifier">beginning_of_hour</span>
                <span class="ruby-identifier">etime</span> = <span class="ruby-identifier">time</span>.<span class="ruby-identifier">end_of_hour</span>
        <span class="ruby-keyword">else</span>
                <span class="ruby-identifier">stime</span> = <span class="ruby-identifier">time</span>.<span class="ruby-identifier">beginning_of_day</span>
                <span class="ruby-identifier">etime</span> = <span class="ruby-identifier">time</span>.<span class="ruby-identifier">end_of_day</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-identifier">sql_str</span>=<span class="ruby-constant">Array</span>.<span class="ruby-identifier">new</span>
        <span class="ruby-identifier">sql_str</span><span class="ruby-operator">&lt;&lt;</span><span class="ruby-string">&quot;data_real_time &gt;= ? AND data_real_time &lt;= ?&quot;</span>
        <span class="ruby-identifier">sql_str</span><span class="ruby-operator">&lt;&lt;</span><span class="ruby-identifier">stime</span>
        <span class="ruby-identifier">sql_str</span><span class="ruby-operator">&lt;&lt;</span><span class="ruby-identifier">etime</span>
        <span class="ruby-identifier">data</span> = <span class="ruby-identifier">model</span>.<span class="ruby-identifier">where</span>(<span class="ruby-identifier">sql_str</span>)
        <span class="ruby-identifier">data</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">nil?</span> <span class="ruby-operator">?</span> [] <span class="ruby-operator">:</span> <span class="ruby-identifier">data</span>.<span class="ruby-identifier">uniq</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-get_forecast" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">get_forecast</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>获取预测数据</p>
          
          

          
          <div class="method-source-code" id="get_forecast-source">
            <pre><span class="ruby-comment"># File app/controllers/qinhuangdao_controller.rb, line 402</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">get_forecast</span>
        <span class="ruby-identifier">city_name_encode</span> = <span class="ruby-constant">ERB</span><span class="ruby-operator">::</span><span class="ruby-constant">Util</span>.<span class="ruby-identifier">url_encode</span>(<span class="ruby-string">&quot;保定市&quot;</span>)
        <span class="ruby-identifier">options</span> = <span class="ruby-constant">Hash</span>.<span class="ruby-identifier">new</span>
        <span class="ruby-identifier">headers</span>={<span class="ruby-string">&#39;apikey&#39;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&#39;f8484c1661a905c5ca470b0d90af8d9f&#39;</span>}
        <span class="ruby-identifier">options</span>[<span class="ruby-value">:headers</span>] = <span class="ruby-identifier">headers</span>
        <span class="ruby-identifier">url</span> = <span class="ruby-node">&quot;http://apis.baidu.com/showapi_open_bus/weather_showapi/address?area=#{city_name_encode}&amp;needMoreDay=1&quot;</span>
        <span class="ruby-identifier">response</span> = <span class="ruby-constant">HTTParty</span>.<span class="ruby-identifier">get</span>(<span class="ruby-identifier">url</span>,<span class="ruby-identifier">options</span>)
        <span class="ruby-identifier">json</span> = <span class="ruby-constant">JSON</span>.<span class="ruby-identifier">parse</span>(<span class="ruby-identifier">response</span>.<span class="ruby-identifier">body</span>)
        <span class="ruby-identifier">puts</span> <span class="ruby-value">0</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">json</span>[<span class="ruby-string">&#39;showapi_res_error&#39;</span>] <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
        <span class="ruby-ivar">@weather</span> = <span class="ruby-constant">Hash</span>.<span class="ruby-identifier">new</span>
        <span class="ruby-identifier">json</span>[<span class="ruby-string">&#39;showapi_res_body&#39;</span>].<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">k</span>,<span class="ruby-identifier">v</span><span class="ruby-operator">|</span>
                <span class="ruby-keyword">if</span> <span class="ruby-identifier">k</span>[<span class="ruby-value">-1</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span> 
                        <span class="ruby-identifier">tq</span> = <span class="ruby-identifier">get_tq</span>(<span class="ruby-identifier">v</span>)
                        <span class="ruby-ivar">@weather</span>[<span class="ruby-identifier">tq</span>[<span class="ruby-string">&#39;day&#39;</span>]] = <span class="ruby-identifier">tq</span>
                <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-identifier">temp</span> = <span class="ruby-constant">HourlyCityForecastAirQuality</span>.<span class="ruby-identifier">new</span>.<span class="ruby-identifier">air_quality_forecast</span>(<span class="ruby-string">&#39;baodingshi&#39;</span>)
        <span class="ruby-ivar">@ret</span> = {}
        <span class="ruby-identifier">temp</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">k</span>,<span class="ruby-identifier">v</span><span class="ruby-operator">|</span>
                <span class="ruby-identifier">v</span>[<span class="ruby-string">&quot;fore_lev&quot;</span>] = <span class="ruby-identifier">get_lev</span>(<span class="ruby-identifier">v</span>[<span class="ruby-string">&quot;AQI&quot;</span>])
                <span class="ruby-identifier">time</span> = <span class="ruby-identifier">k</span>.<span class="ruby-identifier">strftime</span>(<span class="ruby-string">&quot;%Y%m%d&quot;</span>)
                <span class="ruby-keyword">if</span> <span class="ruby-ivar">@weather</span>[<span class="ruby-identifier">time</span>] <span class="ruby-operator">!=</span> <span class="ruby-keyword">nil</span>
                        <span class="ruby-ivar">@ret</span>[<span class="ruby-identifier">time</span>]=<span class="ruby-ivar">@weather</span>[<span class="ruby-identifier">time</span>].<span class="ruby-identifier">merge</span>(<span class="ruby-identifier">v</span>)
                <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-ivar">@ret</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-get_forecast_baoding" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">get_forecast_baoding</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>获取预测数据</p>
          
          

          
          <div class="method-source-code" id="get_forecast_baoding-source">
            <pre><span class="ruby-comment"># File app/controllers/qinhuangdao_controller.rb, line 472</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">get_forecast_baoding</span>
        <span class="ruby-identifier">data</span> = <span class="ruby-identifier">get_forecast</span>()

        <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
                <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> { <span class="ruby-identifier">render</span> <span class="ruby-identifier">json</span><span class="ruby-operator">:</span> <span class="ruby-identifier">data</span> }
                <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:callback</span>] <span class="ruby-comment">#jsonp回调函数名</span>
                        <span class="ruby-identifier">format</span>.<span class="ruby-identifier">js</span> { <span class="ruby-identifier">render</span> <span class="ruby-value">:json</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">data</span>, <span class="ruby-value">:callback</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:callback</span>] }
                <span class="ruby-keyword">else</span>
                        <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> { <span class="ruby-identifier">render</span> <span class="ruby-identifier">json</span><span class="ruby-operator">:</span> <span class="ruby-identifier">data</span>}
                <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-get_history_data" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">get_history_data</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="get_history_data-source">
            <pre><span class="ruby-comment"># File app/controllers/qinhuangdao_controller.rb, line 173</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">get_history_data</span>
        <span class="ruby-identifier">model</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:model</span>]
        <span class="ruby-identifier">time</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:time</span>].<span class="ruby-identifier">to_time</span>
        <span class="ruby-identifier">data</span> = <span class="ruby-identifier">change_data_type</span>(<span class="ruby-identifier">get_db_data</span>(<span class="ruby-identifier">model</span>.<span class="ruby-identifier">constantize</span>,<span class="ruby-identifier">time</span>))
        <span class="ruby-identifier">render</span> <span class="ruby-value">:json=</span><span class="ruby-operator">&gt;</span><span class="ruby-identifier">data</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-get_lev" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">get_lev</span><span
            class="method-args">(a)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="get_lev-source">
            <pre><span class="ruby-comment"># File app/controllers/qinhuangdao_controller.rb, line 501</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">get_lev</span>(<span class="ruby-identifier">a</span>)
        <span class="ruby-keyword">if</span> (<span class="ruby-value">0</span> <span class="ruby-operator">..</span> <span class="ruby-value">50</span>) <span class="ruby-operator">===</span> <span class="ruby-identifier">a</span>
                <span class="ruby-identifier">lev</span> = <span class="ruby-string">&#39;you&#39;</span>
        <span class="ruby-keyword">elsif</span> (<span class="ruby-value">50</span> <span class="ruby-operator">..</span> <span class="ruby-value">100</span>) <span class="ruby-operator">===</span> <span class="ruby-identifier">a</span>
                <span class="ruby-identifier">lev</span> = <span class="ruby-string">&#39;yellow&#39;</span>
        <span class="ruby-keyword">elsif</span> (<span class="ruby-value">100</span> <span class="ruby-operator">..</span> <span class="ruby-value">150</span>) <span class="ruby-operator">===</span> <span class="ruby-identifier">a</span>
                <span class="ruby-identifier">lev</span> = <span class="ruby-string">&#39;qingdu&#39;</span>
        <span class="ruby-keyword">elsif</span> (<span class="ruby-value">150</span> <span class="ruby-operator">..</span> <span class="ruby-value">200</span>) <span class="ruby-operator">===</span> <span class="ruby-identifier">a</span>
                <span class="ruby-identifier">lev</span> = <span class="ruby-string">&#39;zhong&#39;</span>
        <span class="ruby-keyword">elsif</span> (<span class="ruby-value">200</span> <span class="ruby-operator">..</span> <span class="ruby-value">300</span>) <span class="ruby-operator">===</span> <span class="ruby-identifier">a</span>
                <span class="ruby-identifier">lev</span> = <span class="ruby-string">&#39;zhongdu&#39;</span>
        <span class="ruby-keyword">elsif</span> (<span class="ruby-value">300</span> <span class="ruby-operator">..</span> <span class="ruby-value">500</span>) <span class="ruby-operator">===</span> <span class="ruby-identifier">a</span>
                <span class="ruby-identifier">lev</span> = <span class="ruby-string">&#39;yanzhong&#39;</span>
        <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-get_tq" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">get_tq</span><span
            class="method-args">(f1)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>天气处理与get_forecast合作使用</p>
          
          

          
          <div class="method-source-code" id="get_tq-source">
            <pre><span class="ruby-comment"># File app/controllers/qinhuangdao_controller.rb, line 430</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">get_tq</span>(<span class="ruby-identifier">f1</span>)
        <span class="ruby-identifier">tq</span> = <span class="ruby-constant">Hash</span>.<span class="ruby-identifier">new</span>
        <span class="ruby-identifier">tq</span>[<span class="ruby-string">&#39;tq&#39;</span>] = <span class="ruby-identifier">f1</span>[<span class="ruby-string">&#39;day_weather&#39;</span>]
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">f1</span>[<span class="ruby-string">&#39;day_air_temperature&#39;</span>][<span class="ruby-value">-1</span>] <span class="ruby-operator">==</span> <span class="ruby-string">&#39;℃&#39;</span>
                <span class="ruby-identifier">tq</span>[<span class="ruby-string">&#39;temp1&#39;</span>] = <span class="ruby-identifier">f1</span>[<span class="ruby-string">&#39;day_air_temperature&#39;</span>][<span class="ruby-value">0</span>,<span class="ruby-identifier">f1</span>[<span class="ruby-string">&#39;day_air_temperature&#39;</span>].<span class="ruby-identifier">size</span><span class="ruby-operator">-</span><span class="ruby-value">1</span>]
        <span class="ruby-keyword">else</span>
                <span class="ruby-identifier">tq</span>[<span class="ruby-string">&#39;temp1&#39;</span>] = <span class="ruby-identifier">f1</span>[<span class="ruby-string">&#39;day_air_temperature&#39;</span>] 
        <span class="ruby-keyword">end</span>
        <span class="ruby-identifier">tq</span>[<span class="ruby-string">&#39;temp2&#39;</span>] = <span class="ruby-identifier">f1</span>[<span class="ruby-string">&#39;night_air_temperature&#39;</span>]
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">f1</span>[<span class="ruby-string">&#39;day_wind_direction&#39;</span>] <span class="ruby-operator">==</span> <span class="ruby-string">&#39;无持续风向&#39;</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">f1</span>[<span class="ruby-string">&#39;night_wind_direction&#39;</span>] <span class="ruby-operator">==</span> <span class="ruby-string">&#39;无持续风向&#39;</span>
                <span class="ruby-identifier">tq</span>[<span class="ruby-string">&#39;wd&#39;</span>] = <span class="ruby-identifier">f1</span>[<span class="ruby-string">&#39;day_wind_direction&#39;</span>]
        <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">f1</span>[<span class="ruby-string">&#39;day_wind_direction&#39;</span>] <span class="ruby-operator">!=</span> <span class="ruby-string">&#39;无持续风向&#39;</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">f1</span>[<span class="ruby-string">&#39;night_wind_direction&#39;</span>] <span class="ruby-operator">==</span> <span class="ruby-string">&#39;无持续风向&#39;</span>
                <span class="ruby-identifier">tq</span>[<span class="ruby-string">&#39;wd&#39;</span>] = <span class="ruby-identifier">f1</span>[<span class="ruby-string">&#39;day_wind_direction&#39;</span>]
        <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">f1</span>[<span class="ruby-string">&#39;day_wind_direction&#39;</span>] <span class="ruby-operator">==</span> <span class="ruby-string">&#39;无持续风向&#39;</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">f1</span>[<span class="ruby-string">&#39;night_wind_direction&#39;</span>] <span class="ruby-operator">!=</span> <span class="ruby-string">&#39;无持续风向&#39;</span>
                <span class="ruby-identifier">tq</span>[<span class="ruby-string">&#39;wd&#39;</span>] = <span class="ruby-identifier">f1</span>[<span class="ruby-string">&#39;night_wind_direction&#39;</span>]
        <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">f1</span>[<span class="ruby-string">&#39;day_wind_direction&#39;</span>] <span class="ruby-operator">!=</span> <span class="ruby-string">&#39;无持续风向&#39;</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">f1</span>[<span class="ruby-string">&#39;night_wind_direction&#39;</span>] <span class="ruby-operator">!=</span> <span class="ruby-string">&#39;无持续风向&#39;</span>
                <span class="ruby-keyword">if</span> <span class="ruby-identifier">f1</span>[<span class="ruby-string">&#39;day_wind_direction&#39;</span>] <span class="ruby-operator">==</span> <span class="ruby-identifier">f1</span>[<span class="ruby-string">&#39;night_wind_direction&#39;</span>] 
                        <span class="ruby-identifier">tq</span>[<span class="ruby-string">&#39;wd&#39;</span>] = <span class="ruby-identifier">f1</span>[<span class="ruby-string">&#39;day_wind_direction&#39;</span>]
                <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">f1</span>[<span class="ruby-string">&#39;day_wind_direction&#39;</span>] <span class="ruby-operator">!=</span> <span class="ruby-identifier">f1</span>[<span class="ruby-string">&#39;night_wind_direction&#39;</span>] 
                        <span class="ruby-comment">#tq[&#39;wd&#39;] = f1[&#39;day_wind_direction&#39;]+&#39;~&#39;+f1[&#39;night_wind_direction&#39;]</span>
                <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-identifier">dw</span> = <span class="ruby-identifier">f1</span>[<span class="ruby-string">&#39;day_wind_power&#39;</span>]
        <span class="ruby-identifier">nw</span> = <span class="ruby-identifier">f1</span>[<span class="ruby-string">&#39;night_wind_power&#39;</span>]
        <span class="ruby-keyword">def</span> <span class="ruby-identifier">wind_power</span>(<span class="ruby-identifier">wp</span>)
                <span class="ruby-keyword">return</span> <span class="ruby-string">&#39;&#39;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">wp</span>
                <span class="ruby-keyword">return</span> <span class="ruby-identifier">wp</span>[<span class="ruby-value">0</span>,<span class="ruby-value">2</span>] <span class="ruby-keyword">if</span> <span class="ruby-identifier">wp</span>[<span class="ruby-value">0</span>,<span class="ruby-value">2</span>] <span class="ruby-operator">==</span> <span class="ruby-string">&#39;微风&#39;</span>
                <span class="ruby-keyword">for</span> <span class="ruby-identifier">e</span> <span class="ruby-keyword">in</span> (<span class="ruby-value">0</span><span class="ruby-operator">...</span><span class="ruby-identifier">wp</span>.<span class="ruby-identifier">size</span>)
                        <span class="ruby-keyword">return</span> <span class="ruby-identifier">wp</span>[<span class="ruby-value">0</span>,<span class="ruby-identifier">e</span><span class="ruby-operator">+</span><span class="ruby-value">1</span>] <span class="ruby-keyword">if</span> <span class="ruby-identifier">wp</span>[<span class="ruby-identifier">e</span>] <span class="ruby-operator">==</span> <span class="ruby-string">&#39;级&#39;</span>
                <span class="ruby-keyword">end</span>          
        <span class="ruby-keyword">end</span>
        <span class="ruby-identifier">dw</span> = <span class="ruby-identifier">wind_power</span>(<span class="ruby-identifier">dw</span>)
        <span class="ruby-identifier">nw</span> = <span class="ruby-identifier">wind_power</span>(<span class="ruby-identifier">nw</span>)
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">dw</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">nw</span>
                <span class="ruby-identifier">tq</span>[<span class="ruby-string">&#39;ws&#39;</span>] = <span class="ruby-identifier">dw</span>
        <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">dw</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">nw</span>
                <span class="ruby-identifier">dw</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">&gt;</span> <span class="ruby-identifier">nw</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">tq</span>[<span class="ruby-string">&#39;ws&#39;</span>] = <span class="ruby-identifier">nw</span> <span class="ruby-operator">+</span> <span class="ruby-string">&#39;~&#39;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">dw</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">tq</span>[<span class="ruby-string">&#39;ws&#39;</span>] = <span class="ruby-identifier">dw</span> <span class="ruby-operator">+</span> <span class="ruby-string">&#39;~&#39;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">nw</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-identifier">tq</span>[<span class="ruby-string">&#39;day&#39;</span>] = <span class="ruby-identifier">f1</span>[<span class="ruby-string">&#39;day&#39;</span>].<span class="ruby-identifier">to_time</span>.<span class="ruby-identifier">strftime</span>(<span class="ruby-string">&quot;%Y%m%d&quot;</span>)
        <span class="ruby-identifier">tq</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-getlayoutbyaction" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">getlayoutbyaction</span><span
            class="method-args">(action_name)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="getlayoutbyaction-source">
            <pre><span class="ruby-comment"># File app/controllers/qinhuangdao_controller.rb, line 696</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">getlayoutbyaction</span>(<span class="ruby-identifier">action_name</span>)
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">action_name</span> <span class="ruby-operator">==</span> <span class="ruby-string">&#39;sfcities_compare&#39;</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">action_name</span> <span class="ruby-operator">==</span> <span class="ruby-string">&#39;bdqx_compare&#39;</span>
                <span class="ruby-identifier">layout</span>=<span class="ruby-string">&#39;cmp&#39;</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-identifier">layout</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-hb_real" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">hb_real</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="hb_real-source">
            <pre><span class="ruby-comment"># File app/controllers/qinhuangdao_controller.rb, line 517</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">hb_real</span>
        <span class="ruby-identifier">hs</span> = <span class="ruby-constant">Hash</span>.<span class="ruby-identifier">new</span>
        <span class="ruby-keyword">begin</span>
                <span class="ruby-identifier">response</span> = <span class="ruby-constant">HTTParty</span>.<span class="ruby-identifier">get</span>(<span class="ruby-string">&#39;http://www.izhenqi.cn/api/getdata_cityrank.php?secret=CHINARANK&amp;type=HOUR&amp;key=&#39;</span><span class="ruby-operator">+</span><span class="ruby-constant">Digest</span><span class="ruby-operator">::</span><span class="ruby-constant">MD5</span>.<span class="ruby-identifier">hexdigest</span>(<span class="ruby-string">&#39;CHINARANKHOUR&#39;</span>))
                <span class="ruby-identifier">d</span> = <span class="ruby-constant">JSON</span>.<span class="ruby-identifier">parse</span>(<span class="ruby-identifier">response</span>.<span class="ruby-identifier">body</span>)
                <span class="ruby-identifier">hs</span>[<span class="ruby-value">:time</span>] = (<span class="ruby-identifier">d</span>[<span class="ruby-string">&#39;time&#39;</span>]).<span class="ruby-identifier">to_time</span>
                <span class="ruby-identifier">hs</span>[<span class="ruby-value">:cities</span>] =  <span class="ruby-identifier">d</span>[<span class="ruby-string">&#39;rows&#39;</span>]
        <span class="ruby-keyword">rescue</span>
                <span class="ruby-identifier">puts</span> <span class="ruby-string">&#39;Can not get data from izhenqi, please check network!&#39;</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-identifier">hs</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-index" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">index</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="index-source">
            <pre><span class="ruby-comment"># File app/controllers/qinhuangdao_controller.rb, line 9</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">index</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-map" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">map</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="map-source">
            <pre><span class="ruby-comment"># File app/controllers/qinhuangdao_controller.rb, line 15</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">map</span>
        <span class="ruby-identifier">system</span>(<span class="ruby-string">&#39;ls&#39;</span>)
        <span class="ruby-identifier">r</span> = <span class="ruby-value">%x`rails r vendor/test.rb`</span>
        <span class="ruby-identifier">puts</span> <span class="ruby-identifier">r</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-pinggu" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">pinggu</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="pinggu-source">
            <pre><span class="ruby-comment"># File app/controllers/qinhuangdao_controller.rb, line 297</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">pinggu</span>
        <span class="ruby-comment">#保定数据</span>
        <span class="ruby-ivar">@bddatabyhour</span>=<span class="ruby-identifier">del_some_points</span>(<span class="ruby-identifier">change_data_type</span>(<span class="ruby-identifier">get_db_data</span>(<span class="ruby-constant">TempBdHour</span>,<span class="ruby-constant">TempBdHour</span>.<span class="ruby-identifier">last</span>.<span class="ruby-identifier">data_real_time</span>))) 
        <span class="ruby-ivar">@bddatabyday</span>=<span class="ruby-identifier">del_some_points</span>(<span class="ruby-identifier">change_data_type</span>(<span class="ruby-identifier">get_db_data</span>(<span class="ruby-constant">TempBdDay</span>,<span class="ruby-constant">TempBdDay</span>.<span class="ruby-identifier">last</span>.<span class="ruby-identifier">data_real_time</span>))) 
        <span class="ruby-ivar">@bddatabymonth</span>=<span class="ruby-identifier">del_some_points</span>(<span class="ruby-identifier">change_data_type</span>(<span class="ruby-identifier">get_db_data</span>(<span class="ruby-constant">TempBdMonth</span>,<span class="ruby-constant">TempBdMonth</span>.<span class="ruby-identifier">last</span>.<span class="ruby-identifier">data_real_time</span>)))
        <span class="ruby-ivar">@bddatabyyear</span>=<span class="ruby-identifier">del_some_points</span>(<span class="ruby-identifier">change_data_type</span>(<span class="ruby-identifier">get_db_data</span>(<span class="ruby-constant">TempBdYear</span>,<span class="ruby-constant">TempBdYear</span>.<span class="ruby-identifier">last</span>.<span class="ruby-identifier">data_real_time</span>)))

        <span class="ruby-comment">#河北数据</span>
        <span class="ruby-ivar">@hebeidatabyhour</span>=<span class="ruby-identifier">change_data_type</span>(<span class="ruby-identifier">get_db_data</span>(<span class="ruby-constant">TempHbHour</span>,<span class="ruby-constant">TempHbHour</span>.<span class="ruby-identifier">last</span>.<span class="ruby-identifier">data_real_time</span>)) 
        <span class="ruby-identifier">hebeidatabyday</span>=<span class="ruby-identifier">change_data_type</span>(<span class="ruby-identifier">get_db_data</span>(<span class="ruby-constant">TempJjjDay</span>,<span class="ruby-constant">TempJjjDay</span>.<span class="ruby-identifier">last</span>.<span class="ruby-identifier">data_real_time</span>))
        <span class="ruby-identifier">hebeidatabyday</span>[<span class="ruby-value">:cities</span>] = <span class="ruby-identifier">hebeidatabyday</span>[<span class="ruby-value">:cities</span>].<span class="ruby-identifier">delete_if</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">item</span><span class="ruby-operator">|</span> (<span class="ruby-identifier">item</span>[<span class="ruby-string">&#39;city&#39;</span>]<span class="ruby-operator">==</span><span class="ruby-string">&#39;北京市&#39;</span>)<span class="ruby-operator">||</span>(<span class="ruby-identifier">item</span>[<span class="ruby-string">&#39;city&#39;</span>]<span class="ruby-operator">==</span><span class="ruby-string">&#39;天津市&#39;</span>)}
        <span class="ruby-ivar">@hebeidatabyday</span>=<span class="ruby-identifier">hebeidatabyday</span>

        <span class="ruby-comment">#京津冀</span>
        <span class="ruby-ivar">@jjjdatabyday</span>=<span class="ruby-identifier">change_data_type</span>(<span class="ruby-identifier">get_db_data</span>(<span class="ruby-constant">TempJjjDay</span>,<span class="ruby-constant">TempJjjDay</span>.<span class="ruby-identifier">last</span>.<span class="ruby-identifier">data_real_time</span>))
        <span class="ruby-ivar">@jjjdatabymonth</span>=<span class="ruby-identifier">change_data_type</span>(<span class="ruby-identifier">get_db_data</span>(<span class="ruby-constant">TempJjjMonth</span>,<span class="ruby-constant">TempJjjMonth</span>.<span class="ruby-identifier">last</span>.<span class="ruby-identifier">data_real_time</span>))
        <span class="ruby-ivar">@jjjdatabyyear</span>=<span class="ruby-identifier">change_data_type</span>(<span class="ruby-identifier">get_db_data</span>(<span class="ruby-constant">TempJjjYear</span>,<span class="ruby-constant">TempJjjYear</span>.<span class="ruby-identifier">last</span>.<span class="ruby-identifier">data_real_time</span>))

        <span class="ruby-comment">#74城市</span>
        <span class="ruby-ivar">@sfcitiesrankbyday</span>=<span class="ruby-identifier">change_data_type</span>(<span class="ruby-identifier">change_74_main_pol</span>(<span class="ruby-identifier">get_db_data</span>(<span class="ruby-constant">TempSfcitiesDay</span>,<span class="ruby-constant">TempSfcitiesDay</span>.<span class="ruby-identifier">last</span>.<span class="ruby-identifier">data_real_time</span>)))
        <span class="ruby-ivar">@sfcitiesrankbymonth</span>=<span class="ruby-identifier">change_data_type</span>(<span class="ruby-identifier">get_db_data</span>(<span class="ruby-constant">TempSfcitiesMonth</span>,<span class="ruby-constant">TempSfcitiesMonth</span>.<span class="ruby-identifier">last</span>.<span class="ruby-identifier">data_real_time</span>))
        <span class="ruby-ivar">@sfcitiesrankbyyear</span>=<span class="ruby-identifier">change_data_type</span>(<span class="ruby-identifier">get_db_data</span>(<span class="ruby-constant">TempSfcitiesYear</span>,<span class="ruby-constant">TempSfcitiesYear</span>.<span class="ruby-identifier">last</span>.<span class="ruby-identifier">data_real_time</span>))

        <span class="ruby-ivar">@banner</span> = <span class="ruby-identifier">banner</span>()

        <span class="ruby-ivar">@forecast_data</span> = <span class="ruby-identifier">get_forecast</span>()

        <span class="ruby-comment"># adj data</span>
        <span class="ruby-ivar">@city_adj</span> = <span class="ruby-string">&#39;ADJ_baoding/&#39;</span>

<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-rank1503" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">rank1503</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>74城市全部展示</p>
          
          

          
          <div class="method-source-code" id="rank1503-source">
            <pre><span class="ruby-comment"># File app/controllers/qinhuangdao_controller.rb, line 668</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">rank1503</span>
        <span class="ruby-comment">#74城市</span>
        <span class="ruby-ivar">@sfcitiesrankbyday</span>=<span class="ruby-identifier">change_data_type</span>(<span class="ruby-identifier">get_db_data</span>(<span class="ruby-constant">TempSfcitiesDay</span>))
        <span class="ruby-ivar">@sfcitiesrankbymonth</span>=<span class="ruby-identifier">change_data_type</span>(<span class="ruby-identifier">get_db_data</span>(<span class="ruby-constant">TempSfcitiesMonth</span>))
        <span class="ruby-ivar">@sfcitiesrankbyyear</span>=<span class="ruby-identifier">change_data_type</span>(<span class="ruby-identifier">get_db_data</span>(<span class="ruby-constant">TempSfcitiesYear</span>))
        <span class="ruby-ivar">@banner</span>=<span class="ruby-identifier">banner</span>()
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-read_adj" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">read_adj</span><span
            class="method-args">(ncfile, city_file, var_name)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="read_adj-source">
            <pre><span class="ruby-comment"># File app/controllers/qinhuangdao_controller.rb, line 638</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">read_adj</span> (<span class="ruby-identifier">ncfile</span>, <span class="ruby-identifier">city_file</span>, <span class="ruby-identifier">var_name</span>)
        <span class="ruby-identifier">file</span> = <span class="ruby-constant">NetCDF</span>.<span class="ruby-identifier">open</span>(<span class="ruby-identifier">ncfile</span>)

        <span class="ruby-comment"># Get longitude</span>
        <span class="ruby-identifier">var</span> = <span class="ruby-identifier">file</span>.<span class="ruby-identifier">var</span>(<span class="ruby-identifier">var_name</span>)
        <span class="ruby-identifier">data</span> = <span class="ruby-identifier">var</span>.<span class="ruby-identifier">get</span>
        <span class="ruby-comment">#puts data.shape</span>

        <span class="ruby-identifier">x</span> = <span class="ruby-constant">Array</span>.<span class="ruby-identifier">new</span>
        <span class="ruby-identifier">y</span> = <span class="ruby-constant">Array</span>.<span class="ruby-identifier">new</span>
        <span class="ruby-comment">#puts city_file</span>
        <span class="ruby-identifier">lines</span> = <span class="ruby-constant">IO</span>.<span class="ruby-identifier">readlines</span>(<span class="ruby-identifier">city_file</span>)
        <span class="ruby-identifier">num_points</span> = <span class="ruby-identifier">lines</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>
        <span class="ruby-comment">#lines.each { |line|</span>
        <span class="ruby-keyword">for</span> <span class="ruby-identifier">i</span> <span class="ruby-keyword">in</span> <span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-identifier">lines</span>.<span class="ruby-identifier">length</span><span class="ruby-operator">-</span><span class="ruby-value">1</span>
                <span class="ruby-identifier">as</span> = <span class="ruby-identifier">lines</span>[<span class="ruby-identifier">i</span>].<span class="ruby-identifier">split</span>(<span class="ruby-identifier">pattern</span>=<span class="ruby-string">&#39; &#39;</span>) 
                <span class="ruby-identifier">x</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">as</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>
                <span class="ruby-identifier">y</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">as</span>[<span class="ruby-value">1</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-comment">#}</span>

        <span class="ruby-identifier">sum_per</span> = <span class="ruby-value">0.0</span>
        <span class="ruby-keyword">for</span> <span class="ruby-identifier">i</span> <span class="ruby-keyword">in</span> <span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">num_points</span><span class="ruby-operator">-</span><span class="ruby-value">1</span>
                <span class="ruby-comment">#puts data[x[i],y[i],0,0]</span>
                <span class="ruby-identifier">sum_per</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">data</span>[<span class="ruby-identifier">x</span>[<span class="ruby-identifier">i</span>],<span class="ruby-identifier">y</span>[<span class="ruby-identifier">i</span>],<span class="ruby-value">0</span>,<span class="ruby-value">0</span>]
        <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">return</span> <span class="ruby-identifier">sum_per</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-sfcities_compare" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">sfcities_compare</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="sfcities_compare-source">
            <pre><span class="ruby-comment"># File app/controllers/qinhuangdao_controller.rb, line 686</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">sfcities_compare</span>
        <span class="ruby-identifier">render</span> <span class="ruby-identifier">layout</span><span class="ruby-operator">:</span> <span class="ruby-identifier">getlayoutbyaction</span>(<span class="ruby-string">&#39;sfcities_compare&#39;</span>)
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-show" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">show</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="show-source">
            <pre><span class="ruby-comment"># File app/controllers/qinhuangdao_controller.rb, line 11</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">show</span>
        <span class="ruby-comment"># @visits = Visit.all</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-subindex" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">subindex</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>显示分指数</p>
          
          

          
          <div class="method-source-code" id="subindex-source">
            <pre><span class="ruby-comment"># File app/controllers/qinhuangdao_controller.rb, line 95</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">subindex</span>
        <span class="ruby-ivar">@diff_monitor_forecast</span> = []
        <span class="ruby-ivar">@city_name</span>=<span class="ruby-string">&#39;&#39;</span>
        <span class="ruby-identifier">id</span> = <span class="ruby-value">18</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:c</span>] 
                (<span class="ruby-identifier">id</span> =  <span class="ruby-identifier">params</span>[<span class="ruby-value">:c</span>][<span class="ruby-value">:city_id</span>]) 
        <span class="ruby-keyword">end</span>
        
        <span class="ruby-comment"># Table 1: 全国城市当天监测与预报日均值差值</span>
        <span class="ruby-identifier">monitor_today_avg</span> = <span class="ruby-constant">ChinaCitiesHour</span>.<span class="ruby-identifier">today_avg</span>
        <span class="ruby-identifier">forecast_today_avg</span> = <span class="ruby-constant">HourlyCityForecastAirQuality</span>.<span class="ruby-identifier">today_avg</span>
        <span class="ruby-identifier">monitor_today_avg</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">k</span>,<span class="ruby-identifier">v</span><span class="ruby-operator">|</span>
                <span class="ruby-keyword">next</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">forecast_today_avg</span>[<span class="ruby-identifier">k</span>]
                <span class="ruby-identifier">d</span> = <span class="ruby-identifier">monitor_today_avg</span>[<span class="ruby-identifier">k</span>] <span class="ruby-operator">-</span> <span class="ruby-identifier">forecast_today_avg</span>[<span class="ruby-identifier">k</span>].<span class="ruby-identifier">values</span>[<span class="ruby-value">0</span>]
                <span class="ruby-ivar">@diff_monitor_forecast</span> <span class="ruby-operator">&lt;&lt;</span> [ <span class="ruby-identifier">k</span>, <span class="ruby-identifier">monitor_today_avg</span>[<span class="ruby-identifier">k</span>], <span class="ruby-identifier">forecast_today_avg</span>[<span class="ruby-identifier">k</span>].<span class="ruby-identifier">values</span>[<span class="ruby-value">0</span>], <span class="ruby-identifier">d</span>.<span class="ruby-identifier">abs</span>, <span class="ruby-identifier">forecast_today_avg</span>[<span class="ruby-identifier">k</span>].<span class="ruby-identifier">keys</span>[<span class="ruby-value">0</span>]]
        <span class="ruby-keyword">end</span>

        <span class="ruby-comment"># Table 2: 城市监测与预报值小时值对比</span>
        <span class="ruby-identifier">c</span> = <span class="ruby-constant">City</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">id</span>)
        <span class="ruby-ivar">@city_name</span>=<span class="ruby-identifier">c</span>.<span class="ruby-identifier">city_name</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:start_date</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:end_date</span>]
                <span class="ruby-identifier">sd</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">local</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:start_date</span>][<span class="ruby-value">:year</span>].<span class="ruby-identifier">to_i</span>, <span class="ruby-identifier">params</span>[<span class="ruby-value">:start_date</span>][<span class="ruby-value">:month</span>].<span class="ruby-identifier">to_i</span>, <span class="ruby-identifier">params</span>[<span class="ruby-value">:start_date</span>][<span class="ruby-value">:day</span>].<span class="ruby-identifier">to_i</span>)
                <span class="ruby-identifier">ed</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">local</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:end_date</span>][<span class="ruby-value">:year</span>].<span class="ruby-identifier">to_i</span>, <span class="ruby-identifier">params</span>[<span class="ruby-value">:end_date</span>][<span class="ruby-value">:month</span>].<span class="ruby-identifier">to_i</span>, <span class="ruby-identifier">params</span>[<span class="ruby-value">:end_date</span>][<span class="ruby-value">:day</span>].<span class="ruby-identifier">to_i</span>,<span class="ruby-value">23</span>)
                <span class="ruby-keyword">return</span> <span class="ruby-string">&#39;error: start date can not later than end date!&#39;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">sd</span> <span class="ruby-operator">&gt;</span> <span class="ruby-identifier">ed</span>
                <span class="ruby-identifier">hss</span> = <span class="ruby-identifier">c</span>.<span class="ruby-identifier">hourly_city_forecast_air_qualities</span>.<span class="ruby-identifier">order</span>(<span class="ruby-value">:publish_datetime</span>).<span class="ruby-identifier">last</span>(<span class="ruby-value">120</span>)
                <span class="ruby-identifier">hs</span> = []
                <span class="ruby-identifier">hss</span>.<span class="ruby-identifier">each</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">h</span><span class="ruby-operator">|</span> <span class="ruby-identifier">hs</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">h</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">h</span>.<span class="ruby-identifier">forecast_datetime</span> <span class="ruby-operator">&gt;=</span> <span class="ruby-identifier">sd</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">h</span>.<span class="ruby-identifier">forecast_datetime</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-identifier">ed</span> }
        <span class="ruby-keyword">else</span>
                <span class="ruby-identifier">hs</span> = <span class="ruby-identifier">c</span>.<span class="ruby-identifier">hourly_city_forecast_air_qualities</span>.<span class="ruby-identifier">order</span>(<span class="ruby-value">:publish_datetime</span>).<span class="ruby-identifier">last</span>(<span class="ruby-value">120</span>)
        <span class="ruby-keyword">end</span> 

        <span class="ruby-identifier">md</span> = <span class="ruby-identifier">c</span>.<span class="ruby-identifier">china_cities_hours</span>.<span class="ruby-identifier">where</span>(<span class="ruby-identifier">data_real_time</span><span class="ruby-operator">:</span> <span class="ruby-constant">Time</span>.<span class="ruby-identifier">zone</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">beginning_of_day</span><span class="ruby-operator">..</span><span class="ruby-constant">Time</span>.<span class="ruby-identifier">zone</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">end_of_day</span>)

        <span class="ruby-ivar">@chart_aqi</span> = [{<span class="ruby-identifier">name</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;预报值&#39;</span>, <span class="ruby-identifier">data</span><span class="ruby-operator">:</span> <span class="ruby-identifier">hs</span>.<span class="ruby-identifier">map</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">h</span><span class="ruby-operator">|</span> [ <span class="ruby-identifier">h</span>.<span class="ruby-identifier">forecast_datetime</span>, <span class="ruby-identifier">h</span>.<span class="ruby-constant">AQI</span>]} }]
        <span class="ruby-ivar">@chart_aqi</span> <span class="ruby-operator">&lt;&lt;</span> {<span class="ruby-identifier">name</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;监测值&#39;</span>, <span class="ruby-identifier">data</span><span class="ruby-operator">:</span> <span class="ruby-identifier">md</span>.<span class="ruby-identifier">map</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">h</span><span class="ruby-operator">|</span> [ <span class="ruby-identifier">h</span>.<span class="ruby-identifier">data_real_time</span>,<span class="ruby-identifier">h</span>.<span class="ruby-constant">AQI</span> ] } }

        <span class="ruby-ivar">@chart_so2</span> = [{<span class="ruby-identifier">name</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;预报值&#39;</span>, <span class="ruby-identifier">data</span><span class="ruby-operator">:</span> <span class="ruby-identifier">hs</span>.<span class="ruby-identifier">map</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">h</span><span class="ruby-operator">|</span> [ <span class="ruby-identifier">h</span>.<span class="ruby-identifier">forecast_datetime</span>,  <span class="ruby-identifier">h</span>.<span class="ruby-constant">SO2</span>]} }]
        <span class="ruby-ivar">@chart_so2</span> <span class="ruby-operator">&lt;&lt;</span> {<span class="ruby-identifier">name</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;监测值&#39;</span>, <span class="ruby-identifier">data</span><span class="ruby-operator">:</span> <span class="ruby-identifier">md</span>.<span class="ruby-identifier">map</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">h</span><span class="ruby-operator">|</span> [ <span class="ruby-identifier">h</span>.<span class="ruby-identifier">data_real_time</span>,  <span class="ruby-identifier">h</span>.<span class="ruby-constant">SO2</span>] } }

        <span class="ruby-ivar">@chart_no2</span> = [{<span class="ruby-identifier">name</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;预报值&#39;</span>, <span class="ruby-identifier">data</span><span class="ruby-operator">:</span> <span class="ruby-identifier">hs</span>.<span class="ruby-identifier">map</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">h</span><span class="ruby-operator">|</span> [ <span class="ruby-identifier">h</span>.<span class="ruby-identifier">forecast_datetime</span>,  <span class="ruby-identifier">h</span>.<span class="ruby-constant">NO2</span>]} }]
        <span class="ruby-ivar">@chart_no2</span> <span class="ruby-operator">&lt;&lt;</span> {<span class="ruby-identifier">name</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;监测值&#39;</span>, <span class="ruby-identifier">data</span><span class="ruby-operator">:</span> <span class="ruby-identifier">md</span>.<span class="ruby-identifier">map</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">h</span><span class="ruby-operator">|</span> [ <span class="ruby-identifier">h</span>.<span class="ruby-identifier">data_real_time</span>,  <span class="ruby-identifier">h</span>.<span class="ruby-constant">NO2</span>] } }

        <span class="ruby-ivar">@chart_co</span> = [{<span class="ruby-identifier">name</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;预报值&#39;</span>, <span class="ruby-identifier">data</span><span class="ruby-operator">:</span> <span class="ruby-identifier">hs</span>.<span class="ruby-identifier">map</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">h</span><span class="ruby-operator">|</span> [ <span class="ruby-identifier">h</span>.<span class="ruby-identifier">forecast_datetime</span>,  <span class="ruby-identifier">h</span>.<span class="ruby-constant">CO</span>]} }]
        <span class="ruby-ivar">@chart_co</span> <span class="ruby-operator">&lt;&lt;</span> {<span class="ruby-identifier">name</span><span class="ruby-value">:&#39;监测值&#39;</span>, <span class="ruby-identifier">data</span><span class="ruby-operator">:</span> <span class="ruby-identifier">md</span>.<span class="ruby-identifier">map</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">h</span><span class="ruby-operator">|</span> [ <span class="ruby-identifier">h</span>.<span class="ruby-identifier">data_real_time</span>,  <span class="ruby-identifier">h</span>.<span class="ruby-constant">CO</span>] } }

        <span class="ruby-ivar">@chart_o3</span> = [{<span class="ruby-identifier">name</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;预报值&#39;</span>, <span class="ruby-identifier">data</span><span class="ruby-operator">:</span> <span class="ruby-identifier">hs</span>.<span class="ruby-identifier">map</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">h</span><span class="ruby-operator">|</span> [ <span class="ruby-identifier">h</span>.<span class="ruby-identifier">forecast_datetime</span>,  <span class="ruby-identifier">h</span>.<span class="ruby-constant">O3</span>]} }]
        <span class="ruby-ivar">@chart_o3</span> <span class="ruby-operator">&lt;&lt;</span> {<span class="ruby-identifier">name</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;监测值&#39;</span>, <span class="ruby-identifier">data</span><span class="ruby-operator">:</span> <span class="ruby-identifier">md</span>.<span class="ruby-identifier">map</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">h</span><span class="ruby-operator">|</span> [ <span class="ruby-identifier">h</span>.<span class="ruby-identifier">data_real_time</span>,  <span class="ruby-identifier">h</span>.<span class="ruby-constant">O3</span>] } }

        <span class="ruby-ivar">@chart_pm10</span> = [{<span class="ruby-identifier">name</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;预报值&#39;</span>, <span class="ruby-identifier">data</span><span class="ruby-operator">:</span> <span class="ruby-identifier">hs</span>.<span class="ruby-identifier">map</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">h</span><span class="ruby-operator">|</span> [ <span class="ruby-identifier">h</span>.<span class="ruby-identifier">forecast_datetime</span>,  <span class="ruby-identifier">h</span>.<span class="ruby-identifier">pm10</span>]} }]
        <span class="ruby-ivar">@chart_pm10</span> <span class="ruby-operator">&lt;&lt;</span> {<span class="ruby-identifier">name</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;监测值&#39;</span>, <span class="ruby-identifier">data</span><span class="ruby-operator">:</span> <span class="ruby-identifier">md</span>.<span class="ruby-identifier">map</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">h</span><span class="ruby-operator">|</span> [ <span class="ruby-identifier">h</span>.<span class="ruby-identifier">data_real_time</span>,  <span class="ruby-identifier">h</span>.<span class="ruby-identifier">pm10</span>]} }

        <span class="ruby-ivar">@chart_pm25</span> = [{<span class="ruby-identifier">name</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;预报值&#39;</span>, <span class="ruby-identifier">data</span><span class="ruby-operator">:</span> <span class="ruby-identifier">hs</span>.<span class="ruby-identifier">map</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">h</span><span class="ruby-operator">|</span> [ <span class="ruby-identifier">h</span>.<span class="ruby-identifier">forecast_datetime</span>,  <span class="ruby-identifier">h</span>.<span class="ruby-identifier">pm25</span>]} }]
        <span class="ruby-ivar">@chart_pm25</span> <span class="ruby-operator">&lt;&lt;</span> {<span class="ruby-identifier">name</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;监测值&#39;</span>, <span class="ruby-identifier">data</span><span class="ruby-operator">:</span> <span class="ruby-identifier">md</span>.<span class="ruby-identifier">map</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">h</span><span class="ruby-operator">|</span> [ <span class="ruby-identifier">h</span>.<span class="ruby-identifier">data_real_time</span>,  <span class="ruby-identifier">h</span>.<span class="ruby-identifier">pm25</span>] } }

        <span class="ruby-ivar">@chart_vis</span> = [{<span class="ruby-identifier">name</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;预报值&#39;</span>, <span class="ruby-identifier">data</span><span class="ruby-operator">:</span> <span class="ruby-identifier">hs</span>.<span class="ruby-identifier">map</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">h</span><span class="ruby-operator">|</span> [ <span class="ruby-identifier">h</span>.<span class="ruby-identifier">forecast_datetime</span>,  <span class="ruby-identifier">h</span>.<span class="ruby-constant">VIS</span>]} }]
        <span class="ruby-comment"># @chart_vis &lt;&lt; {name: &#39;监测值&#39;, data: md.map { |h| [ h.data_real_time,  h.VIS] } }</span>

        <span class="ruby-comment"># Table 3: 过去一星期城市监测与预报值日均值对比</span>
        <span class="ruby-ivar">@fore_group_day</span> = {}

        <span class="ruby-comment"># 获取过去几天的监测值</span>
        <span class="ruby-ivar">@fore_group_day</span> = <span class="ruby-constant">ChinaCitiesHour</span>.<span class="ruby-identifier">history_data</span>(<span class="ruby-identifier">c</span>, <span class="ruby-value">6</span>.<span class="ruby-identifier">days</span>.<span class="ruby-identifier">ago</span>.<span class="ruby-identifier">beginning_of_day</span>)

        <span class="ruby-comment"># 获取过去几天发布的预报值</span>
        <span class="ruby-identifier">md</span> = {}
        <span class="ruby-identifier">h</span> = <span class="ruby-identifier">c</span>.<span class="ruby-identifier">hourly_city_forecast_air_qualities</span>.<span class="ruby-identifier">group</span>(<span class="ruby-value">:publish_datetime</span>).<span class="ruby-identifier">having</span>(<span class="ruby-string">&quot;publish_datetime &gt;= ?&quot;</span>, <span class="ruby-value">6</span>.<span class="ruby-identifier">days</span>.<span class="ruby-identifier">ago</span>.<span class="ruby-identifier">beginning_of_day</span>).<span class="ruby-identifier">group_by_day</span>(<span class="ruby-value">:forecast_datetime</span>).<span class="ruby-identifier">average</span>(<span class="ruby-value">:AQI</span>)
        <span class="ruby-identifier">h</span>.<span class="ruby-identifier">each</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">k</span>,<span class="ruby-identifier">v</span><span class="ruby-operator">|</span> <span class="ruby-identifier">k</span>.<span class="ruby-identifier">map!</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">x</span><span class="ruby-operator">|</span> <span class="ruby-identifier">x</span>.<span class="ruby-identifier">strftime</span>(<span class="ruby-string">&quot;%d%b&quot;</span>)}; <span class="ruby-identifier">md</span>[<span class="ruby-identifier">k</span>] = <span class="ruby-identifier">v</span>.<span class="ruby-identifier">round</span>}

        <span class="ruby-ivar">@fore_group_day</span>.<span class="ruby-identifier">merge!</span>(<span class="ruby-identifier">md</span>)
        <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
                <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> { }
                <span class="ruby-identifier">format</span>.<span class="ruby-identifier">js</span>   { }
                <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> {
                        <span class="ruby-identifier">render</span> <span class="ruby-identifier">json</span><span class="ruby-operator">:</span> <span class="ruby-ivar">@diff_monitor_forecast</span>
                }
        <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-visits_by_day" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">visits_by_day</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="visits_by_day-source">
            <pre><span class="ruby-comment"># File app/controllers/qinhuangdao_controller.rb, line 21</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">visits_by_day</span>
        <span class="ruby-identifier">id</span> =  <span class="ruby-identifier">params</span>[<span class="ruby-value">:city_id</span>]
        <span class="ruby-identifier">visits</span> = <span class="ruby-constant">Visit</span>.<span class="ruby-identifier">all</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">id</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;1&quot;</span>
                <span class="ruby-ivar">@chart</span> = <span class="ruby-constant">Visit</span>.<span class="ruby-identifier">group_by_day</span>(<span class="ruby-value">:visited_at</span>, <span class="ruby-identifier">format</span><span class="ruby-operator">:</span> <span class="ruby-string">&quot;%B %d, %Y&quot;</span>).<span class="ruby-identifier">count</span>
        <span class="ruby-keyword">else</span>
                <span class="ruby-ivar">@chart</span> = <span class="ruby-constant">Visit</span>.<span class="ruby-identifier">pluck</span>(<span class="ruby-string">&quot;country&quot;</span>).<span class="ruby-identifier">uniq</span>.<span class="ruby-identifier">map</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">c</span><span class="ruby-operator">|</span> { <span class="ruby-identifier">name</span><span class="ruby-operator">:</span> <span class="ruby-identifier">c</span>, <span class="ruby-identifier">data</span><span class="ruby-operator">:</span> <span class="ruby-identifier">visits</span>.<span class="ruby-identifier">where</span>(<span class="ruby-identifier">country</span><span class="ruby-operator">:</span> <span class="ruby-identifier">c</span>).<span class="ruby-identifier">group_by_day</span>(<span class="ruby-value">:visited_at</span>, <span class="ruby-identifier">format</span><span class="ruby-operator">:</span> <span class="ruby-string">&quot;%B %d, %Y&quot;</span>).<span class="ruby-identifier">count</span> } }
        <span class="ruby-keyword">end</span>
        <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
                <span class="ruby-identifier">format</span>.<span class="ruby-identifier">js</span>   {}
                <span class="ruby-identifier">format</span>.<span class="ruby-identifier">json</span> {
                        <span class="ruby-identifier">render</span> <span class="ruby-identifier">json</span><span class="ruby-operator">:</span> <span class="ruby-ivar">@chart</span>
                }
        <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-wind_power" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">wind_power</span><span
            class="method-args">(wp)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="wind_power-source">
            <pre><span class="ruby-comment"># File app/controllers/qinhuangdao_controller.rb, line 454</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">wind_power</span>(<span class="ruby-identifier">wp</span>)
        <span class="ruby-keyword">return</span> <span class="ruby-string">&#39;&#39;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">wp</span>
        <span class="ruby-keyword">return</span> <span class="ruby-identifier">wp</span>[<span class="ruby-value">0</span>,<span class="ruby-value">2</span>] <span class="ruby-keyword">if</span> <span class="ruby-identifier">wp</span>[<span class="ruby-value">0</span>,<span class="ruby-value">2</span>] <span class="ruby-operator">==</span> <span class="ruby-string">&#39;微风&#39;</span>
        <span class="ruby-keyword">for</span> <span class="ruby-identifier">e</span> <span class="ruby-keyword">in</span> (<span class="ruby-value">0</span><span class="ruby-operator">...</span><span class="ruby-identifier">wp</span>.<span class="ruby-identifier">size</span>)
                <span class="ruby-keyword">return</span> <span class="ruby-identifier">wp</span>[<span class="ruby-value">0</span>,<span class="ruby-identifier">e</span><span class="ruby-operator">+</span><span class="ruby-value">1</span>] <span class="ruby-keyword">if</span> <span class="ruby-identifier">wp</span>[<span class="ruby-identifier">e</span>] <span class="ruby-operator">==</span> <span class="ruby-string">&#39;级&#39;</span>
        <span class="ruby-keyword">end</span>          
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
    </section>
  
  </section>
</main>


<footer id="validator-badges" role="contentinfo">
  <p><a href="http://validator.w3.org/check/referer">Validate</a>
  <p>Generated by <a href="http://docs.seattlerb.org/rdoc/">RDoc</a> 4.2.0.
  <p>Based on <a href="http://deveiate.org/projects/Darkfish-RDoc/">Darkfish</a> by <a href="http://deveiate.org">Michael Granger</a>.
</footer>

